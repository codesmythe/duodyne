     1                                  ;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;
     2                                  ; redbug.asm -- Relocatable BIOS Debugger
     3                                  ;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;
     4                                  ;
     5                                  ;   This version is for assembly by  NASM 0.98.39 or later
     6                                  ;
     7                                  ; Copyright (C) 2010 John R. Coffman.  All rights reserved.
     8                                  ; Provided for hobbyist use on the N8VEM SBC-188 board.
     9                                  ;
    10                                  ; This program is free software: you can redistribute it and/or modify
    11                                  ; it under the terms of the GNU General Public License as published by
    12                                  ; the Free Software Foundation, either version 3 of the License, or
    13                                  ; (at your option) any later version.
    14                                  ;
    15                                  ; This program is distributed in the hope that it will be useful,
    16                                  ; but WITHOUT ANY WARRANTY; without even the implied warranty of
    17                                  ; MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
    18                                  ; GNU General Public License for more details.
    19                                  ;
    20                                  ; You should have received a copy of the GNU General Public License
    21                                  ; along with this program.  If not, see <http://www.gnu.org/licenses/>.
    22                                  ;
    23                                  ;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;
    24                                  %include        "config.asm"
    25                              <1> ;/*
    26                              <1> ;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;
    27                              <1> ; ANSI.CFG
    28                              <1> ;   Copied to CONFIG.ASM for general release.
    29                              <1> ;
    30                              <1> ;       Modify the parameters below to reflect your system
    31                              <1> ;
    32                              <1> ;
    33                              <1> ;   This version is for assembly by  NASM 0.98.39 or later
    34                              <1> ;
    35                              <1> ;   Copyright (C) 2010,2011 John R. Coffman.  All rights reserved.
    36                              <1> ;   Provided for hobbyist use on the N8VEM SBC-188 board.
    37                              <1> ;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;
    38                              <1> ;
    39                              <1> ; Define the serial terminal that the Video BIOS must emulate
    40                              <1> ; Set one of the following to 1
    41                              <1> ; If you have no idea what to choose, set TTY to 1
    42                              <1> TTY     equ     0       ; hardcopy -- cannot position the cursor
    43                              <1> DUMB    equ     0       ; dumb CRT -- ^H, ^J, ^K, ^L can move the cursor
    44                              <1> ANSI    equ     1       ; very smart, like a VT-100
    45                              <1> WYSE    equ     0       ; very smart Wyse series (30, 50, ...)
    46                              <1> ; others may get added in the future
    47                              <1> ;  ONE OF THE ABOVE must BE SET TO 1!!!!!
    48                              <1> ;
    49                              <1> ; Does the hardware configuration contain the Color Video Display Unit?
    50                              <1> ; Both the 8563 and the 8242 are used.  The default is CVDU=0
    51                              <1> CVDU	equ	0	; system does not have the CVDU
    52                              <1> ;
    53                              <1> ; Does the hardware configuration contain the VGA3 a/n Video card?
    54                              <1> ; The 8563 will be disabled, but the 8242 code is shared with the CVDU
    55                              <1> ; The default is VGA3=0
    56                              <1> VGA3    equ     0       ; system does not have the VGA3
    57                              <1> %if 0
    58                              <1> 	*/
    59                              <1> #define VGA3 0
    60                              <1> /*
    61                              <1> %endif
    62                              <1> ;
    63                              <1> ; Boot up keyboard mode:  20h for NumLock on
    64                              <1> ;CVDU_KEYBOARD_STATUS	equ	0	; NumLock OFF
    65                              <1> CVDU_KEYBOARD_STATUS	equ	20h	; NumLock ON
    66                              <1> 
    67                              <1> ; Define the UART startup bit rate - 1200-19200 are most common
    68                              <1> ;UART_RATE	equ	0		; 1200
    69                              <1> ;UART_RATE	equ	1		; 2400
    70                              <1> ;UART_RATE	equ	2		; 4800
    71                              <1> UART_RATE	equ	3		; 9600
    72                              <1> ;UART_RATE	equ	4		; 19200
    73                              <1> ;UART_RATE	equ	5		; 38400
    74                              <1> ;UART_RATE	equ	6		; 57600
    75                              <1> ;UART_RATE	equ	7		; 115200
    76                              <1> 
    77                              <1> ; Does the serial terminal use the DSR/DTR protocol for flow control?
    78                              <1> ;UART_DSR_PROTOCOL	equ		1	; Yes!
    79                              <1> UART_DSR_PROTOCOL       equ             WYSE    ; Wyse always uses it
    80                              <1> 						; but not ANSI
    81                              <1> ; Define the size of the ROM image on the system in Kilobytes
    82                              <1> ; It may be smaller than the actual EPROM in use.
    83                              <1> ; The following sizes are supported:  32, 64, 128, and 256
    84                              <1> %ifndef ROM
    85                              <1> ROM             equ     32              ; 64 is the default
    86                              <1> %endif
    87                              <1> 
    88                              <1> ; Define the number of Wait States at which the ROM operates
    89                              <1> ROM_WS          equ     1               ; 0..3  (1 is the default)
    90                              <1> 
    91                              <1> ; Define the size in Kilobytes of DOS RAM (low SRAM plus EMM allocate RAM)
    92                              <1> ; This is a desired size and will only be present if a 4MEM board is added
    93                              <1> RAM_DOS         equ     640
    94                              <1> 
    95                              <1> ; Define the size of the low SRAM on the system in Kilobytes
    96                              <1> ; the default is 512 kilobytes
    97                              <1> RAM             equ     512             ; (512 is the default)
    98                              <1> 
    99                              <1> ; Define the number of Wait States at which the RAM operates
   100                              <1> RAM_WS          equ     0               ; 0..3  (0 is the default)
   101                              <1> 
   102                              <1> ; Define the number of Wait States for Local Peripheral devices (600-7FF)
   103                              <1> LCL_IO_WS       equ     1               ; 0..3  (1 is the default)
   104                              <1> 
   105                              <1> ; Define the number of Wait States for ECB BUS peripheral devices (4xx)
   106                              <1> BUS_IO_WS       equ     3               ; 0..3  (3 is the default)
   107                              <1> 
   108                              <1> ; Define the time zone in which we build the Relocatable BIOS
   109                              <1> %ifndef TIMEZONE
   110                              <1> %define TIMEZONE "CST"
   111                              <1> %endif
   112                              <1> 
   113                              <1> ; Has the REDBUG debugger been loaded?
   114                              <1> %ifndef SOFT_DEBUG
   115                              <1> %define SOFT_DEBUG 0
   116                              <1> %endif
   117                              <1> 
   118                              <1> ; Should the BIOS include "Tiny BASIC" in the image?
   119                              <1> %ifndef TBASIC
   120                              <1> TBASIC          equ     1		; default is 1
   121                              <1> %endif
   122                              <1> 
   123                              <1> ; Should the BIOS include the Floating Point Emulator?  The 80188 does
   124                              <1> ; not allow a floating point co-processor, so this is probably a good idea.
   125                              <1> %ifndef FPEM
   126                              <1> FPEM            equ     1               ; default is 1
   127                              <1> %endif
   128                              <1> 
   129                              <1> ; Define the maximum number of EMM (4MEM) boards supported
   130                              <1> EMM_BOARDS      equ     0
   131                              <1> 
   132                              <1> ; Should the Floating Point Emulator use temporary storage in the EBDA
   133                              <1> ; or at locations 0280h..3FFh in low memory?
   134                              <1> %if SOFT_DEBUG
   135                              <1> FPEM_USE_EBDA   equ     FPEM            ; default is 0
   136                              <1> %else
   137                              <1> FPEM_USE_EBDA   equ     0; FPEM            ; default is 0
   138                              <1> %endif
   139                              <1> 
   140                              <1> ; Define the size of the EPROM that is to be installed on the system
   141                              <1> ; It may be larger than the actual ROM image to be generated.
   142                              <1> %ifndef CHIP
   143                              <1> CHIP            equ     64
   144                              <1> %endif
   145                              <1> 
   146                              <1> ; Does the SBC-188 00.4 board have the LS138/LS08 piggyback fix
   147                              <1> ; Set to 1 for the SBC-188 v1.0 and later production boards
   148                              <1> ;FDC_PIGGYBACK_FIX       equ     0       ; Fix not installed
   149                              <1> FDC_PIGGYBACK_FIX       equ     1       ; fix  IS  installed
   150                              <1> 
   151                              <1> ; On SBC-188 rev 00.4 board, there is a published hardware fix (2010-09-18).
   152                              <1> ; If the wiring update is installed, or you have a later board, then
   153                              <1> ; set this to 0.  If you are using the software workaround, then set this
   154                              <1> ; to 1.  The rev 1.0 board has this fix already.
   155                              <1> NEED_TIMER_FIX  equ     0               ; have revised hardware
   156                              <1> ;NEED_TIMER_FIX  equ     1               ; use workaround
   157                              <1> 
   158                              <1> ; Define the UART oscillator speed
   159                              <1> UART_OSC        equ     1843200         ; 1.8432 Mhz is specified
   160                              <1> 
   161                              <1> 
   162                              <1> ;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;
   163                              <1> ; end of the User configuration
   164                              <1> ;       Do Not modify anything below this point
   165                              <1> ;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;
   166                              <1> 
   167                              <1> CVDU_8563	equ	CVDU		; separate inits
   168                              <1> CVDU_8242	equ	CVDU|VGA3 	; separate inits
   169                              <1> VGA3_6445       equ     VGA3            ; separate inits
   170                              <1> ; Suppress all UART output in color video Mode 3
   171                              <1> UART_MODE3_SUPPRESS	equ	CVDU_8563
   172                              <1> CVDU_USE_MSDOS_KLUDGE	equ	0; CVDU_8242	; bad, bad MSDOS
   173                              <1> CVDU_USE_KBD_HOOK		equ	CVDU_8242
   174                              <1> 
   175                              <1> ; Define existence of any uart chip
   176                              <1> UART		equ	TTY+DUMB+ANSI+WYSE
   177                              <1> startuplength   equ     512                     ; may be up to 1024
   178                              <1> startseg        equ     0FFFFh - (ROM*64) + 1
   179                              <1> highrom         equ     (ROM*400h)&0FFFFh
   180                              <1> startupseg      equ     0FFFFh - (startuplength>>4) + 1
   181                              <1> bios_data_seg   equ     040h            ; segment of BIOS data area
   182                              <1> 
   183                              <1> 
   184                              <1> %define ARG(n) [bp+2+(n)*2]
   185                              <1> 
   186                              <1> %macro  check   1.nolist
   187                              <1>  %if (%1)
   188                              <1>    %error Check Failure: %1
   189                              <1>  %endif
   190                              <1> %endm
   191                              <1> %macro  range   3.nolist
   192                              <1>  %if (%1)<(%2)
   193                              <1>    %error Out of Range: %1
   194                              <1>  %elif (%1)>(%3)
   195                              <1>    %error Out of Range: %1
   196                              <1>  %endif
   197                              <1> %endm
   198                              <1> _terminal equ UART+CVDU
   199                              <1>  check   RAM_DOS&15
   200                              <1>  check   RAM&(RAM-1)
   201                              <1>  check   ROM&(ROM-1)
   202                              <1>  range   RAM,32,512
   203                              <1>  range   ROM,32,256
   204                              <1>  range   RAM_WS,0,3
   205                              <1>  range   ROM_WS,0,3
   206                              <1>  range   RAM_DOS,RAM,(1024-ROM)
   207                              <1>  range   LCL_IO_WS,0,3
   208                              <1>  range   BUS_IO_WS,0,3
   209                              <1>  range   UART_OSC,500000,16000000
   210                              <1>  range   UART_RATE,0,7
   211                              <1>  range	 UART,0,1
   212                              <1>  range	 _terminal,1,2
   213                              <1> 
   214                              <1> %ifndef SOFT_DEBUG
   215                              <1> %define SOFT_DEBUG 0
   216                              <1> %endif
   217                              <1> 
   218                              <1> %ifndef TRACE
   219                              <1> %define TRACE 0
   220                              <1> %endif
   221                              <1> 
   222                              <1> %ifdef MAKE_OBJECT_FILE
   223                              <1>         segment _DATA WORD PUBLIC CLASS=DATA
   224                              <1>         export _ROMsize
   225                              <1>         export _CHIPsize
   226                              <1> _ROMsize        dw      ROM
   227                              <1> _CHIPsize       dw      CHIP
   228                              <1> %endif
   229                              <1> ; end of the Hardware configuration file
   230                              <1> ;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;
   231                              <1> ;*/
    25                                  %include        "cpuregs.asm"
    26                              <1> ;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;
    27                              <1> ; CPUREGS.ASM
    28                              <1> ;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;
    29                              <1> ;
    30                              <1> ;   This version is for assembly by  NASM 0.98.39 or later
    31                              <1> ;
    32                              <1> ; Copyright (C) 2010,2011 John R. Coffman.  All rights reserved.
    33                              <1> ; Provided for hobbyist use on the N8VEM SBC-188 board.
    34                              <1> ;
    35                              <1> ; This program is free software: you can redistribute it and/or modify
    36                              <1> ; it under the terms of the GNU General Public License as published by
    37                              <1> ; the Free Software Foundation, either version 3 of the License, or
    38                              <1> ; (at your option) any later version.
    39                              <1> ;
    40                              <1> ; This program is distributed in the hope that it will be useful,
    41                              <1> ; but WITHOUT ANY WARRANTY; without even the implied warranty of
    42                              <1> ; MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
    43                              <1> ; GNU General Public License for more details.
    44                              <1> ;
    45                              <1> ; You should have received a copy of the GNU General Public License
    46                              <1> ; along with this program.  If not, see <http://www.gnu.org/licenses/>.
    47                              <1> ;
    48                              <1> ; Updated for the Duodyne 80c188 SBC
    49                              <1> ;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;
    50                              <1> %include	"macros.inc"
    51                              <2> ;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;
    52                              <2> ; MACROS.INC  
    53                              <2> ;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;
    54                              <2> ;
    55                              <2> ;   This version is for assembly by  NASM 0.98.39 or later
    56                              <2> ;
    57                              <2> ; Copyright (C) 2010,2011 John R. Coffman.  All rights reserved.
    58                              <2> ; Provided for hobbyist use on the N8VEM SBC-188 board.
    59                              <2> ;
    60                              <2> ; This program is free software: you can redistribute it and/or modify
    61                              <2> ; it under the terms of the GNU General Public License as published by
    62                              <2> ; the Free Software Foundation, either version 3 of the License, or
    63                              <2> ; (at your option) any later version.
    64                              <2> ;
    65                              <2> ; This program is distributed in the hope that it will be useful,
    66                              <2> ; but WITHOUT ANY WARRANTY; without even the implied warranty of
    67                              <2> ; MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
    68                              <2> ; GNU General Public License for more details.
    69                              <2> ;
    70                              <2> ; You should have received a copy of the GNU General Public License
    71                              <2> ; along with this program.  If not, see <http://www.gnu.org/licenses/>.
    72                              <2> ;
    73                              <2> ;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;
    74                              <2> 
    75                              <2> ; general macros for the SBC188 BIOS ASSEMBLY
    76                              <2> ;
    77                              <2> ;
    78                              <2> %ifndef __MACROS_DEFINED_
    79                              <2> %define __MACROS_DEFINED_ 1
    80                              <2> ;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;
    81                              <2> ;
    82                              <2> ; some useful macros:
    83                              <2> ;
    84                              <2> ;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;
    85                              <2> ;
    86                              <2> 	cpu	186
    87                              <2> 
    88                              <2> %imacro setloc  1.nolist
    89                              <2>  times   (%1-($-$$)) db 0FFh
    90                              <2> %endm
    91                              <2> 
    92                              <2> %imacro db_lo   1
    93                              <2>  db (%1)&255
    94                              <2> %endm
    95                              <2> 
    96                              <2> %imacro cnop    0.nolist
    97                              <2> %if SOFT_DEBUG
    98                              <2>         nop
    99                              <2> %endif
   100                              <2> %endm
   101                              <2> 
   102                              <2> %imacro popm 1-*.nolist
   103                              <2> %rep %0
   104                              <2> %ifidni %1,ALL
   105                              <2>  popa
   106                              <2> %elifidni %1,F
   107                              <2>  popf
   108                              <2> %else
   109                              <2>  pop %1
   110                              <2> %ifidni %1,DS
   111                              <2>  cnop
   112                              <2> %elifidni %1,ES
   113                              <2>  cnop
   114                              <2> %endif
   115                              <2> %endif
   116                              <2> %rotate 1
   117                              <2> %endrep
   118                              <2> %endm
   119                              <2> 
   120                              <2> %imacro pushm 1-*.nolist
   121                              <2> %rep %0
   122                              <2> %rotate -1
   123                              <2> %ifidni %1,ALL
   124                              <2>  pusha
   125                              <2> %elifidni %1,F
   126                              <2>  pushf
   127                              <2> %else
   128                              <2>  push %1
   129                              <2> %endif
   130                              <2> %endrep
   131                              <2> %endm
   132                              <2> 
   133                              <2> ;
   134                              <2> ; added from the 386EX project
   135                              <2> ;
   136                              <2> 
   137                              <2> ; call arguments
   138                              <2> %define ARG(n) [bp+2+(n)*2]
   139                              <2> 
   140                              <2> ;
   141                              <2> ; format of the BYTE initialization table:  address, byte
   142                              <2> ;
   143                              <2> %imacro  binit 2
   144                              <2>         dw      %1
   145                              <2>         db      %2
   146                              <2> %endmacro
   147                              <2> ; end with DW -1
   148                              <2> 
   149                              <2> ;
   150                              <2> ; format of the WORD initialization table:  address, word
   151                              <2> ;
   152                              <2> %imacro  winit 2
   153                              <2>         dw      %1
   154                              <2>         dw      %2
   155                              <2> %endmacro
   156                              <2> ; end with DW -1
   157                              <2> 
   158                              <2> 
   159                              <2> ; get the BIOS Data Area segment pointer to a [segment] register
   160                              <2> %imacro get_bda	1.nolist
   161                              <2> 	push	0x0040
   162                              <2> 	pop	%1
   163                              <2> 	cnop
   164                              <2> %endm
   165                              <2> 
   166                              <2> 
   167                              <2> %endif
    51                              <1> 
    52                              <1> 	cpu     186
    53                              <1> ;
    54                              <1> ;
    55                              <1> ; IBM model byte -- must be less than a 286
    56                              <1> ;
    57                              <1> ;MODEL_BYTE		equ	0FEh	; PC-XT
    58                              <1> ;SUBMODEL_BYTE		equ	0FFh	; not used
    59                              <1> 
    60                              <1> MODEL_BYTE		equ	0FEh	; PC-XT
    61                              <1> SUBMODEL_BYTE		equ	00h	;  "
    62                              <1> 
    63                              <1> 
    64                              <1> ; 80188 peripheral control register block address
    65                              <1> CPU_CSCR	        equ	0FF00h
    66                              <1> 
    67                              <1> ; Compatible Mode registers
    68                              <1> 
    69                              <1> cpu_relocation          equ     CPU_CSCR+0FEh
    70                              <1> 
    71                              <1> ; The memory and peripheral chip select register offsets from 0FF00h
    72                              <1> 
    73                              <1> cpu_umcs                equ     CPU_CSCR+0A0h          ; Upper memory select
    74                              <1> cpu_lmcs                equ     CPU_CSCR+0A2h          ; Lower memory select
    75                              <1> cpu_pacs                equ     CPU_CSCR+0A4h          ; Peripheral select
    76                              <1> cpu_mmcs                equ     CPU_CSCR+0A6h          ; Middle memory base
    77                              <1> cpu_mpcs                equ     CPU_CSCR+0A8h          ; Mid mem. & peripherals
    78                              <1> 
    79                              <1> ; Enhanced Mode registers
    80                              <1> 
    81                              <1> cpu_mdram               equ     CPU_CSCR+0E0h          ; memory partition reg.
    82                              <1> cpu_cdram               equ     CPU_CSCR+0E2h          ; clock prescaler
    83                              <1> cpu_edram               equ     CPU_CSCR+0E4h          ; Enable refresh reg.
    84                              <1> cpu_pdcon               equ     CPU_CSCR+0F0h          ; Power-Save control
    85                              <1> 
    86                              <1> 
    87                              <1> ; On-board internal peripheral equates
    88                              <1> ; Programmable Interrupt Controller
    89                              <1> PIC	        equ	CPU_CSCR+020H
    90                              <1> PIC_EOI	        equ	PIC+2           ; End Of Interrupt
    91                              <1> PIC_POLLR	equ	PIC+4
    92                              <1> PIC_POLLSR	equ	PIC+6
    93                              <1> PIC_IMASK	equ	PIC+8
    94                              <1> PIC_PMREG	equ	PIC+0AH
    95                              <1> PIC_SRVR	equ	PIC+0CH
    96                              <1> PIC_IRQR	equ	PIC+0EH
    97                              <1> PIC_IRQSR	equ	PIC+10H
    98                              <1> PIC_TCR	        equ	PIC+12H
    99                              <1> PIC_DMA0CR	equ	PIC+14H
   100                              <1> PIC_DMA1CR	equ	PIC+16H
   101                              <1> PIC_I0CON	equ	PIC+18H
   102                              <1> PIC_I1CON	equ	PIC+1AH
   103                              <1> PIC_I2CON	equ	PIC+1CH
   104                              <1> PIC_I3CON	equ	PIC+1EH
   105                              <1> 
   106                              <1> EOI_NSPEC       equ     8000h           ; Non-Specific EOI
   107                              <1> 
   108                              <1> ; Interrupt masks (Master Mode)
   109                              <1> ;
   110                              <1> mask_timer_all          equ     0001h
   111                              <1> mask_dma0               equ     0004h
   112                              <1> mask_dma1               equ     0008h
   113                              <1> mask_int0               equ     0010h
   114                              <1> mask_int1               equ     0020h
   115                              <1> mask_int2               equ     0040h
   116                              <1> mask_int3               equ     0080h
   117                              <1> 
   118                              <1> 
   119                              <1> 
   120                              <1> ; Timers
   121                              <1> TIM0	        equ	CPU_CSCR+050H
   122                              <1> TIM1	        equ	CPU_CSCR+058H
   123                              <1> TIM2	        equ	CPU_CSCR+060H
   124                              <1> 
   125                              <1> TCNT	        equ	0	; count register
   126                              <1> CMPA	        equ	2	; max count A
   127                              <1> CMPB	        equ	4	; max count B (not present on TIM2)
   128                              <1> TCON	        equ	6	; mode/control word
   129                              <1> 
   130                              <1> ; Timer control bits:
   131                              <1> tc_EN           equ     8000h   ; Enable bit
   132                              <1> tc_nINH         equ     4000h   ; not Inhibit Enable
   133                              <1> tc_INT          equ     2000h   ; Interrupt Enable
   134                              <1> tc_RIU          equ     1000h   ; Register A/B (0/1) in Use
   135                              <1> tc_MC           equ     0020h   ; Maximum Count reached
   136                              <1> tc_RTG          equ     0010h   ; Retrigger (internal source)
   137                              <1> tc_P            equ     0008h   ; Prescale internal clock (timers 0 & 1 only)
   138                              <1> tc_EXT          equ     0004h   ; External clock
   139                              <1> tc_ALT          equ     0002h   ; Alternate between A & B max count registers
   140                              <1> tc_CONT         equ     0001h   ; Continuous: continue after max count
   141                              <1> 
   142                              <1> 
   143                              <1> 
   144                              <1> 
   145                              <1> ; DMA
   146                              <1> DMA0	        equ	CPU_CSCR+0C0H
   147                              <1> DMA1	        equ	CPU_CSCR+0D0H
   148                              <1> DMASPL	        equ	0	; source pointer low
   149                              <1> DMASPU	        equ	2	; source pointer high
   150                              <1> DMADPL	        equ	4	; destination pointer low
   151                              <1> DMADPU	        equ	6	; destination pointer high
   152                              <1> DMATC	        equ	8	; terminal count
   153                              <1> DMACW	        equ	0AH	; control word
   154                              <1> 
   155                              <1> 
   156                              <1> 
   157                              <1> 
   158                              <1> 
   159                              <1> ;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;
   160                              <1> ;
   161                              <1> ;       SBC-188 external devices
   162                              <1> ;
   163                              <1> ;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;
   164                              <1> 
   165                              <1> IO_BASE			equ	0400h
   166                              <1> 
   167                              <1> 
   168                              <1> 
   169                              <1> ;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;
   170                              <1> ; The UART registers (Duodyne SBC 80c188 Console port)
   171                              <1> ;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;
   172                              <1> 
   173                              <1> uart_base               equ     IO_BASE+0280h
   174                              <1> uart_rbr                equ     uart_base       ;Rcvr Buffer / read only
   175                              <1> uart_thr                equ     uart_base       ;Transmit Holding / write only
   176                              <1> uart_ier                equ     uart_base+1     ;Interrupt Enable
   177                              <1> uart_iir                equ     uart_base+2     ;Interrupt Ident / read only
   178                              <1> uart_fcr                equ     uart_base+2     ;FIFO Control / write only
   179                              <1> uart_lcr                equ     uart_base+3     ;Line Control
   180                              <1> uart_mcr                equ     uart_base+4     ;Modem Control
   181                              <1> uart_lsr                equ     uart_base+5     ;Line Status
   182                              <1> uart_msr                equ     uart_base+6     ;Modem Status
   183                              <1> uart_sr			equ	uart_base+7	;Scratch
   184                              <1> 
   185                              <1> uart_dll                equ     uart_base       ;Divisor Latch LS Byte
   186                              <1> uart_dlm                equ     uart_base+1     ;Divisor Latch MS Byte
   187                              <1> 
   188                              <1> ;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;
   189                              <1> ; CONTROL LS259 PORT  (DuoDyne 80C188)
   190                              <1> ;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;
   191                              <1> CTRL259		equ	IO_BASE+0238H
   192                              <1> ; LEDS are at addresses 0..3
   193                              <1> ; other control ports on 4..7
   194                              <1> LED0		equ	CTRL259+0
   195                              <1> LED1		equ	LED0+1
   196                              <1> LED2		equ	LED0+2
   197                              <1> LED3		equ	LED0+3
   198                              <1> T1OSC18		equ	CTRL259+4	; ON=1.8432mhz, OFF="1" (for use of TIMER2)
   199                              <1> ;unused		equ	CTRL259+5
   200                              <1> ;unused		equ	CTRL259+6
   201                              <1> ;unused		equ	CTRL259+7
   202                              <1> 
   203                              <1> ;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;
   204                              <1> ; Front Panel Connector  (DuoDyne 80C188)
   205                              <1> ;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;
   206                              <1> FRONT_PANEL_LED	equ	IO_BASE+0230H
   207                              <1> 
   208                              <1> 
   209                              <1> 
   210                              <1> ;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;
   211                              <1> ; Floppy controller (Duodyne Disk IO)
   212                              <1> ;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;
   213                              <1> FDC	        equ	IO_BASE+0200H
   214                              <1> FDC_MSR         equ     FDC
   215                              <1> FDC_DATA        equ     FDC_MSR+1
   216                              <1> FDC_DACK        equ	FDC+10H
   217                              <1> FDC_LDOR	equ	FDC+20H
   218                              <1> FDC_LDCR	equ	FDC+30H
   219                              <1> FDC_TC	        equ	FDC+40H
   220                              <1> FDC_RES	        equ	FDC+40H
   221                              <1> FDC_DACK_TC     equ     FDC_DACK | FDC_TC
   222                              <1> 
   223                              <1> 
   224                              <1> ;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;
   225                              <1> ;DS1302 RTC (Duodyne Ram/ROM Card)
   226                              <1> ;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;
   227                              <1> RTC	equ	IO_BASE+0094H
   228                              <1> 
   229                              <1> ;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;
   230                              <1> ; PIO 82C55 I/O  (Duodyne Disk IO)
   231                              <1> ;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;
   232                              <1> PPI	        equ	IO_BASE+0088H
   233                              <1> 
   234                              <1> PIO_A	        equ	PPI+0	; (OUTPUT)
   235                              <1> PIO_B	        equ	PPI+1	; (INPUT)
   236                              <1> PIO_C	        equ	PPI+2	; (CENTRONICS control low nibble)
   237                              <1> PIO_CTRL	equ	PPI+3	; CONTROL BYTE PIO 82C55
   238                              <1> 
   239                              <1> portA           equ     PPI+0   ;
   240                              <1> portB           equ     PPI+1   ;
   241                              <1> portC           equ     PPI+2   ;
   242                              <1> 
   243                              <1> ; end CPUREGS.ASM
    26                                  %include        "equates.asm"
    27                              <1> ;========================================================================
    28                              <1> ; EQUATES.ASM -- Lots of Defintions for Relocatable BIOS
    29                              <1> ;========================================================================
    30                              <1> ;   for the N8VEM SBC-188 v.00.4 and 00.5
    31                              <1> ;
    32                              <1> ;   This version is for assembly by  NASM 0.98.39 or later
    33                              <1> ;
    34                              <1> ; Copyright (C) 2010 John R. Coffman.  All rights reserved.
    35                              <1> ; Provided for hobbyist use on the N8VEM SBC-188 board.
    36                              <1> ;
    37                              <1> ; This program is free software: you can redistribute it and/or modify
    38                              <1> ; it under the terms of the GNU General Public License as published by
    39                              <1> ; the Free Software Foundation, either version 3 of the License, or
    40                              <1> ; (at your option) any later version.
    41                              <1> ;
    42                              <1> ; This program is distributed in the hope that it will be useful,
    43                              <1> ; but WITHOUT ANY WARRANTY; without even the implied warranty of
    44                              <1> ; MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
    45                              <1> ; GNU General Public License for more details.
    46                              <1> ;
    47                              <1> ; You should have received a copy of the GNU General Public License
    48                              <1> ; along with this program.  If not, see <http://www.gnu.org/licenses/>.
    49                              <1> ;
    50                              <1> ;========================================================================
    51                              <1> 
    52                              <1>         global  FPEM_segment
    53                              <1> 
    54                              <1> 
    55                              <1> %include "segdef.asm"
    56                              <2> ;========================================================================
    57                              <2> ; SEGDEF.ASM -- Lots of Defintions for Relocatable BIOS
    58                              <2> ;========================================================================
    59                              <2> ;   for the N8VEM SBC-188 v.00.4 and 00.5
    60                              <2> ;
    61                              <2> ;   This version is for assembly by  NASM 0.98.39 or later
    62                              <2> ;
    63                              <2> ; Copyright (C) 2010 John R. Coffman.  All rights reserved.
    64                              <2> ; Provided for hobbyist use on the N8VEM SBC-188 board.
    65                              <2> ;
    66                              <2> ; This program is free software: you can redistribute it and/or modify
    67                              <2> ; it under the terms of the GNU General Public License as published by
    68                              <2> ; the Free Software Foundation, either version 3 of the License, or
    69                              <2> ; (at your option) any later version.
    70                              <2> ;
    71                              <2> ; This program is distributed in the hope that it will be useful,
    72                              <2> ; but WITHOUT ANY WARRANTY; without even the implied warranty of
    73                              <2> ; MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
    74                              <2> ; GNU General Public License for more details.
    75                              <2> ;
    76                              <2> ; You should have received a copy of the GNU General Public License
    77                              <2> ; along with this program.  If not, see <http://www.gnu.org/licenses/>.
    78                              <2> ;
    79                              <2> ;========================================================================
    80                              <2> 
    81                              <2> %ifndef __SEGDEF_
    82                              <2> %define __SEGDEF_
    83                              <2> 
    84                              <2> 	SEGMENT  _TEXT ALIGN=2 PUBLIC CLASS=CODE
    85                              <2>         SEGMENT  CONST ALIGN=2 PUBLIC CLASS=DATA
    86                              <2>         SEGMENT  CONST2 ALIGN=2 PUBLIC CLASS=DATA
    87                              <2> 	SEGMENT  _DATA ALIGN=16 PUBLIC CLASS=DATA
    88                              <2> 	SEGMENT  _BSS  ALIGN=2 PUBLIC CLASS=BSS
    89                              <2> ;;;        SEGMENT  _BASIC ALIGN=16 PUBLIC CLASS=BASIC
    90                              <2> 
    91                              <2> 	GROUP	DGROUP CONST CONST2 _DATA _BSS
    92                              <2> 
    93                              <2> %endif
    94                              <2> 
    56                              <1> %include "ascii.asm"
    57                              <2> ; ascii.asm
    58                              <2> ;
    59                              <2> CTRL            equ     1Fh     ; masks a character to CTRL-x
    60                              <2> 
    61                              <2> NUL     equ     00h
    62                              <2> BEL     equ     (CTRL & 'G')
    63                              <2> BS      equ     08h		; ^H
    64                              <2> HT      equ     09h		; ^I
    65                              <2> LF	equ	0Ah		; ^J
    66                              <2> NL      equ     LF
    67                              <2> VT	equ	0Bh		; ^K
    68                              <2> FWD	equ	0Ch		; ^L
    69                              <2> CR	equ	0Dh
    70                              <2> XON     equ     (CTRL & 'Q')
    71                              <2> XOFF    equ     (CTRL & 'S')
    72                              <2> DC1     equ     XON
    73                              <2> DC3     equ     XOFF
    74                              <2> ESC     equ	1Bh
    75                              <2> 
    76                              <2> 
    57                              <1> 
    58                              <1> 
    59                              <1> ; POST error codes. Presently one byte but can expand to word.
    60                              <1> ER_BIOS equ	01h		; Bad ROM bios checksum, patch last byte
    61                              <1> ER_RAM	equ	02h		; Bad RAM in main memory, replace
    62                              <1> ER_CRT	equ	04h		; Bad RAM in video card, replace
    63                              <1> ER_FDC	equ	08h		; Bad FDC
    64                              <1> ER_UNK1	equ	10h		; {unassigned}
    65                              <1> ER_MEM	equ	20h		; Bad RAM in vector area, replace
    66                              <1> ER_ROM	equ	40h		; Bad ROM in expansion area, bad checksum
    67                              <1> ER_UNK2	equ	80h		; {unassigned}
    68                              <1> 
    69                              <1> 
    70                              <1> 
    71                              <1> ;; ************************ BIOS Data Segment ******************************
    72                              <1> ;; BIOS data segment - not all will  be used
    73                              <1> ;                struc   BIOS_DATA_AREA  ; at 0040:0000
    74                              <1> %include "bda.inc"
    75                              <2> ;/*======================================================================
    76                              <2> ; bda.inc -- BIOS data area definitions
    77                              <2> ;========================================================================
    78                              <2> ;   for the N8VEM SBC-188
    79                              <2> ;
    80                              <2> ;   This version is for assembly by  NASM 0.98.39 or later
    81                              <2> ;
    82                              <2> ; Copyright (C) 2013 John R. Coffman.  All rights reserved.
    83                              <2> ; Provided for hobbyist use on the N8VEM SBC-188 board.
    84                              <2> ;
    85                              <2> ; This program is free software: you can redistribute it and/or modify
    86                              <2> ; it under the terms of the GNU General Public License as published by
    87                              <2> ; the Free Software Foundation, either version 3 of the License, or
    88                              <2> ; (at your option) any later version.
    89                              <2> ;
    90                              <2> ; This program is distributed in the hope that it will be useful,
    91                              <2> ; but WITHOUT ANY WARRANTY; without even the implied warranty of
    92                              <2> ; MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
    93                              <2> ; GNU General Public License for more details.
    94                              <2> ;
    95                              <2> ; You should have received a copy of the GNU General Public License
    96                              <2> ; along with this program.  If not, see <http://www.gnu.org/licenses/>.
    97                              <2> ;
    98                              <2> ;========================================================================
    99                              <2> 
   100                              <2> 			;*/ extern				/*
   101                              <2> 	ABSOLUTE  0	;*/ struct BDA {			/*
   102 00000000 ????????????????    <2> serial_ports    resw    4	;*/	word	serial_ports[4];	/*
   103 00000008 ????????????????    <2> parallel_ports  resw    4	;*/	word	parallel_ports[4];	/*
   104 00000010 ????                <2> equipment_flag  resw    1	;*/	EQFL	equipment_flag;		/*
   105                              <2> ;	dw	?		; 40:10 	; Equipment present word
   106                              <2> ;  						;  = (1 iff floppies) *     1.
   107                              <2> ;                                               ;  + (1 iff 187     ) *     2.
   108                              <2> ;  						;  + (#+1 64K sys ram) *    4.
   109                              <2> ;  						;  + (init crt mode ) *    16.
   110                              <2> ;  						;  + (# of floppies ) *    64.
   111                              <2> ;  						;  + (# serial ports) *   512.
   112                              <2> ;  						;  + (1 iff toy port) *  4096.
   113                              <2> ;                                               ;  + (1 iff modem   ) *  8192.
   114                              <2> ;  						;  + (# parallel LPT) * 16384.
   115 00000012 ??                  <2> mfg_test_flags  resb    1	;*/	byte	mfg_test_flags;	/* 40:12 unused by us
   116 00000013 ????                <2> memory_size     resw    1	;*/	word	memory_size;	/* 40:13 kilobytes
   117                              <2> uart_kbd_ctrl_R	equ	$	;*/				/*** JRC: count of ctrl-R's for reboot
   118 00000015 ??                  <2> IPL_errors      resb    1	;*/	byte	IPL_errors;	/* 40:15 IPL errors<-table/scratchpad
   119 00000016 ??                  <2> sbc188_rev       resb    1	;*/	byte	sbc188_rev;	/* was 'unused_01' before BIOS047
   120                              <2> ;;---------------[Keyboard data area]------------;
   121 00000017 ????                <2> keyboard_flags_0 resw   1	;*/	word	keyboard_flags_0;  /* 40:17 Shift/Alt/etc. keyboard flags
   122                              <2> keyboard_flags_1 equ	$-1	;     2nd byte	keyboard_flags_1;  
   123 00000019 ??                  <2> keypad_char	resb	1	;*/	byte	keypad_char;	/* 40:19 Alt-KEYPAD char. goes here
   124 0000001A ????                <2> kbd_buffer_head resw    1	;*/	word	kbd_buffer_head;   /* 40:1A --> keyboard buffer head
   125 0000001C ????                <2> kbd_buffer_tail resw    1	;*/	word	kbd_buffer_tail;   /* 40:1C --> keyboard buffer tail
   126 0000001E <res 20h>           <2> kbd_buffer      resw    16	;*/	word	kbd_buffer[16];	/* 40:1E Keyboard Buffer (Scan,Value)
   127                              <2> kbd_buffer_last	equ	$	;*/				/*
   128                              <2> ;;---------------[Diskette data area]------------;
   129 0000003E ??                  <2> fdc_drv_calib   resb    1	;*/	byte	fdc_drive_calib;   /* 40:3E
   130 0000003F ??                  <2> fdc_motor_LDOR  resb    1	;*/	byte	fdc_motor_LDOR;	   /* 40:3F Motor, DMA, select control
   131 00000040 ??                  <2> fdc_motor_ticks resb    1	;*/	byte	fdc_motor_ticks;   /* 40:40 ticks til motor off
   132 00000041 ??                  <2> fdc_status      resb    1	;*/	byte	fdc_status;	   /* 40:41
   133                              <2> ;				Floppy return code stat byte
   134                              <2> ;				;  1 = bad ic 765 command req.
   135                              <2> ;				;  2 = address mark not found
   136                              <2> ;				;  3 = write to protected disk
   137                              <2> ;				;  4 = sector not found
   138                              <2> ;				;  8 = data late (DMA overrun)
   139                              <2> ;				;  9 = DMA failed 64K page end
   140                              <2> ;				; 16 = bad CRC on floppy read
   141                              <2> ;				; 32 = bad NEC 765 controller
   142                              <2> ;				; 64 = seek operation failed
   143                              <2> ;				;128 = disk drive timed out
   144 00000042 ??????????????      <2> fdc_ctrl_status resb    7	;*/	byte	fdc_ctrl_status[7];  /* 40:42 Status bytes from NEC 765
   145                              <2> ;;---------------[Video display area]------------;
   146 00000049 ??                  <2> video_mode      resb    1	;*/	byte	video_mode;	/* 40:49
   147                              <2> ;			 	; Current CRT mode  (software)
   148                              <2> ;				;  0 = 40 x 25 text (no color)
   149                              <2> ;				;  1 = 40 x 25 text (16 color)
   150                              <2> ;				;  2 = 80 x 25 text (no color)
   151                              <2> ;				;  3 = 80 x 25 text (16 color)
   152                              <2> ;				;  4 = 320 x 200 grafix 4 color
   153                              <2> ;				;  5 = 320 x 200 grafix 0 color
   154                              <2> ;				;  6 = 640 x 200 grafix 0 color
   155                              <2> ;				;  7 = 80 x 25 text (mono card)
   156 0000004A ????                <2> video_columns   resw    1	;*/	word video_columns;	/* 40:4A Columns on CRT screen
   157 0000004C ????                <2> video_regen_bytes  resw 1	;*/	word video_regen_bytes;	/* 40:4C Bytes in the regen region
   158 0000004E ????                <2> video_regen_offset resw 1	;*/	word video_regen_offset;/* 40:4E Byte offset in regen region
   159 00000050 <res 10h>           <2> video_cursor_pos  resw  8	;*/	word video_cursor_pos[8];  /* 40:50 Cursor pos for up to 8 pages
   160 00000060 ????                <2> video_cursor_mode resw  1	;*/	word video_cursor_mode;	/* 40:60 Current cursor mode setting
   161 00000062 ??                  <2> video_page      resb    1	;*/	byte video_page;	/* 40:62 Current page on display
   162 00000063 ????                <2> video_base_seg  resw    1	;*/	word video_base_seg;	/* 40:63 Base address (B000h or B800h)
   163 00000065 ??                  <2> video_hw_mode   resb    1	;*/	byte video_hw_mode;	/* 40:65 ic 6845 mode reg. (hardware)
   164 00000066 ??                  <2> video_cga_palette resb  1	;*/	byte video_cga_palette;	/* 40:66 Current CGA palette
   165                              <2> ;;---------------[Used to setup ROM]-------------;
   166 00000067 ????????            <2> eprom_address   resd    1	;*/	dword eprom_address;	/* 40:67 Eprom base Offset,Segment
   167 0000006B ??                  <2> spurious_irq    resb    1	;*/	byte spurious_irq;	/* 40:6B Last spurious interrupt IRQ
   168                              <2> ;;---------------[Timer data area]---------------;
   169 0000006C ????????            <2> timer_ticks     resd    1	;*/	dword timer_ticks;	/* 40:6C Ticks since midnight (lo,hi)
   170 00000070 ??                  <2> timer_new_day   resb    1	;*/	byte timer_new_day;	/* 40:70 Non-zero if new day
   171                              <2> ;;---------------[System data area]--------------;
   172 00000071 ??                  <2> break_flag      resb    1	;*/	byte break_flag;	/* 40:71 Sign bit set iff break
   173 00000072 ????                <2> warm_boot       resw    1	;*/	word warm_boot;		/* 40:72 Warm boot iff==1234h
   174                              <2> ;;---------------[Hard disk scratchpad]----------;
   175 00000074 ????????            <2> hdd_scratch     resd    1	;*/	word hdd_scratch[2];	/* 40:74
   176                              <2> ;;---------------[Timout areas/PRT/LPT]----------;
   177 00000078 ????????            <2> lpt_timeout     resb    4	;*/	byte lpt_timeout[4];	/* 40:78 Ticks for LPT 1-4 timeouts
   178 0000007C ????????            <2> com_timeout     resb    4	;*/	byte com_timeout[4];	/* 40:7C Ticks for COM 1-4 timeouts
   179                              <2> ;;---obsolete----[Keyboard buf start/end]---jrc--;
   180 00000080 ????                <2> kbd_buffer_start resw   1	;*/	word kbd_buffer_start;	/* 40:80 KBD buffer head (PC/AT)
   181 00000082 ????                <2> kbd_buffer_end  resw    1	;*/	word kbd_buffer_end;	/* 40:82 KBD buffer tail (PC/AT)
   182                              <2> ;;---------------[EGA stuff]---------------------;
   183 00000084 ??????????????      <2> EGA_stuff	resb	7	;*/	byte EGA_stuff[7];	/* 40:84 Unspecified EGA data
   184                              <2> ;;---------------[Floppy/Fixed Media Info]-------------;
   185 0000008B ??                  <2> fdc_last_rate	resb	1	;*/	byte fdc_last_rate;	/* 40:8B Last floppy step rate/data rate?
   186 0000008C ????????            <2> fx_misc_unused	resb	4	;*/	byte fx_misc_unused[4];	/* 40:8C Fixed disk miscellaneous ???
   187 00000090 ????                <2> fdc_disk_state	resb	2	;*/	byte fdc_disk_state[2];	/* 40:90 Floppy disk state
   188 00000092 ????                <2> fdc_op_start	resb	2	;*/	byte fdc_op_start[2];	/* 40:92 Floppy operation start state machine
   189 00000094 ????                <2> fdc_cylinder	resb	2	;*/	byte fdc_cylinder[2];	/* 40:94 Floppy present cylinder
   190                              <2> ;;---------------[Additional KBD flags]----------------;
   191 00000096 ??                  <2> kbd_flag_3	resb	1	;*/	byte kbd_flag_3;	/* 40:96 kbd ???
   192 00000097 ??                  <2> kbd_flag_2	resb	1	;*/	byte kbd_flag_2;	/* 40:97 kbd ???
   193                              <2> ;;---------------[RTC/timer1 data]---------------------;
   194 00000098 ????????            <2> user_semaphore	resw	2	;*/	byte *user_semaphore;	/* 40:98 User semaphore in (bit 7)
   195 0000009C ????????            <2> rtc_count	resd	1	;*/	dword rtc_count;	/* 40:9C RTC tick counter
   196 000000A0 ??                  <2> rtc_wait_active	resb	1	;*/	byte rtc_wait_active;	/* 40:A0 Busy=01, Posted=80h, 
   197                              <2> ;;---------------[Cassette I/O stuff]------------------;
   198 000000A1 ??                  <2> last_val	resb	1	;*/	byte last_val;		/* 40:A1 Last byte read value
   199 000000A2 ????                <2> crc_reg		resw	1	;*/	word crc_reg;		/* 40:A2 CRC accumulation area
   200                              <2> ;									Post Acknowleged=00;
   201 000000A4 ??                  <2> EGA_data	resb	1	;*/	byte EGA_data;		/* 40:A4 Various usage
   202 000000A5 ????                <2> SDstatus	resb	2	;*/	byte SDstatus[2];	/* 40:A5 Status byte from command
   203 000000A7 ????                <2> SDcardtype	resb	2	;*/	byte SDcardtype[2];	/* 40:A7 SDcard type SDSC=2, HC=3, ...
   204                              <2> ;
   205 000000A9 ????????            <2> fixed_disk_tab	resb	4	;*/	byte fixed_disk_tab[4];	/* dispatch table to fixed disk drivers
   206 000000AD ??                  <2> wait12_count	resb	1	;*/	byte wait12_count;	/* 40:AD 12usec CX count
   207 000000AE ??                  <2> lock_count	resb	1	;*/	byte lock_count;	/* 40:AE lock level counter
   208 000000AF ??                  <2> EMS_start       resb    1	;*/	byte EMS_start;		/* start EMS allocation from here
   209                              <2> fx80		equ	$	;*/	struct EDD_disk fx80;	/* fixed disk parameter area 0
   210 000000B0 ????                <2> fx_log_cylinders resw   1	;	word fx_log_cylinders;	 logical number of cylinders
   211 000000B2 ??                  <2> fx_log_heads    resb    1	;	byte fx_log_heads;	 logical number of heads
   212 000000B3 ??                  <2> fx_signature	resb	1	;	byte fx_signature;	 A0h signature = translated geom
   213 000000B4 ??                  <2> fx_phys_sectors	resb    1       ;	byte fx_phys_sectors;	 physical number of sectors per track
   214 000000B5 ????                <2> fx_LBA_high     resw    1       ;	word fx_LBA_high;	 high word of LBA28 number of sectors
   215 000000B7 ??                  <2> fx_reserved	resb	1	;	byte fx_reserved;	 reserved for future use
   216 000000B8 ??                  <2> fx_drive_control resb   1       ;	byte fx_drive_control;	 flag bits for IDE head register
   217 000000B9 ????                <2> fx_phys_cylinders resw	1	;	word fx_phys_cylinders;	 physical number of cylinders
   218 000000BB ??                  <2> fx_phys_heads	resb	1	;	byte fx_phys_heads;	 physical number of heads
   219 000000BC ????                <2> fx_LBA_low	resw	1	;	word fx_LBA_low;	 low word of LBA28 number of sectors
   220 000000BE ??                  <2> fx_log_sectors	resb	1	;	byte fx_log_sectors;	 logical number of sectors per track
   221 000000BF ??                  <2> fx_checksum	resb	1	;	byte fx_checksum;	 checksum, dunno how to compute
   222 000000C0 <res 10h>           <2> fx81            resb    16	;*/	struct EDD_disk fx81;	/* fixed disk parameter area 1
   223 000000D0 <res 10h>           <2> fx82            resb    16	;*/	struct EDD_disk fx82;	/* fixed disk parameter area 2
   224 000000E0 <res 10h>           <2> fx83            resb    16	;*/	struct EDD_disk fx83;	/* fixed disk parameter area 3
   225                              <2> ;
   226                              <2> ;
   227                              <2> 
   228 000000F0 ????                <2> FPEM_segment    resw    1       ;*/	word FPEM_segment;	/* FPEM data segment
   229                              <2> 
   230 000000F2 ????                <2> EBDA_paragraph  resw    1       ;*/	word EBDA_paragraph;	/* lowest EBDA paragraph
   231                              <2> 
   232 000000F4 ????                <2> dma0_cw         resw    1       ;*/	word dma0_cw;		/* end of dma control word
   233 000000F6 ????                <2> dma1_cw         resw    1       ;*/	word dma1_cw;		/*   ditto
   234                              <2> 
   235 000000F8 ????                <2> fdc_type	resb	2	;*/	byte fdc_type[2];	/* disk type in low nibble, alternate in hi nib 
   236                              <2> 
   237 000000FA ????????            <2> debug_static_ptr  resw	2	;*/	void *debug_static_ptr;	/* pointer to debug static area
   238                              <2> 
   239 000000FE ??                  <2> n_fixed_disks   resb    1       ;*/	byte n_fixed_disks;	/* number of fixed disks
   240                              <2> 
   241 000000FF ??                  <2> cpu_xtal        resb    1       ;*/	byte cpu_xtal;		/* CPU crystal frequency in Mhz 
   242                              <2> ;								   CPU clock is half of this
   243                              <2> ;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;
   244                              <2> ;
   245                              <2> ;  System configuration stuff below
   246                              <2> ;	c.f., CONFIG.ASM (ANSI.CFG, CVDU.CFG, etc.), User configuration stuff
   247                              <2> ;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;
   248                              <2> %if 0				;*/
   249                              <2> #define FIXED_DISK_MAX 4		/*
   250                              <2> %else
   251                              <2> %define FIXED_DISK_MAX 4
   252                              <2> %endif
   253                              <2> %if 0				;*/
   254                              <2> #define PPIDE_driver 1		/*
   255                              <2> %else
   256                              <2> %define PPIDE_driver 1
   257                              <2> %endif
   258                              <2> %if 0				;*/
   259                              <2> #define DIDE_driver 0		/*
   260                              <2> %else
   261                              <2> %define DIDE_driver 0
   262                              <2> %endif
   263                              <2> %if 0				;*/
   264                              <2> #define DISKIO_driver 1		/*
   265                              <2> %else
   266                              <2> %define DISKIO_driver 1
   267                              <2> %endif
   268                              <2> %if 0				;*/
   269                              <2> #define MFPIC_driver 1		/*
   270                              <2> %else
   271                              <2> %define MFPIC_driver 1
   272                              <2> %endif
   273                              <2> %if 0				;*/
   274                              <2> #define DSD_driver 1		/*
   275                              <2> %else
   276                              <2> %define DSD_driver 1
   277                              <2> %endif
   278                              <2> %if 0				;*/
   279                              <2> #define V3IDE8_driver (SBC188==3)		/*
   280                              <2> %else
   281                              <2> %define V3IDE8_driver (SBC188==3)
   282                              <2> %endif
   283                              <2> 				;*/
    75                              <1> 
    76                              <1> ;  this must be the same in EQUATES.H */
    77                              <1> %if SOFT_DEBUG
    78                              <1> %define NBREAK  8
    79                              <1> %endif
    80                              <1> 
    81                              <1> 
    82                              <1> %if 0
    83                              <1>         segment _TEXT
    84                              <1> ;; *************************************************************************
    85                              <1> 
    86                              <1> 
    87                              <1> 
    88                              <1> 
    89                              <1> ;; ************************ DOS Data Segment *******************************
    90                              <1> ;dosdir	SEGMENT at 50h				; Boot disk directory from IPL
    91                              <1> ;xerox	label	byte				;  0 if Print Screen idle
    92                              <1> ;						;  1 if PrtSc xeroxing screen
    93                              <1> ;						;255 if PrtSc error in xerox
    94                              <1> ;						;  ...non-grafix PrtSc in bios
    95                              <1> ;	db	200h dup(?)			; PC-DOS bootstrap procedure
    96                              <1> ;						;  ...IBMBIO.COM buffers the
    97                              <1> ;						;  ...directory of the boot
    98                              <1> ;						;  ...device here at IPL time
    99                              <1> ;						;  ...when locating the guts
   100                              <1> ;						;  ...of the operating system
   101                              <1> ;						;  ...filename "IBMDOS.COM"
   102                              <1> ;dosdir	ends
   103                              <1> ;; *************************************************************************
   104                              <1> ;; ************************ DOS IPL Segment ********************************
   105                              <1> ;dosseg	SEGMENT at 70h				; "Kernel" of PC-DOS op sys
   106                              <1> ;;IBMBIO.COM file loaded by boot block. Device Drivers/Bootstrap. CONTIGUOUS<---
   107                              <1> ;;IBMDOS.COM operating system nucleus immediately follows IBMBIO.COM and       !
   108                              <1> ;;     doesn`t have to be contiguous.  The IBMDOS operating system nucleus     !
   109                              <1> ;;     binary image is loaded by transient code in IBMBIO binary image	      !
   110                              <1> ;dosseg	ends					;			      !
   111                              <1> ;iplseg	SEGMENT at 0h				; Segment for boot block      !
   112                              <1> ;;The following boot block is loaded with 512 bytes on the first sector of     !
   113                              <1> ;;the bootable device by code resident in the ROM-resident bios.  Control is   !
   114                              <1> ;;then transferred to the first word 0000:7C00 of the disk-resident bootstrap  !
   115                              <1> ;	ORG	07C00h				;  ..offset for boot block    !
   116                              <1> ;boot	db	200h dup(?)			;  ..start disk resident boot--
   117                              <1> ;iplseg	ends
   118                              <1> 
   119                              <1> %endif
    27                                  ;
    28                                          global  redbug
    29                                          global  crlf
    30                                          extern  _cprintf
    31                                          extern  @uart_putchar
    32                                  ;        extern  _unasm
    33                                          extern  @len_instr
    34                                          extern  _unassemble
    35                                          extern  _command
    36                                  
    37                                  ;***************************************************************************
    38                                  ; **** This debugger does not allow the modification of the SS or SP ****
    39                                  ;***************************************************************************
    40                                  
    41                                  
    42                                  regSS   equ     0               ; offset from BP
    43                                  regDS   equ     regSS+2
    44                                  regES   equ     regDS+2
    45                                  ; from the pusha:
    46                                  regDI   equ     regES+2
    47                                  regSI   equ     regDI+2
    48                                  regBP   equ     regSI+2
    49                                  regSP   equ     regBP+2
    50                                  regBX   equ     regSP+2
    51                                  regDX   equ     regBX+2
    52                                  regCX   equ     regDX+2
    53                                  regAX   equ     regCX+2
    54                                  ; from the interrupt call:
    55                                  regIP   equ     regAX+2
    56                                  regCS   equ     regIP+2
    57                                  regFLAGS equ    regCS+2
    58                                  
    59                                  
    60                                          SEGMENT _TEXT
    61                                  
    62                                  ;length  dw      0               ; length of instruction
    63                                  
    64                                  
    65                                          global  zero_divide
    66                                          global  single_step
    67                                          global  nmi_interrupt
    68                                          global  breakpoint
    69                                          global  INTO_trap
    70                                          global  bound_trap
    71                                          global  undefined_op
    72                                  
    73                                  
    74                                  %if 0
    75                                  ; These are the traps
    76                                  trap00:
    77                                          dw      zero_divide     ; divide by zero
    78                                          dw      single_step     ; single step
    79                                          dw      nmi_interrupt   ; NMI
    80                                          dw      breakpoint      ; breakpoint (int 3)
    81                                          dw      INTO_trap       ; INTO
    82                                          dw      bound_trap      ; BOUND
    83                                          dw      undefined_op    ; undefined opcode
    84                                  ; traps 0..6  a total of 7
    85                                  %endif
    86                                  
    87                                  
    88                                  single_step:
    89 00000000 2EFF0E[9100]               cs   dec     word [trace_count]
    90 00000005 7409                            jz      .1
    91 00000007 55                              push    bp              ; address into the stack
    92 00000008 89E5                            mov     bp,sp
    93 0000000A 804E0701                        or      byte [bp+regFLAGS-regAX+1],1   ; set Trace bit
    94 0000000E 5D                              pop     bp
    95 0000000F CF                              iret                    ; and continue
    96                                  .1:
    97 00000010 60                              pusha                   ; save all the registers
    98 00000011 BB0100                          mov     bx,1
    99 00000014 EB28                            jmp     common_entry
   100                                  
   101                                  breakpoint:
   102 00000016 60                              pusha
   103 00000017 BB0000                          mov     bx,0
   104 0000001A EB22                            jmp     common_entry
   105                                  zero_divide:
   106 0000001C 60                              pusha
   107 0000001D BB0200                          mov     bx,2
   108 00000020 EB1C                            jmp     common_entry
   109                                  undefined_op:
   110 00000022 60                              pusha
   111 00000023 BB0400                          mov     bx,4
   112 00000026 EB16                            jmp     common_entry
   113                                  nmi_interrupt:
   114 00000028 60                              pusha
   115 00000029 BB0600                          mov     bx,6
   116 0000002C EB10                            jmp     common_entry
   117                                  INTO_trap:
   118 0000002E 60                              pusha
   119 0000002F BB0800                          mov     bx,8
   120 00000032 EB0A                            jmp     common_entry
   121                                  bound_trap:
   122 00000034 60                              pusha
   123 00000035 BB0A00                          mov     bx,10
   124 00000038 EB04                            jmp     common_entry
   125                                  redbug:                                 ; actual call:
   126 0000003A 60                              pusha
   127 0000003B BB0C00                          mov     bx,12
   128                                  common_entry:
   129 0000003E 06                              push    es
   130 0000003F 1E                              push    ds
   131 00000040 16                              push    ss
   132 00000041 89E5                            mov     bp,sp           ; SS:BP points at machine status
   133 00000043 FC                      	cld			; 02-Nov_2014 ; clear the direction flag
   134                                  			; the IRET will restore this flag
   135 00000044 80661BFE                        and     byte [bp+regFLAGS+1],0FEh    ; clear the TRACE bit
   136 00000048 83460C06                        add     word [bp+regSP],6 ; fix the SP value by size of IRET
   137                                                                  ; return block
   138 0000004C 09DB                            or      bx,bx           ; test for Breakpoint Trap
   139 0000004E 7503                            jnz     .5
   140 00000050 FF4E16                          dec     word [bp+regIP] ; move IP back 1 to the INT3 instruction
   141 00000053 68[ssss]                .5:     push    DGROUP
   142 00000056 1F                              popm    ds
   143 00000057 F6C301                          test    bl,1            ; odd one is trace trap
   144 0000005A 750E                            jnz     .3
   145 0000005C 1E                              push    ds
   146 0000005D FFB7[6700]                      push    word [m_table+bx]
   147 00000061 E8(0000)                        call    _cprintf
   148 00000064 83C404                          add     sp,4
   149 00000067 E82900                          call    crlf
   150                                  .3:
   151 0000006A 16                              push    ss
   152 0000006B 55                              push    bp
   153 0000006C E8(0000)                        call    _command
   154 0000006F 83C404                          add     sp,4
   155                                  ;***************************************************************************
   156                                  ; the command dispatch goes here    based on DX:AX
   157                                  ;       AX == code
   158                                  ;       DX == count
   159                                  ;
   160                                  ;       AX==0 && DX==0  means GO
   161                                  ;       AX==0 && DX     means TRACE (DX is trace count)
   162                                  ;       AX    && DX==0  means STEP OVER, AX is length of present instr.
   163                                  ;***************************************************************************
   164 00000072 89C3                            mov     bx,ax           ; copy the Code
   165 00000074 09D0                            or      ax,dx           ; destroy AX
   166 00000076 7414                            jz      common_exit     ; both zero, we got the GO
   167                                  ; distinguish Step & Trace
   168 00000078 09DB                            or      bx,bx           ; check length
   169 0000007A 750B                            jnz     Step
   170                                  ; Trace operation (single_step)
   171                                  Trace:
   172 0000007C 2E8916[9100]               cs   mov     [trace_count],dx        ; set the trace count
   173 00000081 804E1B01                        or      byte [bp+regFLAGS+1],1  ; set the trace bit
   174 00000085 EB05                            jmp     common_exit
   175                                  Step:
   176 00000087 BA0100                          mov     dx,1
   177 0000008A EBF0                            jmp     Trace           ; for now
   178                                  
   179                                  ;***************************************************************************
   180                                  ; **** This debugger does not allow the modification of the SS or SP ****
   181                                  ;***************************************************************************
   182                                  
   183                                  common_exit:
   184 0000008C 58                              pop     ax      ; was SS
   185 0000008D 1F                              pop     ds
   186 0000008E 07                              pop     es
   187 0000008F 61                              popa            ;restore all but the SP
   188 00000090 CF                              iret            ; restore IP, CS, FLAGS
   189                                  
   190                                  
   191 00000091 0100                    trace_count:    dw      1       ; Note variable in SOFT code segment
   192                                  
   193                                  %if 0
   194                                  ;***************************************************************************
   195                                  ; print_regs
   196                                  ;       print two line register dump
   197                                  ;***************************************************************************
   198                                  print_regs:
   199                                          push    di
   200                                          mov     di,sp
   201                                          push    word [bp+regDI]
   202                                          push    word [bp+regSI]
   203                                          push    word [bp+regBP]
   204                                          push    word [bp+regDX]
   205                                          push    word [bp+regCX]
   206                                          push    word [bp+regBX]
   207                                          push    word [bp+regAX]
   208                                  
   209                                          push    DGROUP
   210                                          push    word fmt_reg1
   211                                          call    _cprintf
   212                                          mov     sp,di
   213                                  
   214                                  ;;;      push    word [bp+regSP]
   215                                          mov     ax,[bp+regSP]
   216                                  ;;;        add     ax,6                    ; size of the IRET return block
   217                                          push    ax
   218                                          push    word [bp+regSS]
   219                                          push    word [bp+regIP]
   220                                          push    word [bp+regCS]
   221                                          push    word [bp+regES]
   222                                          push    word [bp+regDS]
   223                                  
   224                                          push    DGROUP
   225                                          push    word fmt_reg2
   226                                          call    _cprintf
   227                                          mov     sp,di
   228                                  
   229                                          mov     di,[bp+regFLAGS]
   230                                          call    print_flags
   231                                          call    crlf
   232                                  
   233                                          pop     di
   234                                          ret
   235                                  
   236                                  print_flags:    ; flags are in DI
   237                                          push    ds
   238                                          push    DGROUP
   239                                          pop     ds
   240                                  
   241                                          cld
   242                                          mov     si,fmt_flags
   243                                          mov     ah,' '          ; Space is used below
   244                                  .0:
   245                                          lodsb
   246                                          or      al,al           ; NUL terminates
   247                                          jz      .9
   248                                  
   249                                          cmp     al,ah           ; Char in FMT means flag bit to display
   250                                          jne      .2
   251                                          add     si,3
   252                                          shl     di,1            ; skip the bit
   253                                          jmp     .0
   254                                  
   255                                  .2:     shl     di,1            ; test the bit
   256                                          jc      .3
   257                                          inc     si              ; flag bit is zero
   258                                          lodsb                   ; Get zero bit response
   259                                          xor     al,'a'-'A'
   260                                          call    @uart_putchar
   261                                          lodsb
   262                                          xor     al,'a'-'A'
   263                                          call    @uart_putchar
   264                                          jmp     .4
   265                                  .3:     call    @uart_putchar
   266                                          lodsb
   267                                          call    @uart_putchar
   268                                          inc     si
   269                                          inc     si
   270                                  .4:     mov     al,ah           ; after each response, put out a Space
   271                                          call    @uart_putchar
   272                                          jmp     .0
   273                                  
   274                                  .9:     pop     ds
   275                                          ret
   276                                  %endif
   277                                  
   278 00000093 B00D                    crlf:   mov     al,CR
   279 00000095 E8(0000)                        call    @uart_putchar
   280 00000098 B00A                            mov     al,LF
   281 0000009A E8(0000)                        call    @uart_putchar
   282 0000009D C3                              ret
   283                                  
   284                                  
   285                                          SEGMENT CONST
   286                                  %if 0
   287                                  fmt_reg1:
   288                                          db      "AX=%04x  BX=%04x  CX=%04x  DX=%04x  BP=%04x  SI=%04x  DI=%04x",NL,0
   289                                  fmt_reg2:
   290                                          db      "DS=%04x  ES=%04x  CS:IP=%04x:%04x  SS:SP=%04x:%04x   ",0
   291                                  
   292                                  fmt_flags:
   293                                          db      "                "
   294                                          db      "OVNODNUPEIDI    "
   295                                          db      "MIPLZRNZ    ACNA"
   296                                          db      "    PEPO    CYNC",0,0,0,0,0,0,0
   297                                  %endif
   298                                  
   299 00000000 427265616B706F696E-     m0:     db      "Breakpoint",0
   299 00000009 7400               
   300 0000000B 5A65726F2044697669-     m2:     db      "Zero Divide",0
   300 00000014 646500             
   301 00000017 556E646566696E6564-     m4:     db      "Undefined Opcode",0
   301 00000020 204F70636F646500   
   302 00000028 4E4D4900                m6:     db      "NMI",0
   303 0000002C 494E544F2074726170-     m8:     db      "INTO trap",0
   303 00000035 00                 
   304 00000036 424F554E4420747261-     m10:    db      "BOUND trap",0
   304 0000003F 7000               
   305 00000041 57656C636F6D652074-     m12:    db      "Welcome to %4aRED%abug (? for help)",CR,LF,0
   305 0000004A 6F2025346152454425-
   305 00000053 6162756720283F2066-
   305 0000005C 6F722068656C70290D-
   305 00000065 0A00               
   306                                  
   307                                  m_table:
   308 00000067 [0000][0B00][1700]-             dw      m0,m2,m4,m6,m8,m10,m12
   308 0000006D [2800][2C00][3600]-
   308 00000073 [4100]             
   309                                  
   310                                  
