     1                                  ;From: "jdm" <jdm1intx@DIE_SPAMBOT_DIEhome.com>
     2                                  ;2/07/2011	RAC	formatting changes
     3                                  ;			began making ROMable
     4                                  ;2/12/2011	JRC     re-combine CS and DS segments ("tiny" model)
     5                                  ;11/30/2012	JRC	correct ZF test on AH=1, int 16h
     6                                  ;
     7                                  ;
     8                                  ;***************************************************************
     9                                  ;*
    10                                  ;*
    11                                  ;*       TINY BASIC FOR INTEL 8086
    12                                  ;*
    13                                  ;*
    14                                  ;*        VERSION: 1.1
    15                                  ;*
    16                                  ;*         BY
    17                                  ;*
    18                                  ;*        MICHAEL SULLIVAN
    19                                  ;*                              BASED
    20                                  ;*                               ON
    21                                  ;*                       LI-CHEN WANG'S
    22                                  ;*
    23                                  ;*                    8080 TINY BASIC
    24                                  ;*
    25                                  ;*
    26                                  ;*                    27 JUNE 1982
    27                                  ;*
    28                                  ;*  @COPYLEFT
    29                                  ;*  ALL WRONGS RESERVED
    30                                  ;*
    31                                  ;* NOTE:
    32                                  ;*  8080 REGISTERS HAVE BEEN MAPPED AS FOLLOWS:
    33                                  ;*
    34                                  ;*  8080  8086
    35                                  ;* -------------------------------------
    36                                  ;*
    37                                  ;*  BC <-> CX
    38                                  ;*  DE <-> DX
    39                                  ;*  HL <-> BX
    40                                  ;*
    41                                  ;*
    42                                  ;* VERS 1.1 - SUPPORT MS-DOS INTERUPT I/O
    43                                  ;*     IMPROVE RND ACTION
    44                                  ;*     SUPPORT TIME AND DATE FROM MS-DOS
    45                                  ;*
    46                                  ;* RAC - 02/09/2011 - began integration with BIOS037
    47                                  ;* RAC - 08/02/2011 - re-enabled BYE command to call Int19
    48                                  ;**************************************************************
    49                                  ; Possible cassette tape format: MITS Absolute Tape Format
    50                                  ; begin: 55h/name string/0dh
    51                                  ; load record: 3ch/# of bytes data/load LSB/load MSB/data/checksum
    52                                  ;	checksum is adding with no carry all but first two & 0ffh
    53                                  ; EOF record: 78h/LSB exec address/MSB exec address
    54                                  ;
    55                                  
    56                                  %include	"config.asm"
    57                              <1> ;/*
    58                              <1> ;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;
    59                              <1> ; ANSI.CFG
    60                              <1> ;   Copied to CONFIG.ASM for general release.
    61                              <1> ;
    62                              <1> ;       Modify the parameters below to reflect your system
    63                              <1> ;
    64                              <1> ;
    65                              <1> ;   This version is for assembly by  NASM 0.98.39 or later
    66                              <1> ;
    67                              <1> ;   Copyright (C) 2010,2011 John R. Coffman.  All rights reserved.
    68                              <1> ;   Provided for hobbyist use on the N8VEM SBC-188 board.
    69                              <1> ;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;
    70                              <1> ;
    71                              <1> ; Define the serial terminal that the Video BIOS must emulate
    72                              <1> ; Set one of the following to 1
    73                              <1> ; If you have no idea what to choose, set TTY to 1
    74                              <1> TTY     equ     0       ; hardcopy -- cannot position the cursor
    75                              <1> DUMB    equ     0       ; dumb CRT -- ^H, ^J, ^K, ^L can move the cursor
    76                              <1> ANSI    equ     1       ; very smart, like a VT-100
    77                              <1> WYSE    equ     0       ; very smart Wyse series (30, 50, ...)
    78                              <1> ; others may get added in the future
    79                              <1> ;  ONE OF THE ABOVE must BE SET TO 1!!!!!
    80                              <1> ;
    81                              <1> ; Does the hardware configuration contain the Color Video Display Unit?
    82                              <1> ; Both the 8563 and the 8242 are used.  The default is CVDU=0
    83                              <1> CVDU	equ	0	; system does not have the CVDU
    84                              <1> ;
    85                              <1> ; Does the hardware configuration contain the VGA3 a/n Video card?
    86                              <1> ; The 8563 will be disabled, but the 8242 code is shared with the CVDU
    87                              <1> ; The default is VGA3=0
    88                              <1> VGA3    equ     0       ; system does not have the VGA3
    89                              <1> %if 0
    90                              <1> 	*/
    91                              <1> #define VGA3 0
    92                              <1> /*
    93                              <1> %endif
    94                              <1> ;
    95                              <1> ; Boot up keyboard mode:  20h for NumLock on
    96                              <1> ;CVDU_KEYBOARD_STATUS	equ	0	; NumLock OFF
    97                              <1> CVDU_KEYBOARD_STATUS	equ	20h	; NumLock ON
    98                              <1> 
    99                              <1> ; Define the UART startup bit rate - 1200-19200 are most common
   100                              <1> ;UART_RATE	equ	0		; 1200
   101                              <1> ;UART_RATE	equ	1		; 2400
   102                              <1> ;UART_RATE	equ	2		; 4800
   103                              <1> UART_RATE	equ	3		; 9600
   104                              <1> ;UART_RATE	equ	4		; 19200
   105                              <1> ;UART_RATE	equ	5		; 38400
   106                              <1> ;UART_RATE	equ	6		; 57600
   107                              <1> ;UART_RATE	equ	7		; 115200
   108                              <1> 
   109                              <1> ; Does the serial terminal use the DSR/DTR protocol for flow control?
   110                              <1> ;UART_DSR_PROTOCOL	equ		1	; Yes!
   111                              <1> UART_DSR_PROTOCOL       equ             WYSE    ; Wyse always uses it
   112                              <1> 						; but not ANSI
   113                              <1> ; Define the size of the ROM image on the system in Kilobytes
   114                              <1> ; It may be smaller than the actual EPROM in use.
   115                              <1> ; The following sizes are supported:  32, 64, 128, and 256
   116                              <1> %ifndef ROM
   117                              <1> ROM             equ     64              ; 64 is the default
   118                              <1> %endif
   119                              <1> 
   120                              <1> ; Define the number of Wait States at which the ROM operates
   121                              <1> ROM_WS          equ     1               ; 0..3  (1 is the default)
   122                              <1> 
   123                              <1> ; Define the size in Kilobytes of DOS RAM (low SRAM plus EMM allocate RAM)
   124                              <1> ; This is a desired size and will only be present if a 4MEM board is added
   125                              <1> RAM_DOS         equ     640
   126                              <1> 
   127                              <1> ; Define the size of the low SRAM on the system in Kilobytes
   128                              <1> ; the default is 512 kilobytes
   129                              <1> RAM             equ     512             ; (512 is the default)
   130                              <1> 
   131                              <1> ; Define the number of Wait States at which the RAM operates
   132                              <1> RAM_WS          equ     0               ; 0..3  (0 is the default)
   133                              <1> 
   134                              <1> ; Define the number of Wait States for Local Peripheral devices (600-7FF)
   135                              <1> LCL_IO_WS       equ     1               ; 0..3  (1 is the default)
   136                              <1> 
   137                              <1> ; Define the number of Wait States for ECB BUS peripheral devices (4xx)
   138                              <1> BUS_IO_WS       equ     3               ; 0..3  (3 is the default)
   139                              <1> 
   140                              <1> ; Define the time zone in which we build the Relocatable BIOS
   141                              <1> %ifndef TIMEZONE
   142                              <1> %define TIMEZONE "CDT"
   143                              <1> %endif
   144                              <1> 
   145                              <1> ; Has the REDBUG debugger been loaded?
   146                              <1> %ifndef SOFT_DEBUG
   147                              <1> %define SOFT_DEBUG 1
   148                              <1> %endif
   149                              <1> 
   150                              <1> ; Should the BIOS include "Tiny BASIC" in the image?
   151                              <1> %ifndef TBASIC
   152                              <1> TBASIC          equ     1		; default is 1
   153                              <1> %endif
   154                              <1> 
   155                              <1> ; Should the BIOS include the Floating Point Emulator?  The 80188 does
   156                              <1> ; not allow a floating point co-processor, so this is probably a good idea.
   157                              <1> %ifndef FPEM
   158                              <1> FPEM            equ     1               ; default is 1
   159                              <1> %endif
   160                              <1> 
   161                              <1> ; Define the maximum number of EMM (4MEM) boards supported
   162                              <1> EMM_BOARDS      equ     0
   163                              <1> 
   164                              <1> ; Should the Floating Point Emulator use temporary storage in the EBDA
   165                              <1> ; or at locations 0280h..3FFh in low memory?
   166                              <1> %if SOFT_DEBUG
   167                              <1> FPEM_USE_EBDA   equ     FPEM            ; default is 0
   168                              <1> %else
   169                              <1> FPEM_USE_EBDA   equ     0; FPEM            ; default is 0
   170                              <1> %endif
   171                              <1> 
   172                              <1> ; Define the size of the EPROM that is to be installed on the system
   173                              <1> ; It may be larger than the actual ROM image to be generated.
   174                              <1> %ifndef CHIP
   175                              <1> CHIP            equ     64
   176                              <1> %endif
   177                              <1> 
   178                              <1> ; Does the SBC-188 00.4 board have the LS138/LS08 piggyback fix
   179                              <1> ; Set to 1 for the SBC-188 v1.0 and later production boards
   180                              <1> ;FDC_PIGGYBACK_FIX       equ     0       ; Fix not installed
   181                              <1> FDC_PIGGYBACK_FIX       equ     1       ; fix  IS  installed
   182                              <1> 
   183                              <1> ; On SBC-188 rev 00.4 board, there is a published hardware fix (2010-09-18).
   184                              <1> ; If the wiring update is installed, or you have a later board, then
   185                              <1> ; set this to 0.  If you are using the software workaround, then set this
   186                              <1> ; to 1.  The rev 1.0 board has this fix already.
   187                              <1> NEED_TIMER_FIX  equ     0               ; have revised hardware
   188                              <1> ;NEED_TIMER_FIX  equ     1               ; use workaround
   189                              <1> 
   190                              <1> ; Define the UART oscillator speed
   191                              <1> UART_OSC        equ     1843200         ; 1.8432 Mhz is specified
   192                              <1> 
   193                              <1> 
   194                              <1> ;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;
   195                              <1> ; end of the User configuration
   196                              <1> ;       Do Not modify anything below this point
   197                              <1> ;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;
   198                              <1> 
   199                              <1> CVDU_8563	equ	CVDU		; separate inits
   200                              <1> CVDU_8242	equ	CVDU|VGA3 	; separate inits
   201                              <1> VGA3_6445       equ     VGA3            ; separate inits
   202                              <1> ; Suppress all UART output in color video Mode 3
   203                              <1> UART_MODE3_SUPPRESS	equ	CVDU_8563
   204                              <1> CVDU_USE_MSDOS_KLUDGE	equ	0; CVDU_8242	; bad, bad MSDOS
   205                              <1> CVDU_USE_KBD_HOOK		equ	CVDU_8242
   206                              <1> 
   207                              <1> ; Define existence of any uart chip
   208                              <1> UART		equ	TTY+DUMB+ANSI+WYSE
   209                              <1> startuplength   equ     512                     ; may be up to 1024
   210                              <1> startseg        equ     0FFFFh - (ROM*64) + 1
   211                              <1> highrom         equ     (ROM*400h)&0FFFFh
   212                              <1> startupseg      equ     0FFFFh - (startuplength>>4) + 1
   213                              <1> bios_data_seg   equ     040h            ; segment of BIOS data area
   214                              <1> 
   215                              <1> 
   216                              <1> %define ARG(n) [bp+2+(n)*2]
   217                              <1> 
   218                              <1> %macro  check   1.nolist
   219                              <1>  %if (%1)
   220                              <1>    %error Check Failure: %1
   221                              <1>  %endif
   222                              <1> %endm
   223                              <1> %macro  range   3.nolist
   224                              <1>  %if (%1)<(%2)
   225                              <1>    %error Out of Range: %1
   226                              <1>  %elif (%1)>(%3)
   227                              <1>    %error Out of Range: %1
   228                              <1>  %endif
   229                              <1> %endm
   230                              <1> _terminal equ UART+CVDU
   231                              <1>  check   RAM_DOS&15
   232                              <1>  check   RAM&(RAM-1)
   233                              <1>  check   ROM&(ROM-1)
   234                              <1>  range   RAM,32,512
   235                              <1>  range   ROM,32,256
   236                              <1>  range   RAM_WS,0,3
   237                              <1>  range   ROM_WS,0,3
   238                              <1>  range   RAM_DOS,RAM,(1024-ROM)
   239                              <1>  range   LCL_IO_WS,0,3
   240                              <1>  range   BUS_IO_WS,0,3
   241                              <1>  range   UART_OSC,500000,16000000
   242                              <1>  range   UART_RATE,0,7
   243                              <1>  range	 UART,0,1
   244                              <1>  range	 _terminal,1,2
   245                              <1> 
   246                              <1> %ifndef SOFT_DEBUG
   247                              <1> %define SOFT_DEBUG 0
   248                              <1> %endif
   249                              <1> 
   250                              <1> %ifndef TRACE
   251                              <1> %define TRACE 0
   252                              <1> %endif
   253                              <1> 
   254                              <1> %ifdef MAKE_OBJECT_FILE
   255                              <1>         segment _DATA WORD PUBLIC CLASS=DATA
   256                              <1>         export _ROMsize
   257                              <1>         export _CHIPsize
   258                              <1> _ROMsize        dw      ROM
   259                              <1> _CHIPsize       dw      CHIP
   260                              <1> %endif
   261                              <1> ; end of the Hardware configuration file
   262                              <1> ;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;
   263                              <1> ;*/
    57                                  %include	"cpuregs.asm"
    58                              <1> ;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;
    59                              <1> ; CPUREGS.ASM
    60                              <1> ;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;
    61                              <1> ;
    62                              <1> ;   This version is for assembly by  NASM 0.98.39 or later
    63                              <1> ;
    64                              <1> ; Copyright (C) 2010,2011 John R. Coffman.  All rights reserved.
    65                              <1> ; Provided for hobbyist use on the N8VEM SBC-188 board.
    66                              <1> ;
    67                              <1> ; This program is free software: you can redistribute it and/or modify
    68                              <1> ; it under the terms of the GNU General Public License as published by
    69                              <1> ; the Free Software Foundation, either version 3 of the License, or
    70                              <1> ; (at your option) any later version.
    71                              <1> ;
    72                              <1> ; This program is distributed in the hope that it will be useful,
    73                              <1> ; but WITHOUT ANY WARRANTY; without even the implied warranty of
    74                              <1> ; MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
    75                              <1> ; GNU General Public License for more details.
    76                              <1> ;
    77                              <1> ; You should have received a copy of the GNU General Public License
    78                              <1> ; along with this program.  If not, see <http://www.gnu.org/licenses/>.
    79                              <1> ;
    80                              <1> ;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;
    81                              <1> %include	"macros.inc"
    82                              <2> ;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;
    83                              <2> ; MACROS.INC  
    84                              <2> ;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;
    85                              <2> ;
    86                              <2> ;   This version is for assembly by  NASM 0.98.39 or later
    87                              <2> ;
    88                              <2> ; Copyright (C) 2010,2011 John R. Coffman.  All rights reserved.
    89                              <2> ; Provided for hobbyist use on the N8VEM SBC-188 board.
    90                              <2> ;
    91                              <2> ; This program is free software: you can redistribute it and/or modify
    92                              <2> ; it under the terms of the GNU General Public License as published by
    93                              <2> ; the Free Software Foundation, either version 3 of the License, or
    94                              <2> ; (at your option) any later version.
    95                              <2> ;
    96                              <2> ; This program is distributed in the hope that it will be useful,
    97                              <2> ; but WITHOUT ANY WARRANTY; without even the implied warranty of
    98                              <2> ; MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
    99                              <2> ; GNU General Public License for more details.
   100                              <2> ;
   101                              <2> ; You should have received a copy of the GNU General Public License
   102                              <2> ; along with this program.  If not, see <http://www.gnu.org/licenses/>.
   103                              <2> ;
   104                              <2> ;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;
   105                              <2> 
   106                              <2> ; general macros for the SBC188 BIOS ASSEMBLY
   107                              <2> ;
   108                              <2> ;
   109                              <2> %ifndef __MACROS_DEFINED_
   110                              <2> %define __MACROS_DEFINED_ 1
   111                              <2> ;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;
   112                              <2> ;
   113                              <2> ; some useful macros:
   114                              <2> ;
   115                              <2> ;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;
   116                              <2> ;
   117                              <2> 	cpu	186
   118                              <2> 
   119                              <2> %imacro setloc  1.nolist
   120                              <2>  times   (%1-($-$$)) db 0FFh
   121                              <2> %endm
   122                              <2> 
   123                              <2> %imacro db_lo   1
   124                              <2>  db (%1)&255
   125                              <2> %endm
   126                              <2> 
   127                              <2> %imacro cnop    0.nolist
   128                              <2> %if SOFT_DEBUG
   129                              <2>         nop
   130                              <2> %endif
   131                              <2> %endm
   132                              <2> 
   133                              <2> %imacro popm 1-*.nolist
   134                              <2> %rep %0
   135                              <2> %ifidni %1,ALL
   136                              <2>  popa
   137                              <2> %elifidni %1,F
   138                              <2>  popf
   139                              <2> %else
   140                              <2>  pop %1
   141                              <2> %ifidni %1,DS
   142                              <2>  cnop
   143                              <2> %elifidni %1,ES
   144                              <2>  cnop
   145                              <2> %endif
   146                              <2> %endif
   147                              <2> %rotate 1
   148                              <2> %endrep
   149                              <2> %endm
   150                              <2> 
   151                              <2> %imacro pushm 1-*.nolist
   152                              <2> %rep %0
   153                              <2> %rotate -1
   154                              <2> %ifidni %1,ALL
   155                              <2>  pusha
   156                              <2> %elifidni %1,F
   157                              <2>  pushf
   158                              <2> %else
   159                              <2>  push %1
   160                              <2> %endif
   161                              <2> %endrep
   162                              <2> %endm
   163                              <2> 
   164                              <2> ;
   165                              <2> ; added from the 386EX project
   166                              <2> ;
   167                              <2> 
   168                              <2> ; call arguments
   169                              <2> %define ARG(n) [bp+2+(n)*2]
   170                              <2> 
   171                              <2> ;
   172                              <2> ; format of the BYTE initialization table:  address, byte
   173                              <2> ;
   174                              <2> %imacro  binit 2
   175                              <2>         dw      %1
   176                              <2>         db      %2
   177                              <2> %endmacro
   178                              <2> ; end with DW -1
   179                              <2> 
   180                              <2> ;
   181                              <2> ; format of the WORD initialization table:  address, word
   182                              <2> ;
   183                              <2> %imacro  winit 2
   184                              <2>         dw      %1
   185                              <2>         dw      %2
   186                              <2> %endmacro
   187                              <2> ; end with DW -1
   188                              <2> 
   189                              <2> 
   190                              <2> ; get the BIOS Data Area segment pointer to a [segment] register
   191                              <2> %imacro get_bda	1.nolist
   192                              <2> 	push	0x0040
   193                              <2> 	pop	%1
   194                              <2> 	cnop
   195                              <2> %endm
   196                              <2> 
   197                              <2> 
   198                              <2> %endif
    82                              <1> 
    83                              <1> 	cpu     186
    84                              <1> ;
    85                              <1> ;
    86                              <1> ; IBM model byte -- must be less than a 286
    87                              <1> ;
    88                              <1> ;MODEL_BYTE		equ	0FEh	; PC-XT
    89                              <1> ;SUBMODEL_BYTE		equ	0FFh	; not used
    90                              <1> 
    91                              <1> MODEL_BYTE		equ	0FEh	; PC-XT
    92                              <1> SUBMODEL_BYTE		equ	00h	;  "
    93                              <1> 
    94                              <1> 
    95                              <1> ; 80188 peripheral control register block address
    96                              <1> CPU_CSCR	        equ	0FF00h
    97                              <1> 
    98                              <1> ; Compatible Mode registers
    99                              <1> 
   100                              <1> cpu_relocation          equ     CPU_CSCR+0FEh
   101                              <1> 
   102                              <1> ; The memory and peripheral chip select register offsets from 0FF00h
   103                              <1> 
   104                              <1> cpu_umcs                equ     CPU_CSCR+0A0h          ; Upper memory select
   105                              <1> cpu_lmcs                equ     CPU_CSCR+0A2h          ; Lower memory select
   106                              <1> cpu_pacs                equ     CPU_CSCR+0A4h          ; Peripheral select
   107                              <1> cpu_mmcs                equ     CPU_CSCR+0A6h          ; Middle memory base
   108                              <1> cpu_mpcs                equ     CPU_CSCR+0A8h          ; Mid mem. & peripherals
   109                              <1> 
   110                              <1> ; Enhanced Mode registers
   111                              <1> 
   112                              <1> cpu_mdram               equ     CPU_CSCR+0E0h          ; memory partition reg.
   113                              <1> cpu_cdram               equ     CPU_CSCR+0E2h          ; clock prescaler
   114                              <1> cpu_edram               equ     CPU_CSCR+0E4h          ; Enable refresh reg.
   115                              <1> cpu_pdcon               equ     CPU_CSCR+0F0h          ; Power-Save control
   116                              <1> 
   117                              <1> 
   118                              <1> ; On-board internal peripheral equates
   119                              <1> ; Programmable Interrupt Controller
   120                              <1> PIC	        equ	CPU_CSCR+020H
   121                              <1> PIC_EOI	        equ	PIC+2           ; End Of Interrupt
   122                              <1> PIC_POLLR	equ	PIC+4
   123                              <1> PIC_POLLSR	equ	PIC+6
   124                              <1> PIC_IMASK	equ	PIC+8
   125                              <1> PIC_PMREG	equ	PIC+0AH
   126                              <1> PIC_SRVR	equ	PIC+0CH
   127                              <1> PIC_IRQR	equ	PIC+0EH
   128                              <1> PIC_IRQSR	equ	PIC+10H
   129                              <1> PIC_TCR	        equ	PIC+12H
   130                              <1> PIC_DMA0CR	equ	PIC+14H
   131                              <1> PIC_DMA1CR	equ	PIC+16H
   132                              <1> PIC_I0CON	equ	PIC+18H
   133                              <1> PIC_I1CON	equ	PIC+1AH
   134                              <1> PIC_I2CON	equ	PIC+1CH
   135                              <1> PIC_I3CON	equ	PIC+1EH
   136                              <1> 
   137                              <1> EOI_NSPEC       equ     8000h           ; Non-Specific EOI
   138                              <1> 
   139                              <1> ; Interrupt masks (Master Mode)
   140                              <1> ;
   141                              <1> mask_timer_all          equ     0001h
   142                              <1> mask_dma0               equ     0004h
   143                              <1> mask_dma1               equ     0008h
   144                              <1> mask_int0               equ     0010h
   145                              <1> mask_int1               equ     0020h
   146                              <1> mask_int2               equ     0040h
   147                              <1> mask_int3               equ     0080h
   148                              <1> 
   149                              <1> 
   150                              <1> 
   151                              <1> ; Timers
   152                              <1> TIM0	        equ	CPU_CSCR+050H
   153                              <1> TIM1	        equ	CPU_CSCR+058H
   154                              <1> TIM2	        equ	CPU_CSCR+060H
   155                              <1> 
   156                              <1> TCNT	        equ	0	; count register
   157                              <1> CMPA	        equ	2	; max count A
   158                              <1> CMPB	        equ	4	; max count B (not present on TIM2)
   159                              <1> TCON	        equ	6	; mode/control word
   160                              <1> 
   161                              <1> ; Timer control bits:
   162                              <1> tc_EN           equ     8000h   ; Enable bit
   163                              <1> tc_nINH         equ     4000h   ; not Inhibit Enable
   164                              <1> tc_INT          equ     2000h   ; Interrupt Enable
   165                              <1> tc_RIU          equ     1000h   ; Register A/B (0/1) in Use
   166                              <1> tc_MC           equ     0020h   ; Maximum Count reached
   167                              <1> tc_RTG          equ     0010h   ; Retrigger (internal source)
   168                              <1> tc_P            equ     0008h   ; Prescale internal clock (timers 0 & 1 only)
   169                              <1> tc_EXT          equ     0004h   ; External clock
   170                              <1> tc_ALT          equ     0002h   ; Alternate between A & B max count registers
   171                              <1> tc_CONT         equ     0001h   ; Continuous: continue after max count
   172                              <1> 
   173                              <1> 
   174                              <1> 
   175                              <1> 
   176                              <1> ; DMA
   177                              <1> DMA0	        equ	CPU_CSCR+0C0H
   178                              <1> DMA1	        equ	CPU_CSCR+0D0H
   179                              <1> DMASPL	        equ	0	; source pointer low
   180                              <1> DMASPU	        equ	2	; source pointer high
   181                              <1> DMADPL	        equ	4	; destination pointer low
   182                              <1> DMADPU	        equ	6	; destination pointer high
   183                              <1> DMATC	        equ	8	; terminal count
   184                              <1> DMACW	        equ	0AH	; control word
   185                              <1> 
   186                              <1> 
   187                              <1> 
   188                              <1> 
   189                              <1> 
   190                              <1> ;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;
   191                              <1> ;
   192                              <1> ;       SBC-188 external devices
   193                              <1> ;
   194                              <1> ;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;
   195                              <1> 
   196                              <1> IO_BASE			equ	0400h
   197                              <1> 
   198                              <1> 
   199                              <1> 
   200                              <1> ;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;
   201                              <1> ; The UART registers
   202                              <1> ;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;
   203                              <1> 
   204                              <1> uart_base               equ     IO_BASE+0280h
   205                              <1> uart_rbr                equ     uart_base       ;Rcvr Buffer / read only
   206                              <1> uart_thr                equ     uart_base       ;Transmit Holding / write only
   207                              <1> uart_ier                equ     uart_base+1     ;Interrupt Enable
   208                              <1> uart_iir                equ     uart_base+2     ;Interrupt Ident / read only
   209                              <1> uart_fcr                equ     uart_base+2     ;FIFO Control / write only
   210                              <1> uart_lcr                equ     uart_base+3     ;Line Control
   211                              <1> uart_mcr                equ     uart_base+4     ;Modem Control
   212                              <1> uart_lsr                equ     uart_base+5     ;Line Status
   213                              <1> uart_msr                equ     uart_base+6     ;Modem Status
   214                              <1> uart_sr			equ	uart_base+7	;Scratch
   215                              <1> 
   216                              <1> uart_dll                equ     uart_base       ;Divisor Latch LS Byte
   217                              <1> uart_dlm                equ     uart_base+1     ;Divisor Latch MS Byte
   218                              <1> 
   219                              <1> 
   220                              <1> ;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;
   221                              <1> ; Floppy controller
   222                              <1> ;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;
   223                              <1> FDC	        equ	IO_BASE+0200H
   224                              <1> FDC_MSR         equ     FDC
   225                              <1> FDC_DATA        equ     FDC_MSR+1
   226                              <1> FDC_DACK        equ	FDC+10H
   227                              <1> FDC_LDOR	equ	FDC+20H
   228                              <1> FDC_LDCR	equ	FDC+30H
   229                              <1> FDC_TC	        equ	FDC+40H
   230                              <1> FDC_DACK_TC     equ     FDC_DACK | FDC_TC
   231                              <1> 
   232                              <1> 
   233                              <1> %if SBC188==1
   234                              <1> ;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;
   235                              <1> ;DS1302 RTC
   236                              <1> ;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;
   237                              <1> RTC	equ	IO_BASE+0300H
   238                              <1> %endif
   239                              <1> 
   240                              <1> ;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;
   241                              <1> ; PIO 82C55 I/O 
   242                              <1> ;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;
   243                              <1> ; for the SBCv1/v2 with PPIDE adapter board
   244                              <1> ; and for the SBCv3 with PPIDE connector
   245                              <1> ;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;
   246                              <1> PPI	        equ	IO_BASE+0260H
   247                              <1> 
   248                              <1> PIO_A	        equ	PPI+0	; (OUTPUT)
   249                              <1> PIO_B	        equ	PPI+1	; (INPUT)
   250                              <1> PIO_C	        equ	PPI+2	; (CENTRONICS control low nibble)  
   251                              <1> PIO_CTRL	equ	PPI+3	; CONTROL BYTE PIO 82C55
   252                              <1> 
   253                              <1> portA           equ     PPI+0   ;
   254                              <1> portB           equ     PPI+1   ;
   255                              <1> portC           equ     PPI+2   ;
   256                              <1> 
   257                              <1> 
   258                              <1> 
   259                              <1> ;;;%if SBC188==3   startup.asm is universal
   260                              <1> ;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;
   261                              <1> ; CONTROL LS259 PORT ON SBC188 V3
   262                              <1> ;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;
   263                              <1> CTRL259		equ	IO_BASE+0270H
   264                              <1> ; LEDS are at addresses 0..3
   265                              <1> ; other control ports on 4..7
   266                              <1> LED0		equ	CTRL259+0
   267                              <1> LED1		equ	LED0+1
   268                              <1> LED2		equ	LED0+2
   269                              <1> LED3		equ	LED0+3
   270                              <1> T1OSC18		equ	CTRL259+4	; ON=1.8432mhz, OFF="1" (for use of TIMER2)
   271                              <1> ;unused		equ	CTRL259+5
   272                              <1> FDC_RES		equ	CTRL259+6	; RESET IS ACTIVE HIGH
   273                              <1> IDE8_RES	equ	CTRL259+7	; fast IDE RESET IS ACTIVE LOW
   274                              <1> 
   275                              <1> 
   276                              <1> ;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;
   277                              <1> ; FIDE8 8-bit IDE on the 80C188 bus
   278                              <1> ;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;
   279                              <1> FIDE_BASE       equ     IO_BASE+2C0h
   280                              <1> 
   281                              <1> IDE8_CS0        equ     FIDE_BASE
   282                              <1> IDE8_CS1        equ     FIDE_BASE+0x10
   283                              <1> 
   284                              <1> ;;;%endif   startup.asm is universal
   285                              <1> 
   286                              <1> 
   287                              <1> ;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;
   288                              <1> ; Dual [DMA] IDE devices
   289                              <1> ;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;
   290                              <1> DIDE		equ	IO_BASE + 20H	; range 0x20..0x3F
   291                              <1> 
   292                              <1> DIDE0		equ	DIDE		; first interface (master & slave)
   293                              <1> DIDE1		equ	DIDE+10h	; second interface (master & slave)
   294                              <1> 
   295                              <1> 
   296                              <1> ;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;
   297                              <1> ; DISK I/O v3 device codes (PPIDE only)
   298                              <1> ;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;
   299                              <1> DISKIO		equ	IO_BASE + 20h	; range 0x20..0x3F
   300                              <1> 
   301                              <1> DISKIO_PPIDE	equ	DISKIO		; 82c55
   302                              <1> DISKIO_FDC	equ	DISKIO + 10h	; FDC 9266
   303                              <1> DISKIO_DOR	equ	DISKIO + 18h	; OPERATION REGISTER	
   304                              <1> 
   305                              <1> 
   306                              <1> ;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;
   307                              <1> ; MF/PIC interfaces
   308                              <1> ;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;
   309                              <1> MFPIC		equ	IO_BASE + 40h	; range 0x40..0x4F
   310                              <1> 
   311                              <1> ;MFPIC_202	equ	MFPIC		; NS32202 is not usable on SBC-188
   312                              <1> MFPIC_PPIDE	equ	MFPIC + 4	; PPIDE disk interface
   313                              <1> MFPIC_UART	equ	MFPIC + 8	; TL16Cx50 SIO chip
   314                              <1> 
   315                              <1> 
   316                              <1> ;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;
   317                              <1> ; Cassette I/O
   318                              <1> ;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;
   319                              <1> cuart_base	EQU 	IO_BASE+80H	; BASE IO ADDRESS OF CASSETTE UART
   320                              <1> cuart_rbr	equ     cuart_base	;Rcvr Buffer / read only
   321                              <1> cuart_thr	equ     cuart_base	;Transmit Holding / write only
   322                              <1> cuart_ier	equ     cuart_base+1	;Interrupt Enable
   323                              <1> cuart_iir	equ     cuart_base+2	;Interrupt Ident / read only
   324                              <1> cuart_fcr	equ     cuart_base+2	;FIFO Control / write only
   325                              <1> cuart_lcr	equ     cuart_base+3	;Line Control
   326                              <1> cuart_mcr	equ     cuart_base+4	;Modem Control
   327                              <1> cuart_lsr	equ     cuart_base+5	;Line Status
   328                              <1> cuart_msr	equ     cuart_base+6	;Modem Status
   329                              <1> cuart_sr	equ	cuart_base+7	;Scratch
   330                              <1> 
   331                              <1> cuart_dll	equ     cuart_base	;Divisor Latch LS Byte
   332                              <1> cuart_dlm	equ	cuart_base+1	;Divisor Latch MS Byte
   333                              <1> 
   334                              <1> 
   335                              <1> ;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;
   336                              <1> ;
   337                              <1> ;       4MEM control registers
   338                              <1> ;
   339                              <1> ;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;
   340                              <1> EMM_addr        equ     1               ; high 6 bits of 20-bit address
   341                              <1> EMM_page        equ     0               ; 4MEM page in [0..254]
   342                              <1> 
   343                              <1> EMM_BASE        equ     IO_BASE + 000h          ; first EMM (4MEM) board
   344                              <1> EMM_unmapped    equ     255             ; unmapped 4MEM page
   345                              <1> 
   346                              <1> EMM0            equ     EMM_BASE        ; first  EMM board
   347                              <1> EMM1            equ     EMM0 + 2        ; second EMM board
   348                              <1> EMM2            equ     EMM1 + 2        ; third  EMM board
   349                              <1> EMM3            equ     EMM2 + 2        ; fourth EMM board
   350                              <1> 
   351                              <1> 
   352                              <1> 
   353                              <1> 
   354                              <1> ;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;
   355                              <1> ;
   356                              <1> ;	ColorVDU devices
   357                              <1> ;
   358                              <1> ;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;
   359                              <1> ;
   360                              <1> ;	major select on the Z80 bus
   361                              <1> ;
   362                              <1> devCVDU_8bit	equ	0xE0		; this may change to 0x10
   363                              <1> 
   364                              <1> devCVDUbase 	equ	IO_BASE + devCVDU_8bit
   365                              <1> 
   366                              <1> M8563status	equ	devCVDUbase + 4		; 4 == bitrev(2)
   367                              <1> M8563register	equ	devCVDUbase + 4
   368                              <1> M8563data	equ	devCVDUbase + 12	; 12 == bitrev(3)
   369                              <1> 
   370                              <1> %if CVDU_8563
   371                              <1> I8242status	equ	devCVDUbase + 10	; 10 == bitrev(5)
   372                              <1> I8242command	equ	devCVDUbase + 10
   373                              <1> I8242data	equ	devCVDUbase + 2		; 2 == bitrev(4)
   374                              <1> %endif
   375                              <1> 
   376                              <1> 
   377                              <1> ;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;
   378                              <1> ;
   379                              <1> ;	VGA3 devices
   380                              <1> ;
   381                              <1> ;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;
   382                              <1> ;
   383                              <1> ;	major select on the Z80 bus
   384                              <1> ;
   385                              <1> devVGA3_8bit    equ     0xE0                    ; same as CVDU
   386                              <1> 
   387                              <1> devVGA3base       equ     IO_BASE + devVGA3_8bit
   388                              <1> 
   389                              <1> %if VGA3_6445
   390                              <1> I8242status	equ	devVGA3base + 1
   391                              <1> I8242command	equ	devVGA3base + 1
   392                              <1> I8242data	equ	devVGA3base + 0
   393                              <1> %endif
   394                              <1> HD6445addr	equ	devVGA3base + 2		; to address the HD6445 registers
   395                              <1> HD6445reg	equ	devVGA3base + 3		; to r/w a register on the CRTC
   396                              <1> 
   397                              <1> vga3cfg		equ	devVGA3base + 4
   398                              <1> ; the following are probably not used on the SBC-188, except for testing/checking
   399                              <1> vga3adhi	equ	devVGA3base + 5
   400                              <1> vga3adlo	equ	devVGA3base + 6
   401                              <1> vga3data	equ	devVGA3base + 7
   402                              <1> 
   403                              <1> 
   404                              <1> 
   405                              <1> ;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;
   406                              <1> ;
   407                              <1> ;       2S1P registers
   408                              <1> ;
   409                              <1> ;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;
   410                              <1> dev_2S1P_loc		equ	0xC0	; same as 4UART !!!
   411                              <1> 
   412                              <1> dev_2S1P_base		equ	IO_BASE + dev_2S1P_loc	
   413                              <1> 
   414                              <1> dev_2S1P_A		equ	dev_2S1P_base		; serial port
   415                              <1> dev_2S1P_B		equ	dev_2S1P_base + 8h	; serial port
   416                              <1> 
   417                              <1> dev_2S1P_C		equ	dev_2S1P_base + 10h	; parallel port
   418                              <1> 
   419                              <1> 
   420                              <1> ;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;
   421                              <1> ;
   422                              <1> ;       4UART registers
   423                              <1> ;
   424                              <1> ;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;
   425                              <1> dev_4UART_loc		equ	0xC0	; same as 2S1P !!!
   426                              <1> ;				0xA0	; possible alternate
   427                              <1> dev_4UART_alt_offset	equ	0xA0 - dev_4UART_loc
   428                              <1> 
   429                              <1> dev_4UART_base		equ	IO_BASE + dev_4UART_loc	
   430                              <1> 
   431                              <1> dev_4UART_A		equ	dev_4UART_base
   432                              <1> dev_4UART_B		equ	dev_4UART_base + 8h
   433                              <1> dev_4UART_C		equ	dev_4UART_base + 10h
   434                              <1> dev_4UART_D		equ	dev_4UART_base + 18h
   435                              <1> 
   436                              <1> dev_4UART_config	equ	dev_4UART_B + 7		; overlays scratch register
   437                              <1> 
   438                              <1> ;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;
   439                              <1> ; debug port -- JRC only
   440                              <1> ;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;
   441                              <1> portD		equ	IO_BASE + 0FFh		; 0x04FF
   442                              <1> ;portD		equ	portB		     ; older 8255 output on PPI
   443                              <1> 
   444                              <1> ; end CPUREGS.ASM
   445                              <1> 
    58                                  %include	"ascii.asm"
    59                              <1> ; ascii.asm
    60                              <1> ;
    61                              <1> CTRL            equ     1Fh     ; masks a character to CTRL-x
    62                              <1> 
    63                              <1> NUL     equ     00h
    64                              <1> BEL     equ     (CTRL & 'G')
    65                              <1> BS      equ     08h		; ^H
    66                              <1> HT      equ     09h		; ^I
    67                              <1> LF	equ	0Ah		; ^J
    68                              <1> NL      equ     LF
    69                              <1> VT	equ	0Bh		; ^K
    70                              <1> FWD	equ	0Ch		; ^L
    71                              <1> CR	equ	0Dh
    72                              <1> XON     equ     (CTRL & 'Q')
    73                              <1> XOFF    equ     (CTRL & 'S')
    74                              <1> DC1     equ     XON
    75                              <1> DC3     equ     XOFF
    76                              <1> ESC     equ	1Bh
    77                              <1> 
    78                              <1> 
    59                                  
    60                                  %if 0
    61                                          SEGMENT  _BASIC ALIGN=16 PUBLIC CLASS=BASIC
    62                                  %endif
    63                                          cpu     186
    64                                  
    65                                  
    66                                  	global	cbasic
    67                                          global  end_cbasic
    68                                  
    69                                  ;*********************************
    70                                  ; This is the entry point to BASIC
    71                                  ; DS= DGROUP from Int18h call
    72                                  cbasic:
    73                                  %if 1
    74                                  ; New move into place
    75 00000000 0E                         	push	cs			; some stack is there
    76 00000001 1F                      	pop	ds
    77 00000002 8B36[1500]              	mov	si,[cb_srs]		; get the source pointer
    78 00000006 C43E[1700]              	les	di,[cb_dst]		; and where we will execute
    79 0000000A B90024                     	mov	cx,end_cbasic-cbasic	; and the byte length
    80 0000000D FC                      	cld
    81 0000000E F3A4                    	rep movsb
    82 00000010 06                      	push	es
    83 00000011 68[1B00]                	push	cbasic_go
    84 00000014 CB                      	retf
    85                                  
    86 00000015 [0000]                  cb_srs:		dw	cbasic; seg cbasic
    87 00000017 00000010                cb_dst:		dw	0,1000h
    88                                  
    89                                  cbasic_go:
    90                                  %endif
    91                                  %if 0
    92                                  	; need to move data segment into place @ 60:0
    93                                  	lea	si,[OUTCAR]	; get address of start of data [ds:si]
    94                                  	mov	cx,L_DATA	; get number of bytes to move
    95                                  	mov	ax,60h		; set destination to 60:0
    96                                  	mov	es,ax		; set segment [es:di]
    97                                  	push	es
    98                                  	xor	di,di
    99                                  	cld
   100                                  again:  rep 	movsb		; when cx>0 mov [si] to es:[di]
   101                                  ; this deals with a specific bug on 286 and lower processors in which
   102                                  ; the count can get messed up if a hardware interrupt occurs during the
   103                                  ; rep.
   104                                  	jcxz	init2		; continue if REP successful on below 386
   105                                  	loop	again		; an interrupt goofed count, retry
   106                                  init2:
   107                                  	pop	ds		; re-establish ds at 60:0
   108                                  %else
   109                                  ;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;
   110                                  ; SIMULATE BEGINNING OF A .COM FILE
   111                                  ;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;
   112 0000001B 8CC8                            MOV     AX,CS
   113 0000001D 8ED8                            MOV     DS,AX
   114                                  %if SOFT_DEBUG
   115 0000001F CD00                            int     0
   116                                  %endif
   117 00000021 8EC0                            MOV     ES,AX
   118                                  %endif
   119                                  ; Using debugger, I know that I get to here and it looks like the
   120                                  ; registers contain the expected values, and memory at 60:0 appears
   121                                  ; to have the right data, but I don't get the sign-on message. The
   122                                  ; debugger traps on a BOUND/Int5 but I'm not sure what triggers it. 
   123                                  ; When I single-step, I know that the code is executing in PRTSTG 
   124                                  ; when it barfs. This has to relate to moving the data segment 
   125                                  ; because it works just fine as a standalone COM file.
   126                                  ;
   127                                  ; This is the old "start" of BASIC.
   128 00000023 FA                      	cli
   129 00000024 8ED0                    	mov	ss,ax
   130 00000026 BC[0024]                 	MOV 	SP,STACK 	;SET UP STACK
   131 00000029 FB                       	sti
   132 0000002A B00D                    	mov	al,0Dh		;get CR
   133 0000002C E8590A                  	call	CHROUT
   134 0000002F E8560A                  	call	CHROUT		;double space
   135 00000032 BA[4A01]                 	MOV 	DX,MSG1 	;GET SIGN-ON MSG
   136 00000035 E83909                   	CALL 	PRTSTG 		;SEND IT
   137 00000038 C606[3620]50             	MOV 	byte [BUFMAX],80  ;INIT CMD LINE BUFFER
   138                                  
   139                                  ; MAIN
   140                                  ;
   141                                  ; THIS IS THE MAIN LOOP THAT COLLECTS THE TINY BASIC PROGRAM
   142                                  ; AND STORES IT IN MEMORY.
   143                                  ;
   144                                  ; AT START, IT PRINTS OUT "(CR)OK(LF)", AND INITIALIZES THE
   145                                  ; STACK AND SOME OTHER INTERNAL VARIABLES. THEN IT PROMPTS
   146                                  ; ">" AND READS A LINE. IF THE LINE STARTS WITH A NONZERO
   147                                  ; NUMBER, THIS NUMBER IS THE LINE NUMBER. THE LINE NUMBER
   148                                  ; (IN 16 BIT BINARY) AND THE REST OF THE LINE (INCLUDING
   149                                  ; ITS (CR))IS STORED IN MEMORY. IF A LINE WITH THE SAME
   150                                  ; LINE NUMBER IS ALREADY THERE, IT IS REPLACED BY THE NEW
   151                                  ; ONE. IF THE REST OF THE LINE CONSISTS OF A (CR) ONLY, IT
   152                                  ; IS STORED AND ANY EXISTING LINE WITH THE SAME LINE
   153                                  ; NUMBER IS DELETED.
   154                                  ;
   155                                  ; AFTER A LINE IS INSERTED, REPLACED, OR DELETED, THE
   156                                  ; PROGRAM LOOPS BACK AND ASKS FOR ANOTHER LINE. THIS LOOP
   157                                  ; WILL BE TERMINATED WHEN IT READS A LINE WITH ZERO OR NO
   158                                  ; LINE NUMBER: CONTROL IS THEN TRANSFERED TO "DIRECT".
   159                                  ;
   160                                  ; THE TINY BASIC PROGRAM SAVE AREA STARTS AT THE MEMORY
   161                                  ; LOCATION LABELED "TXTBGN" AND ENDS AT "TXTEND". WE ALWAYS
   162                                  ; FILL THIS AREA STARTING AT "TXTBGN", THE UNFILLED PORTION
   163                                  ; POINTED TO BY THE CONTENTS OF THE MEMORY LOCATION LABELED
   164                                  ; "TXTUNF".
   165                                  ;
   166                                  ; THE MEMORY LOCATION "CURRNT" POINTS TO THE LINE NUMBER
   167                                  ; THAT IS CURRENTLY BEING INTERPRETED. WHILE WE AR IN THIS
   168                                  ; LOOP OR WHILE WE ARE INTERPRETING A DIRECT COMMAND
   169                                  ; (SEE NEXT SECTION), "CURRNT" SHOULD POINT TO A 0.
   170                                  ;
   171                                  RSTART:
   172 0000003D BC[0024]                 	MOV SP,STACK ;SET STACK POINTER
   173                                  _ST1:
   174 00000040 E8430A                   	CALL CRLF
   175 00000043 BA[3B01]                 	MOV DX,OK ;DE->STRING
   176 00000046 28C0                     	SUB AL,AL
   177 00000048 E82609                   	CALL PRTSTG ;PRINT PROMPT
   178 0000004B C706[FE0A]0000           	MOV word [CURRNT],0 ;CURRENT LINE # = 0
   179                                  _ST2:
   180 00000051 C706[060B]0000           	MOV word [LOPVAR],0
   181 00000057 C706[000B]0000           	MOV word [STKGOS],0
   182                                  _ST3:
   183 0000005D B03E                     	MOV AL,'>' ;PROMPT ">" NOW
   184 0000005F E8A208                   	CALL GETLN ;READ A LINE
   185 00000062 57                       	PUSH DI ;DI -> END OF LINE
   186                                  _ST3A:
   187 00000063 BA[3820]                 	MOV DX,BUFFER ;DX -> BEGINNING OF LINE
   188 00000066 E89000                   	CALL TSTNUM ;TEST IF IT'S A NUMBER
   189 00000069 B400                     	MOV AH,0
   190 0000006B E8750A                   	CALL IGNBLNK
   191 0000006E 09DB                     	OR BX,BX ;BX:= VALUE OF # OR 0 IF NO # FOUND
   192 00000070 59                       	POP CX ;CX -> END OF LINE
   193 00000071 7503                     	JNZ _ST3B
   194 00000073 E9C601                   	JMP DIRECT
   195                                  _ST3B:
   196 00000076 4A                       	DEC DX
   197 00000077 4A                       	DEC DX
   198 00000078 89D8                     	MOV AX,BX ;GET LINE #
   199 0000007A 89D7                     	MOV DI,DX
   200 0000007C AB                      	STOSW  ;VALUE OF LINE # THERE
   201 0000007D 51                       	PUSH CX
   202 0000007E 52                       	PUSH DX ;BX,DX -> BEGIN,END
   203 0000007F 89C8                     	MOV AX,CX
   204 00000081 29D0                     	SUB AX,DX
   205 00000083 50                       	PUSH AX ;AX:= # BYTES IN LINE
   206 00000084 E8C108                   	CALL FNDLN ;FIND THIS LINE IN SAVE
   207 00000087 52                      	PUSH DX ;AREA, DX -> SAVE AREA
   208 00000088 7512                     	JNZ _ST4 ;NZ:NOT FOUND, INSERT
   209 0000008A 52                       	PUSH DX ;Z:FOUND, DELERE IT
   210 0000008B E8D708                   	CALL FNDNXT ;FIND NEXT LINE
   211                                     		;DE -> NEXT LIE
   212 0000008E 59                      	POP CX ;CX -> LINE TO BE DELETED
   213 0000008F 8B1E[120B]               	MOV BX,[TXTUNF] ;BX -> UNFILLED SAVE AREA
   214 00000093 E88309                   	CALL MVUP ;MOVE UP TO DELETE
   215 00000096 89CB                     	MOV BX,CX ;TXTUNF -> UNFILLED AREA
   216 00000098 891E[120B]               	MOV [TXTUNF],BX ;UPDATE
   217                                  _ST4:
   218 0000009C 59                       	POP CX ;GET READY TO INSERT
   219 0000009D 8B1E[120B]               	MOV BX,[TXTUNF] ;BUT FIRST CHECK IF
   220 000000A1 58                       	POP AX ;AX = # CHARS IN LINE
   221 000000A2 53                       	PUSH BX ;IS 3 (LINE # AND CR)
   222 000000A3 3C03                     	CMP AL,3 ;THEN DO NOT INSERT
   223 000000A5 7496                     	JZ RSTART ;MUST CLEAR THE STACK
   224 000000A7 01D8                     	ADD AX,BX ;COMPUTE NEW TSTUNF
   225 000000A9 89C3                     	MOV BX,AX ;BX -> NEW UNFILLED AREA
   226                                  _ST4A:
   227 000000AB BA[0020]                 	MOV DX,TXTEND ;CHECK TO SEE IF THERE
   228 000000AE 39D3                     	CMP BX,DX ;IS ENOUGH SPACE
   229 000000B0 7203                     	JC _ST4B ;SORRY, NO ROOM FOR IT
   230 000000B2 E94908                   	JMP QSORRY
   231                                  _ST4B:
   232 000000B5 891E[120B]               	MOV [TXTUNF],BX ;OK, UPDATE TXTUNF
   233 000000B9 5A                       	POP DX ;DX -> OLD UNFILLED AREA
   234 000000BA E86A09                   	CALL MVDOWN
   235 000000BD 5A                       	POP DX ;DX -> BEGIN, BX -> END
   236 000000BE 5B                       	POP BX
   237 000000BF E85709                   	CALL MVUP ;MOVE NEW LINE TO SAVE AREA
   238 000000C2 EB99                     	jmp _ST3
   239                                  
   240 000000C4 B440                    TSTV: 	MOV AH,64 ;TEST VARIABLES
   241 000000C6 E81A0A                   	CALL IGNBLNK
   242 000000C9 721E                     	JC RET01
   243                                  TSTV1:
   244 000000CB 751D                     	JNZ TV1 ;NOT @ ARRAY
   245 000000CD E87706                   	CALL PARN ;@ SHOULD BE FOLLOWED
   246 000000D0 01DB                     	ADD BX,BX
   247 000000D2 7302                     	JNC SS1B ;IS INDEX TOO BIG?
   248 000000D4 EB59                            JMP     QHOW
   249 000000D6 52                      SS1B: 	PUSH DX ;WILL IT OVERWRITE
   250 000000D7 87D3                     	XCHG DX,BX ;TEXT?
   251 000000D9 E8B106                   	CALL SIZE ;FIND SIZE OF FREE
   252 000000DC 39D3                     	CMP BX,DX ;AND CHECK THAT
   253 000000DE 7303                     	JNC SS1A ;IFF SO, SAY "SORRY"
   254 000000E0 E91C08                          JMP     ASORRY
   255                                  SS1A:
   256 000000E3 BB[0020]                 	MOV BX,VARBGN ;IFF NOT, GET ADDRESS
   257 000000E6 29D3                     	SUB BX,DX ;OF @(EXPR) AND PUT IT
   258 000000E8 5A                       	POP DX ;IN HL
   259                                  RET01:
   260 000000E9 C3                       	RET ;C FLAG IS CLEARED
   261                                  TV1:
   262 000000EA 3C1B                     	CMP AL,27 ;NOT @, IS IT A TO Z?
   263                                  	; cmc 
   264                                   	;IFF NOT, RETURN C FLAG
   265 000000EC 720A                     	JC RET2 ;IFF NOT, RETURN C FLAG
   266 000000EE 42                       	INC DX
   267                                  TV1A:
   268 000000EF BB[0020]                 	MOV BX,VARBGN ;COMPUTE ADDRESS OF
   269 000000F2 B400                     	MOV AH,0 ;CLEAR UPPER BYTE
   270 000000F4 01C0                    	ADD AX,AX ;AX:=AX*2 (WORD STORAGE)
   271 000000F6 01C3                     	ADD BX,AX ;BX:=VARBGN+2*AL
   272                                  RET2:
   273 000000F8 C3                       	RET  ;USE CARRY AS ERROR INDICATOR
   274                                  ;
   275                                  ; TSTNUM - AT ENTRY DX -> BUFFER OF ASCII CHARACTERS
   276                                  ;
   277                                  TSTNUM:
   278 000000F9 BB0000                   	MOV BX,0 ;****TSTNUM****
   279 000000FC 88FD                     	MOV CH,BH ;TEST IFF THE TEXT IS
   280 000000FE B400                     	MOV AH,0 ;FOR CMP IN IGNBLNK
   281 00000100 E8E009                   	CALL IGNBLNK ;A NUMBER.
   282                                  TN1:
   283 00000103 3C30                     	CMP AL,'0' ;IFF NOT, RETURN 0 IN
   284 00000105 72F1                     	JC RET2 ;B AND HL
   285 00000107 3C3A                     	CMP AL,':' ;IFF NUMBERS, CONVERT
   286 00000109 73ED                     	JNC RET2 ;TO BINARY IN BX AND
   287 0000010B B0F0                     	MOV AL,0F0H  ;SET AL TO # OF DIGITS
   288 0000010D 20F8                     	AND AL,BH ;IFF BH>255, THERE IS NO
   289 0000010F 751E                     	JNZ QHOW ;ROOM FOR NEXT DIGIT
   290 00000111 FEC5                     	INC CH ;CH COUNTS NUMBER OF DIGITS
   291 00000113 51                       	PUSH CX
   292 00000114 89D8                     	MOV AX,BX ;BX:=10*BX+(NEW DIGIT)
   293 00000116 B90A00                          MOV     CX,10
   294 00000119 52                       	PUSH DX ;SAVE DX
   295                                  ;       MUL     AX,CX
   296 0000011A F7E1                     	mul cx
   297 0000011C 89C3                            MOV     BX,AX   ;PARTIAL RESULT NOW IN BX
   298 0000011E 5A                       	POP DX ;RESTORE
   299 0000011F 89D6                     	MOV SI,DX
   300 00000121 AC                       	lodsb         ;ASCII DIGIT IN AL NOW
   301 00000122 2C30                            SUB     AL,48   ;CONVERT TO BINARY
   302 00000124 B400                            MOV     AH,0
   303 00000126 01C3                            ADD     BX,AX   ;FULL RESULT NOW IN BX
   304 00000128 59                       	POP CX
   305 00000129 AC                       	lodsb            ;REPEAT FOR MORE DIGITS
   306 0000012A 9F                       	LAHF  ;SAVE FLAGS
   307 0000012B 42                       	INC DX
   308 0000012C 9E                       	SAHF  ;RESTORE FLAGS
   309 0000012D 79D4                     	JNS TN1 ;QUIT IF NO NUM OR OVERFLOW
   310                                  QHOW:
   311 0000012F 52                       	PUSH DX ;****ERROR: "HOW?"****
   312                                  AHOW:
   313 00000130 BA[3601]                 	MOV DX,HOW
   314 00000133 E98E07                   	JMP ERROR
   315                                  HOW:
   316 00000136 484F573F0D               	DB 'HOW?',0DH
   317                                  OK:
   318 0000013B 4F4B0D                   	DB 'OK',0DH
   319                                  WHAT:
   320 0000013E 574841543F0D             	DB 'WHAT?',0DH
   321                                  SORRY:
   322 00000144 534F5252590D             	DB 'SORRY',0DH
   323                                  MSG1:
   324 0000014A 383038362054494E59-      	DB '8086 TINY BASIC V1.1 27 JUNE 82',0DH
   324 00000153 204241534943205631-
   324 0000015C 2E31203237204A554E-
   324 00000165 452038320D         
   325                                  MSG2:
   326 0000016A 45584954494E472042-     	DB 'EXITING BASIC...BYE',0DH	
   326 00000173 415349432E2E2E4259-
   326 0000017C 450D               
   327                                  
   328                                  ;
   329                                  ;*
   330                                  ;**********************************************************
   331                                  ;*
   332                                  ;* *** TABLES *** DIRECT *** & EXEC ***
   333                                  ;*
   334                                  ;* THIS SECTION OF THE CODE TESTS A STRING AGAINST A TABLE.
   335                                  ;* WHEN A MATCH IS FOUND, CONTROL IS TRANSFERRED TO THE SECTION
   336                                  ;* OF CODE ACCORDING TO THE TABLE.
   337                                  ;*
   338                                  ;* AT 'EXEC' DX SHOULD POINT TO THE STRING AND BX SHOULD POINT
   339                                  ;* TO THE TABLE-1. AT 'DIRECT', DX SHOULD POINT TO THE STRING,
   340                                  ;* BX WILL BE SET UP TO POINT TO TAB1-1, WHICH IS THE TABLE OF
   341                                  ;* ALL DIRECT AND STATEMENT COMMANDS.
   342                                  ;*
   343                                  ;* A '.' IN THE STRING WILL TERMINATE THE TEST AND THE PARTIAL
   344                                  ;* MATCH WILL BE CONSIDERED AS A MATCH. E.G., 'PR.',
   345                                  ;* 'PRI.', 'PRIN.', OR 'PRINT' WILL ALL MATCH 'PRINT'.
   346                                  ;*
   347                                  ;* THE TABLE CONSISTS OF ANY NUMBER OF ITEMS. EACH ITEM
   348                                  ;* IS A STRING OF CHARACTERS WITH BIT 7 SET TO 1 IN LAST CHAR
   349                                  ;* A JUMP ADDRESS IS STORED FOLLOWING EACH CHARACTER ENTRY.
   350                                  ;*
   351                                  ;* END OF TABLE IS AN ITEM WITH A JUMP ADDRESS ONLY. IF THE
   352                                  ;* STRING DOES NOT MATCH ANY OF THE OTHER ITEMS, IT WILL
   353                                  ;* MATCH THIS NULL ITEM AS DEFAULT. THE DEFAULT IS INDICATED
   354                                  ;* BY FOLLOWING THE 80H DEFAULT INDICATOR.
   355                                  ;*
   356                                  
   357                                  TAB1:   EQU $ ;DIRECT COMMANDS
   358 0000017E 4C4953D4                 	db 'LIS','T' | 80h
   359 00000182 [EE03]                   	DW LIST ;EXECUTION ADDRESSES
   360 00000184 454449D4                 	db 'EDI','T' | 80h
   361 00000188 [0704]                   	DW EDIT
   362 0000018A C5                       	db 'E' | 80h
   363 0000018B [0704]                   	DW EDIT ;HAVE SHORT FORM DEFINED ALSO
   364 0000018D 5255CE                   	db 'RU','N' | 80h
   365 00000190 [8F02]                   	DW RUN
   366 00000192 4E45D7                   	db 'NE','W' | 80h
   367 00000195 [8302]                   	DW NEW
   368                                  ; Load and Save removed for now
   369                                  ; 	db 'LOA','D' | 80h
   370                                  ; 	DW DLOAD
   371                                  ; 	db 'SAV','E' | 80h
   372                                  ; 	DW DSAVE
   373 00000197 4259C5                   	db 'BY','E' | 80h  ;GO BACK TO DOS (EXIT TBASIC)
   374 0000019A [C402]                   	DW BYE
   375                                  TAB2: 	EQU $ ;DIRECT/STATEMENT
   376 0000019C 4E4558D4                 	db 'NEX','T' | 80h
   377 000001A0 [4505]                   	DW NEXT ;EXECUTION ADDRESSES
   378 000001A2 4C45D4                   	db 'LE','T' | 80h
   379 000001A5 [4306]                   	DW LET
   380 000001A7 4F55D4                   	db 'OU','T' | 80h
   381 000001AA [9B07]                   	DW OUTCMD
   382 000001AC 504F4BC5                 	db 'POK','E' | 80h
   383 000001B0 [FD07]                   	DW POKE
   384 000001B2 574149D4                 	db 'WAI','T' | 80h
   385 000001B6 [C107]                   	DW WAITCM
   386 000001B8 49C6                     	db 'I','F' | 80h
   387 000001BA [B505]                   	DW IFF
   388 000001BC 474F54CF                 	db 'GOT','O' | 80h
   389 000001C0 [B202]                   	DW GOTO
   390 000001C2 474F5355C2               	db 'GOSU','B' | 80h
   391 000001C7 [8C04]                   	DW GOSUB
   392 000001C9 5245545552CE             	db 'RETUR','N' | 80h
   393 000001CF [B504]                   	DW RETURN
   394 000001D1 5245CD                   	db 'RE','M' | 80h
   395 000001D4 [B005]                   	DW REM
   396 000001D6 464FD2                   	db 'FO','R' | 80h
   397 000001D9 [D604]                   	DW FOR
   398 000001DB 494E5055D4               	db 'INPU','T' | 80h
   399 000001E0 [D805]                   	DW INPUT
   400 000001E2 5052494ED4               	db 'PRIN','T' | 80h
   401 000001E7 [4104]                   	DW PRINT
   402 000001E9 53544FD0                	db 'STO','P' | 80h
   403 000001ED [8902]                   	DW STOP
   404 000001EF 80                       	DB 128 ;SIGNALS END
   405                                     	;REMEMBER TO MOVE DEFAULT DOWN.
   406 000001F0 [3C06]                   	DW DEFLT ;LAST POSIBILITY
   407                                  TAB4: 	EQU $ ;FUNCTIONS
   408 000001F2 524EC4                   	db 'RN','D' | 80h
   409 000001F5 [5C07]                   	DW RND
   410 000001F7 494ED0                   	db 'IN','P' | 80h
   411 000001FA [ED07]                   	DW INP
   412 000001FC 504545CB                 	db 'PEE','K' | 80h
   413 00000200 [1F08]                   	DW PEEK
   414 00000202 5553D2                   	db 'US','R' | 80h
   415 00000205 [2A08]                   	DW USR
   416 00000207 4142D3                   	db 'AB','S' | 80h
   417 0000020A [8007]                   	DW ABSS
   418 0000020C 53495AC5                 	db 'SIZ','E' | 80h
   419 00000210 [8D07]                   	DW SIZE
   420 00000212 80                       	DB 128 ;SIGNALS END
   421                                     	;YOU CAN ADD MORE FUNCTIONS BUT REMEMBER
   422                                     	;TO MOVE XP40 DOWN
   423 00000213 [2F07]                   	DW XP40
   424                                  TAB5: 	EQU $ ;"TO" IN "FOR"
   425 00000215 54CF                     	db 'T','O' | 80h
   426 00000217 [E704]                  TAB5A: 	DW FR1
   427 00000219 80                       	DB 128
   428 0000021A [C008]                   	DW QWHAT
   429                                  TAB6: 	EQU $ ;"STEP" IN "FOR"
   430 0000021C 535445D0                 	db 'STE','P' | 80h
   431 00000220 [F404]                  TAB6A: 	DW FR2
   432 00000222 80                       	DB 128
   433 00000223 [F904]                   	DW FR3
   434                                  TAB8: 	EQU $ ;RELATION OPERATORS
   435 00000225 3EBD                     	db '>','=' | 80h
   436 00000227 [5C06]                   	DW XP11 ;EXECUTION ADDRESS
   437 00000229 A3                       	db '#' | 80h
   438 0000022A [6406]                   	DW XP12
   439 0000022C BE                       	db '>' | 80h
   440 0000022D [6C06]                   	DW XP13
   441 0000022F BD                       	db '=' | 80h
   442 00000230 [8206]                   	DW XP15
   443 00000232 3CBD                     	db '<','=' | 80h
   444 00000234 [7606]                   	DW XP14
   445 00000236 BC                       	db '<' | 80h
   446 00000237 [8A06]                   	DW XP16
   447 00000239 80                       	DB 128
   448 0000023A [9206]                   	DW XP17
   449                                  ;
   450                                  ; END OF PARSER ACTION TABLE
   451                                  ;
   452                                  ;
   453                                  ; AT ENTRY BX -> COMMAND TABLE (ABOVE)
   454                                  ;    DX -> COMMAND LINE (I.E. "BUFFER")
   455                                  ;
   456                                  DIRECT:
   457 0000023C BB[7D01]                 	MOV BX,TAB1-1 ;***DIRECT***
   458                                   ;*
   459                                  EXEC: EQU $ ;***EXEC***
   460                                  EX0:
   461 0000023F B400                     	MOV AH,0
   462 00000241 E89F08                   	CALL IGNBLNK ;IGNORE LEADING BLANKS
   463 00000244 52                       	PUSH DX ;SAVE POINTER
   464 00000245 89D6                     	MOV SI,DX
   465 00000247 AC                      EX1: 	lodsb  ;GET CHAR WHERE DX ->
   466 00000248 42                       	INC DX ;PRESERVE POINTER
   467 00000249 3C2E                     	CMP AL,'.' ;WE DECLARE A MATCH
   468 0000024B 7420                     	JZ EX4
   469 0000024D 43                       	INC BX
   470 0000024E 8A27                     	MOV AH,[BX]
   471 00000250 80E47F                   	AND AH,127 ;STRIP BIT 7
   472 00000253 24DF                    	and al,0DFh   ; uppercase al
   473                                  
   474 00000255 38E0                     	CMP AL,AH ;COMPARISON NOW EASY
   475 00000257 741F                     	JZ EX2
   476                                   ; NO MATCH - CHECK NEXT ENTRY
   477 00000259 803F80                  EX0A: 	CMP byte [BX],128 ;BYTE COMPARE
   478 0000025C 7303                     	JNC EX0B
   479 0000025E 43                       	INC BX
   480 0000025F EBF8                     	jmp EX0A
   481                                   ; AT THIS POINT HAVE LAST LETTER
   482 00000261 83C303                  EX0B: 	ADD BX,3 ;GET PAST EXECUTION ADDRESS
   483 00000264 803F80                   	CMP byte [BX],128 ;FOUND DEFAULT?
   484 00000267 740C                     	JZ EX3A ;IF SO, EXECUTE DEFAULT
   485 00000269 4B                       	DEC BX ;CORRECT FOR PRE-INCREMENT
   486 0000026A 5A                       	POP DX ;RESTORE POINTER
   487 0000026B EBD2                     	jmp EX0 ;LOOK SOME MORE FOR A MATCH
   488 0000026D 43                      EX4: 	INC BX
   489 0000026E 803F80                   	CMP byte [BX],128
   490 00000271 72FA                     	JC EX4
   491 00000273 EB08                    	jmp EX3
   492                                  
   493 00000275 4E                      EX3A: 	DEC SI
   494 00000276 EB05                     	jmp EX3 ;CORRECT SI FOR DEFAULT EXECUTION
   495 00000278 803F80                  EX2: 	CMP byte [BX],128 ;END OF RESERVED WORD?
   496 0000027B 72CA                     	JC EX1 ;NO - CHECK SOME MORE
   497                                   ; AT THIS POINT NEED TO GET EXECUTION ADDRESS
   498                                  
   499 0000027D 43                      EX3: 	INC BX ;BX -> EXECUTION ADDRESS
   500 0000027E 58                       	POP AX ;CLEAR STACK
   501 0000027F 89F2                     	MOV DX,SI ;RESET POINTER
   502 00000281 FF27                     	JMP [BX] ;DO IT
   503                                  ;*
   504                                  ;
   505                                  ;
   506                                  ; WHAT FOLLOWS IS THE CODE TO ECECUTE DIRECT AND STATEMENT COM-
   507                                  ; MANDS. CONTROL IS TRANSFERED TO THESE POINTS VIA THE  COMMAND
   508                                  ; TABLE LOOKUP CODE OF 'DIRECT' AND 'EXEC' IN THE LAST SECTION.
   509                                  ; AFTER THE COMMAND IS EXECUTED,  CONTROL  IS  TRANSFERRED   TO
   510                                  ; OTHER SECTIONS AS FOLLOWS:
   511                                  ;
   512                                  ; FOR 'LIST','NEW', ANS 'STOP': GO BACK TO 'RSTART'
   513                                  ;
   514                                  ; FOR 'RUN',: GO EXECUTE THE FIRST STORED LINE IFF ANY; ELSE
   515                                  ;   GO BACK TO RSTART.
   516                                  ;
   517                                  ; FOR 'GOTO' AND 'GOSUB': GO EXECUTE THE TARGET LINE.
   518                                  ;
   519                                  ; FOR 'RETURN' AND 'NEXT': GO BACK TO SAVED RETURN LINE.
   520                                  ;
   521                                  ; FOR ALL OTHERS: IFF 'CURRNT' -> 0, GO TO 'RSTART', ELSE
   522                                  ;   GO EXECUTE NEXT COMMAND. (THIS IS DONE
   523                                  ;   IN 'FINISH'.)
   524                                  ;
   525                                  ;
   526                                  ; ****NEW****STOP****RUN (& FRIENDS)****GOTO****
   527                                  ;
   528                                  ; 'NEW(CR)' SETS 'TXTUNF' TO POINT TO 'TXTBGN'
   529                                  ;
   530                                  ; 'STOP(CR)' GOES BACK TO 'RSTART'
   531                                  ;
   532                                  ; 'RUN(CR)' FINDS THE FIRST STROED LINE, STORES ITS ADDRESS
   533                                  ; (IN 'CURRNT'), AND START TO EXECUTE IT. NOTE THAT ONLY
   534                                  ; THOSE COMMANDS IN TAB2 ARE LEGAL FOR STORED PROGRAMS.
   535                                  ;
   536                                  ; THERE ARE THREE MORE ENTRIES IN 'RUN':
   537                                  ;
   538                                  ; 'RUNNXL' FINDS NEXT LINE, STORES ITS ADDR AND EXEC IT.
   539                                  ; 'RUNTSL' STORES THE ADDRESS OF THIS LINE AND EXECUTES IT
   540                                  ; 'RUNSML' CONTINUES THE EXECUTION ON SAME LINE.
   541                                  ;
   542                                  ; 'GOTO(EXPR)' EVALUATES THE EXPRESSION, FINDS THE TARGET LINE,
   543                                  ; AND JUMPS TO 'RUNTSL' TO DO IT.
   544                                  ;
   545                                  ; 'DLOAD' LOADS A NAMES PROGRAM FROM DISK (ANYNAME.TBI)
   546                                  ;
   547                                  ; 'DSAVE' SAVES A NAMES PROGRAM ON DISK
   548                                  ;
   549                                  ; 'FCBSET' SETS UP THE MSDOS FILE CONTROL BLOCK FOR SUBSEQUENT
   550                                  ; DISK I/O.
   551                                  ;
   552                                  ;
   553                                  NEW:
   554 00000283 C706[120B][140B]         	MOV word [TXTUNF],TXTBGN
   555                                   ;
   556                                  STOP:
   557 00000289 E82D06                   	CALL ENDCHK ;****STOP(CR)****
   558 0000028C E9AEFD                   	JMP RSTART
   559                                   ;
   560                                  RUN:
   561 0000028F E82706                   	CALL ENDCHK ;****RUN(CR)****
   562 00000292 BA[140B]                 	MOV DX,TXTBGN ;FIRST SAVED LINE
   563                                   ;
   564                                  RUNNXL:
   565 00000295 BB0000                   	MOV BX,0 ;****RUNNXL****
   566 00000298 E8B706                   	CALL FNDLNP ;FIND WHATEVER LINE
   567 0000029B 7303                     	JNC RUNTSL ;C: PASSED TXTUNF, QUIT
   568 0000029D E99DFD                          JMP     RSTART
   569                                   ;
   570                                  RUNTSL:
   571 000002A0 87D3                     	XCHG DX,BX ;****RUNTSL****
   572 000002A2 891E[FE0A]               	MOV [CURRNT],BX ;SET 'CURRNT"->LINE #
   573 000002A6 87D3                     	XCHG DX,BX
   574 000002A8 42                       	INC DX
   575 000002A9 42                       	INC DX
   576                                   ;
   577                                  RUNSML:
   578 000002AA E80D08                   	CALL CHKIO ;****RUNSML****
   579 000002AD BB[9B01]                 	MOV BX,TAB2-1 ;FIND COMMAND IN TABLE 2
   580 000002B0 EB8D                     	JMP EXEC ;AND EXECUTE IT
   581                                   ;
   582                                  GOTO:
   583 000002B2 E89D03                   	CALL EXP ;****GOTO(EXPR)****
   584 000002B5 52                       	PUSH DX ;SAVE FOR ERROR ROUTINE
   585 000002B6 E80006                   	CALL ENDCHK ;MUST FIND A 0DH (CR)
   586 000002B9 E88C06                   	CALL FNDLN ;FIND THE TARGET LINE
   587 000002BC 7403                     	JZ GT1 ;NO SUCH LINE #
   588 000002BE E96FFE                          JMP     AHOW
   589 000002C1 58                      GT1: 	POP AX
   590 000002C2 EBDC                     	jmp RUNTSL ;GO DO IT
   591                                   ;
   592                                   ; BDOS EQUATES (FOR MS-DOS)
   593                                   ;
   594                                  ;BYE: 		EQU 0 	;BDOS EXIT ADDRESS
   595                                  FCB:		EQU 5CH
   596                                  SETDMA: 	EQU 26
   597                                  OPEN: 		EQU 15
   598                                  READD: 		EQU 20
   599                                  WRITED: 	EQU 21
   600                                  CLOSE: 		EQU 16
   601                                  MAKE: 		EQU 22
   602                                  BCONIN: 	EQU 10 	;BUFFERED CONSOLE INPUT
   603                                  DELETE: 	EQU 19
   604                                  CONOUT: 	EQU 2 	;CONSOLE OUTPUT
   605                                  CONSTAT: 	EQU 11 	;CONSOLE STATUS
   606                                   ;
   607                                   ;
   608                                   
   609                                  ; Exit BASIC by rebooting SBC-188
   610                                  BYE:
   611 000002C4 BA[6A01]                	MOV	DX,MSG2		;GET EXIT MSG
   612 000002C7 E8A706                  	CALL	PRTSTG		;SEND IT
   613 000002CA CD19                    	INT	19H		; call warm boot function
   614 000002CC F4                      	HLT			; should not get here!
   615                                  
   616                                  DLOAD:
   617 000002CD B400                     	MOV AH,0
   618 000002CF E81108                   	CALL IGNBLNK ;IGNORE BLANKS
   619 000002D2 53                       	PUSH BX ;SAVE H
   620 000002D3 E8CC00                   	CALL FCBSET ;SET UP FILE CONTROL BLOCK
   621 000002D6 52                       	PUSH DX ;SAVE THE REST
   622 000002D7 51                       	PUSH CX ;SAVE THE REST
   623 000002D8 BA5C00                   	MOV DX,FCB ;GET FCB ADDR
   624 000002DB B40F                     	MOV AH,OPEN ;PREPARE TO OPEN FILE
   625 000002DD CD21                     	INT 21h ;CALL MS-DOS TO OPEN FILE
   626 000002DF 3CFF                     	CMP AL,0FFH ;IS IT THERE?
   627 000002E1 7503                    	JNZ DL1 ;NO, SEND ERROR
   628 000002E3 E949FE                          JMP     QHOW
   629 000002E6 30C0                    DL1: 	XOR AL,AL ;CLEAR A
   630 000002E8 A27C00                  	MOV [FCB+32],AL ;START AT RECORD 0
   631 000002EB BA[140B]                 	MOV DX,TXTBGN ;GET BEGINNING
   632                                  LOAD:
   633 000002EE 52                       	PUSH DX ;SAVE DMA ADDRESS
   634 000002EF B41A                     	MOV AH,SETDMA
   635 000002F1 CD21                     	INT 21h ;CALL MS-DOS TO SET DAM ADDR
   636 000002F3 B414                     	MOV AH,READD
   637 000002F5 BA5C00                   	MOV DX,FCB
   638 000002F8 CD21                     	INT 21h ;CALL MS-DOS TO READ SECTOR
   639 000002FA 3C01                     	CMP AL,1 ;DONE?
   640 000002FC 722A                     	JC RDMORE ;NO, READ MORE
   641 000002FE 7403                     	JZ LL1
   642 00000300 E92CFE                  LOAD1: 	JMP QHOW ;BAD READ OR NO DELIMITER
   643 00000303 B410                    LL1: 	MOV AH,CLOSE
   644 00000305 BA5C00                   	MOV DX,FCB
   645 00000308 CD21                     	INT 21h ;CALL MS-DOS TO CLOSE FILE
   646 0000030A 5D                       	POP BP ;DMA ADDR IN BP
   647 0000030B 81ED0001                 	SUB BP,100H ;BACKUP
   648 0000030F B90001                   	MOV CX,100H ;MAX LOOPS
   649 00000312 45                      RDM1: 	INC BP ;PRE INC
   650 00000313 837E0000                 	CMP word [BP],0 ;FOUND DELIMITER?
   651 00000317 E0F9                     	LOOPNZ RDM1 ;KEEP LOOKING
   652 00000319 80F900                   	CMP CL,0 ;MAC LOOPS EXECUTED?
   653 0000031C 74E2                     	JZ LOAD1 ;GIVE ERROR IF SO
   654 0000031E 892E[120B]               	MOV [TXTUNF],BP ;UPDATE POINTER
   655 00000322 59                       	POP CX ;GET OLD REG BACK
   656 00000323 5A                       	POP DX ;GET OLD REG BACK
   657 00000324 5B                       	POP BX ;GET OLD REG BACK
   658 00000325 E8CD07                   	CALL FINISH ;FINISH
   659                                  RDMORE:
   660 00000328 5A                       	POP DX ;GET DMA ADDR
   661 00000329 BB8000                   	MOV BX,80H ;GET 128
   662 0000032C 01D3                     	ADD BX,DX ;ADD IT TO DMA ADDR
   663 0000032E 87D3                     	XCHG DX,BX ;BACK IN D
   664 00000330 EBBC                     	JMP LOAD ;AND READ SOME MORE
   665                                   ;
   666                                  DSAVE:
   667 00000332 813E[120B][140B]         	CMP word [TXTUNF],TXTBGN ;SEE IF ANYTHING TO SAVE
   668 00000338 7503                     	JNZ DS1A
   669 0000033A E98305                   	JMP QWHAT
   670                                  DS1A:
   671 0000033D 8B2E[120B]               	MOV BP,[TXTUNF]
   672 00000341 C746000000               	MOV word [BP],0 ;SET DELIMITER
   673 00000346 B400                     	MOV AH,0
   674 00000348 E89807                   	CALL IGNBLNK ;IGNORE BLANKS
   675 0000034B 53                       	PUSH BX ;SAVE BX
   676 0000034C E85300                   	CALL FCBSET ;SETUP FCB
   677 0000034F 52                       	PUSH DX
   678 00000350 51                       	PUSH CX ;SAVE OTHERS
   679 00000351 BA5C00                   	MOV DX,FCB
   680 00000354 B413                     	MOV AH,DELETE
   681 00000356 CD21                     	INT 21h ;CALL MS-DOS TO ERASE FILE
   682 00000358 BA5C00                   	MOV DX,FCB
   683 0000035B B416                     	MOV AH,MAKE
   684 0000035D CD21                     	INT 21h ;CALL MS-DOS TO MAKE A NEW ONE
   685 0000035F 3CFF                     	CMP AL,0FFH ;IS THERE SPACE?
   686 00000361 7503                     	JNZ DS1
   687 00000363 E9C9FD                          JMP     QHOW ;NO, ERROR
   688 00000366 30C0                    DS1: 	XOR AL,AL ;CLEAR A
   689 00000368 A27C00                   	MOV [FCB+32],AL ;START AT RECORD 0
   690 0000036B BA[140B]                 	MOV DX,TXTBGN ;GET BEGINNING
   691                                  SAVE:
   692 0000036E 52                       	PUSH DX ;SAVE DMA ADDR
   693 0000036F B41A                     	MOV AH,SETDMA
   694 00000371 CD21                     	INT 21h ;CALL MS-DOS TO SET DMA ADDR
   695 00000373 B415                     	MOV AH,WRITED
   696 00000375 BA5C00                   	MOV DX,FCB
   697 00000378 CD21                     	INT 21h ;CALL MS-DOS TO WRITE SECTOR
   698 0000037A 08C0                     	OR AL,AL ;SET FLAGS
   699 0000037C 7403                     	JZ SS1 ;IF NOT ZERO, ERROR
   700 0000037E E9AEFD                          JMP     QHOW
   701 00000381 5A                      SS1: 	POP DX ;GET DMA ADDR BACK
   702 00000382 89D0                     	MOV AX,DX
   703 00000384 3B06[120B]               	CMP AX,[TXTUNF] ;SEE IF DONE
   704 00000388 740B                     	JZ SAVDON
   705 0000038A 7309                     	JNC SAVDON ;JUMP IF DONE
   706                                  WRITMOR:
   707 0000038C BB8000                   	MOV BX,80H
   708 0000038F 01D3                     	ADD BX,DX
   709 00000391 87D3                    	XCHG DX,BX ;GET IT TO D
   710 00000393 EBD9                     	jmp SAVE
   711                                  SAVDON:
   712 00000395 B410                     	MOV AH,CLOSE
   713 00000397 BA5C00                   	MOV DX,FCB
   714 0000039A CD21                     	INT 21h ;CALL MS-DOS TO CLOSE FILE
   715 0000039C 59                       	POP CX ;GET REGS BACK
   716 0000039D 5A                       	POP DX ;GET REGS BACK
   717 0000039E 5B                       	POP BX ;GET REGS BACK
   718 0000039F E85307                   	CALL FINISH
   719                                   ;
   720                                  FCBSET:
   721 000003A2 BB5C00                   	MOV BX,FCB ;GET FCB ADDR
   722 000003A5 C60700                   	MOV byte [BX],0 ;CLEAR ENTRY TYPE
   723                                  FNCLR:
   724 000003A8 43                       	INC BX
   725 000003A9 C60720                   	MOV byte [BX],' ' ;CLEAR TO SPACE
   726 000003AC B86400                   	MOV AX,FCB+8
   727 000003AF 39D8                     	CMP AX,BX ;DONE?
   728 000003B1 75F5                     	JNZ FNCLR ;NO, DO IT AGAIN
   729 000003B3 43                       	INC BX
   730 000003B4 C60754                   	MOV byte [BX],'T' ;SET FILE TYPE TO 'TBI'
   731 000003B7 43                       	INC BX
   732 000003B8 C60742                   	MOV byte [BX],'B'
   733 000003BB 43                       	INC BX
   734 000003BC C60749                   	MOV byte [BX],'I'
   735                                  EXRC:
   736 000003BF 43                       	INC BX
   737 000003C0 C60700                   	MOV byte [BX],0
   738 000003C3 B86B00                   	MOV AX,FCB+15
   739 000003C6 39D8                     	CMP AX,BX
   740 000003C8 75F5                     	JNZ EXRC ;NO, CONTINUE
   741 000003CA BB5D00                   	MOV BX,FCB+1 ;GET FILENAME START
   742                                  FN:
   743 000003CD 89D6                     	MOV SI,DX
   744 000003CF AC                       	lodsb ;GET CHAR
   745 000003D0 3C0D                     	CMP AL,0DH ;IS IT A 'CR'
   746 000003D2 7419                     	JZ RET3 ;YES, DONE
   747 000003D4 3C21                     	CMP AL,'!' ;LEGAL CHAR?
   748 000003D6 7303                     	JNC     FN1 ;NO, SEND ERROR
   749 000003D8 E9E504                          JMP     QWHAT
   750 000003DB 3C5B                    FN1: 	CMP AL,'[' ;AGAIN
   751 000003DD 7203                     	JC FN2 ;DITTO
   752 000003DF E9DE04                          JMP     QWHAT
   753 000003E2 8807                    FN2: 	MOV [BX],AL ;SAVE IT IN FCB
   754 000003E4 43                       	INC BX
   755 000003E5 42                       	INC DX
   756 000003E6 B86500                   	MOV AX,FCB+9
   757 000003E9 39D8                     	CMP AX,BX ;LAST?
   758 000003EB 75E0                     	JNZ FN ;NO, CONTINUE
   759                                  RET3:
   760 000003ED C3                       	RET ;TRUNCATE AT EIGHT CHARS
   761                                  ;
   762                                  ;
   763                                  ; ****LIST**** AND ****PRINT**** AND ****EDIT****
   764                                  ;
   765                                  ; LIST HAS TWO FORMS:
   766                                  ; 'LIST(CR)' LISTS ALL SAVED LINES
   767                                  ; 'LIST #(CR)' START LIST AT THIS LINE #
   768                                  ; YOU CAN STOP LISTING BY CONTROL C KEY
   769                                  ;
   770                                  ; PRINT COMMAND IS 'PRINT ....;' OR 'PRINT ....(CR)'
   771                                  ; WHERE '....' IS A LIST OF EXPRESIONS, FORMATS, BACKARROWS, AND
   772                                  ; STRINGS. THESE ITEMS ARE SEPERATED BY COMMAS.
   773                                  ;
   774                                  ; A FORMAT IS A POUND SIGN FOLLOWED BY A NUMBER. IT CONTROLS THE
   775                                  ; NUMBER OF SPACES THE VALUE OF AN EXPRESSION IS TO BE PRINTED.
   776                                  ; TED. IT STAYS EFFECTIVE FOR THE REST OF THE PRINT, UNLESS
   777                                  ; CHANGED BY ANOTHER FORMAT. IF NO FORMAT SPEC, 6 POSITIONS
   778                                  ; WILL BE USED.
   779                                  ;
   780                                  ; A STRING IS QUOTED IN A PAIR OF SINGLE QUOTES OR DOUBLE
   781                                  ; QUOTES.
   782                                  ;
   783                                  ; A BACK-ARROW MEANS GENERATE A (CR) WITHOUT (LF).
   784                                  ;
   785                                  ; A (CRLF) IS GENERATED AFTER THE ENTIRE LIST HAS BEEN PRINT OR
   786                                  ; IF THE LIST IS A NULL LIST. HOWEVER IF THE LIST ENDED WITH A
   787                                  ; COMMA, NO (CR) IS GENERATED.
   788                                  ;
   789                                  ;
   790                                  LIST:
   791 000003EE E808FD                   	CALL TSTNUM ;TEST IFF THERE IS A #
   792 000003F1 E8C504                   	CALL ENDCHK ;IFF NO # WE GET A 0
   793 000003F4 E85105                   	CALL FNDLN ;FIND THIS OR NEXT LINE
   794                                  LS1:
   795 000003F7 7303                     	JNC LS2 ;C: PASSED TXTUNF
   796 000003F9 E941FC                          JMP     RSTART
   797 000003FC E80306                  LS2: 	CALL PRTLN ;PRINT THE LINE
   798 000003FF E8B806                  	CALL CHKIO ;SEE IF ^X OR ^C
   799 00000402 E84D05                   	CALL FNDLNP ;FIND NEXT LINE
   800 00000405 EBF0                     	jmp LS1 ;LOOP BACK
   801                                   ;
   802                                  ;
   803                                  EDIT:
   804 00000407 E8EFFC                   	CALL TSTNUM ;TEST IF THERE IS A #
   805 0000040A E8AC04                   	CALL ENDCHK ;AT END?
   806 0000040D E83805                   	CALL FNDLN ;FIND SPEC LINE OR NEXT LINE
   807 00000410 52                       	PUSH DX ;SAVE LINE #
   808 00000411 7304                     	JNC ED2 ;C: PASSED TXTUNF
   809 00000413 5A                       	POP DX ;THROW AWAY LINE #
   810 00000414 E926FC                  ED1: 	JMP RSTART
   811                                  ED2:
   812 00000417 E8E805                   	CALL PRTLN ;PRINT THE LINE
   813 0000041A 5A                       	POP DX ;GET LINE # BACK
   814 0000041B C606[FD0A]00             	MOV byte [OCSW],0 ;DIRECT OUTPUT TO BUFFER
   815 00000420 C606[3720]00             	MOV byte [BUFCNT],0 ;CLEAR CHAR COUNT
   816 00000425 C606[0A0A]04             	MOV byte [PRTLN1+1],4 ;PRINT ONE LESS SPACE
   817 0000042A BF[3820]                	MOV DI,BUFFER ;PREPARE TO MOVE
   818 0000042D E8D205                   	CALL PRTLN
   819 00000430 C606[FD0A]FF             	MOV byte [OCSW],0FFH ;REDIRECT OUTPUT TO CONSOLE
   820 00000435 FE0E[3720]               	DEC byte [BUFCNT] ;AVOID CR?
   821 00000439 C606[0A0A]05             	MOV byte [PRTLN1+1],5 ;RESTORE PRTLN
   822 0000043E E91CFC                   	JMP _ST3 ;PROMPT AND GETLINE ONLY
   823                                  PRINT:
   824 00000441 B106                     	MOV CL,6 ;C:= # OF SPACES
   825 00000443 B43B                     	MOV AH,';' ;CHECK FOR ';' IN IGNBLNK
   826 00000445 E89B06                   	CALL IGNBLNK ;IGNORE BLANKS
   827 00000448 7506                     	JNZ PR2 ;JUMP IF ';' NOT FOUND
   828 0000044A E83906                   	CALL CRLF ;GIVE CR,LF AND
   829 0000044D E95AFE                   	JMP RUNSML ;CONTINUE SAME LINE
   830                                  PR2:
   831 00000450 B40D                     	MOV AH,0DH
   832 00000452 E88E06                   	CALL IGNBLNK
   833 00000455 7506                     	JNZ PR0
   834 00000457 E82C06                   	CALL CRLF ;ALSO GIVE CRLF AND
   835 0000045A E938FE                   	JMP RUNNXL ;GOTO NEXT LINE
   836                                  PR0:
   837 0000045D B423                     	MOV AH,'#'
   838 0000045F E88106                   	CALL IGNBLNK
   839 00000462 7507                     	JNZ PR1
   840 00000464 E8EB01                   	CALL EXP ;YES, EVALUATE EXPR
   841 00000467 88D9                     	MOV CL,BL ;AND SAVE IT IN C
   842 00000469 EB05                     	jmp  PR3 ;LOOK FOR MORE TO PRINT
   843                                  PR1:
   844 0000046B E81605                   	CALL QTSTG ;OR IS IT A STRING?
   845 0000046E EB12                     	jmp PR8 ;IFF NOT, MUST BE EXPRESSION
   846                                  PR3:
   847 00000470 B42C                     	MOV AH,','
   848 00000472 E86E06                   	CALL IGNBLNK
   849 00000475 7505                     	JNZ PR6
   850 00000477 E82804                   	CALL FIN ;IN THE LIST
   851 0000047A EBE1                     	jmp PR0 ;LIST CONTINUES
   852                                  PR6:
   853 0000047C E80706                   	CALL CRLF ;LIST ENDS
   854 0000047F E87306                   	CALL FINISH
   855                                  PR8:
   856 00000482 E8CD01                   	CALL EXP ;EVAL THE EXPR
   857 00000485 51                       	PUSH CX
   858 00000486 E83105                   	CALL PRTNUM ;PRINT THE VALUE
   859 00000489 59                       	POP CX
   860 0000048A EBE4                     	jmp PR3 ;MORE TO PRINT?
   861                                  ;
   862                                  ;
   863                                  ; ****GOSUB**** AND ****RETURN****
   864                                  ;
   865                                  ; 'GOSUB (EXPR);' OR 'GOSUB EXPR(CR)' IS LIKE THE 'GOTO' COMMAND
   866                                  ; EXCEPT THAT THE CURRENT TEXT POINTER, STACK POINTER ETC.   ARE
   867                                  ; SAVED SO THAT EXECUTION CAN BE CONTINUED AFTER THE  SUBROUTINE
   868                                  ; 'RETURN'. IN ORDER THAT 'GOSUB' CAN BE NESTED (AND EVEN RECUR-
   869                                  ; SIVE), THE SAVE AREA MUST BE  STACKED.  THE  STACK  POINTER IS
   870                                  ; SAVED IN 'STKGOS'. THE OLD 'STKGOS' IS SAVED IN THE STACK. IF
   871                                  ; WE ARE IN THE MAIN ROUTINE, 'STKGOS' IS ZERO (THIS WAS DONE BY
   872                                  ; THE "MAIN" SECTION OF THE CODE),  BUT  WE  STILL  SAVE  IT  AS
   873                                  ; A FLAG FOR NO FURTHER RETURNS.
   874                                  ;
   875                                  ; 'RETURN(CR)' UNDOES EVERYTHING THAT 'GOSUB' DID, AND THUS  RE-
   876                                  ; TURNS THE EXECUTION TO THE COMMAND AFTER THE MOST RECENT  'GO-
   877                                  ; SUB'. IFF 'STKGOS' IS ZERO, IT INDICATES THAT WE NEVER  HAD  A
   878                                  ; 'GOSUB' AND IS THUS AN ERROR.
   879                                  ;
   880                                  ;
   881                                  GOSUB:
   882 0000048C E8C605                   	CALL _pusha ;SAVE THE CURRENT 'FOR'
   883 0000048F E8C001                   	CALL EXP ;PARAMETERS
   884 00000492 52                       	PUSH DX
   885 00000493 E8B204                   	CALL FNDLN ;FIND THE TARGET LINE
   886 00000496 7403                     	JZ GS1 ;NOT THERE, SAY "HOW?"
   887 00000498 E995FC                          JMP     AHOW
   888 0000049B 8B1E[FE0A]              GS1: 	MOV BX,[CURRNT] ;FOUND IT, SAVE OLD
   889 0000049F 53                       	PUSH BX ;'CURRNT' OLD 'STKGOS'
   890 000004A0 8B1E[000B]              	MOV BX,[STKGOS]
   891 000004A4 53                       	PUSH BX
   892 000004A5 BB0000                   	MOV BX,0 ;AND LOAD NEW ONES
   893 000004A8 891E[060B]               	MOV [LOPVAR],BX
   894 000004AC 01E3                     	ADD BX,SP
   895 000004AE 891E[000B]               	MOV [STKGOS],BX
   896 000004B2 E9EBFD                   	JMP RUNTSL ;THEN RUN THAT LINE
   897                                  RETURN:
   898 000004B5 E80104                   	CALL ENDCHK ;THERE MUST BE A 0DH
   899 000004B8 8B1E[000B]               	MOV BX,[STKGOS] ;OLD STACK POINTER
   900 000004BC 09DB                     	OR BX,BX
   901 000004BE 7503                     	JNZ RET1 ;SO, WE SAY: "WHAT?"
   902 000004C0 E9FD03                          JMP     QWHAT
   903 000004C3 87DC                    RET1: 	XCHG BX,SP  ;ELSE RESTORE IT
   904 000004C5 5B                       	POP BX ;ELSE RESTORE IT
   905 000004C6 891E[000B]               	MOV [STKGOS],BX ;AND THE OLD 'STKGOS'
   906 000004CA 5B                       	POP BX
   907 000004CB 891E[FE0A]               	MOV [CURRNT],BX ;AND THE OLD 'CURRNT'
   908 000004CF 5A                       	POP DX ;OLD TEXT POINTER
   909 000004D0 E86205                   	CALL _popa ;OLD "FOR" PARAMETERS
   910 000004D3 E81F06                   	CALL FINISH ;AND WE ARE BACK HOME
   911                                  ;
   912                                  ;
   913                                  ; ****FOR**** AND ****NEXT****
   914                                  ;
   915                                  ;
   916                                  ; 'FOR' HAS TWO FORMS:
   917                                  ; 'FOR VAR=EXP1 TO EXP2 STEP EXP3'
   918                                  ; 'FOR VAR=EXP1 TO EXP2'
   919                                  ; THE SECOND FORM MEANS THE SAME AS THE FIRST FORM WITH EXP3=1.
   920                                  ;
   921                                  ; TBI WILL FIND THE VARIABLE VAR AND SET ITS VALUE TO THE CUR-
   922                                  ; RENT VALUE OF EXP1. IT ALSO  EVALUATES  EXP2  AND  EXP3  AND
   923                                  ; SAVES ALL OF THESE TOGETHER  WITH  THE  TEXT  POINTER ETC IN
   924                                  ; THE 'FOR' SAVE AREA, WHICH CONSISTS OF 'LOPVAR',   'LOPINC',
   925                                  ; 'LOPLMT', 'LOPLN', AND 'LOPPT'. IFF THERE IS ALREADY   SOME-
   926                                  ; THING IN THE SAVE AREA (THIS IS  INDICATED  BY  A   NON-ZERO
   927                                  ; 'LOPVAR'), THEN THE OLD SAVE AREA IS SAVED IN THE STACK  BE-
   928                                  ; FORE THE NEW ONE OVERWRITES IT.
   929                                  ;
   930                                  ; TBI WILL THEN DIG IN THE  STACK  AND  FIND  OUT IFF     THIS
   931                                  ; SAME VARIABLE WAS USED IN  ANOTHER  CURRENTLY  ACTIVE    FOR
   932                                  ; LOOP. IT THAT IS THE CASE THEN THE OLD 'FOR'   LOOP IS   DE-
   933                                  ; IVATED (PURGED FROM THE STACK).
   934                                  ;
   935                                  ; 'NEXT VAR' SERVES AS THE LOGICAL (NOT NECESSARILLY PHYSICAL)
   936                                  ; END OF THE 'FOR' LOOP. THE CONTROL VARIABLE VAR. IS  CHECKED
   937                                  ; WITH THE 'LOPVAR'. IFF THEY ARE NOT THE SAME, TBI DIGGS   IN
   938                                  ; THE STACK TO FIND THE RIGHT ONE  AND  PURGES  ALL THOSE THAT
   939                                  ; DID NOT MATCH. EITHER WAY, TBI THEN ADDS THE 'STEP' TO  THAT
   940                                  ; VARIABLE AND CHECKS THE RESULT WITH THE LIMIT.  IFF  IT   IS
   941                                  ; WITHIN THE LIMIT, CONTROL LOOPS BACK TO THE COMMAND  FOLLOW-
   942                                  ; ING THE 'FOR'. IFF OUTSIDE THE LIMIT, THE SAVE AREA IS PURG-
   943                                  ; ED AND EXECUTION CONTINUES.
   944                                  ;
   945                                  ;
   946                                  FOR:
   947 000004D6 E87C05                   	CALL _pusha ;SAVE THE OLD SAVE AREA
   948 000004D9 E8AB03                   	CALL SETVAL ;SET THE CONTROL VAR.
   949 000004DC 4B                       	DEC BX
   950 000004DD 891E[060B]               	MOV [LOPVAR],BX ;SAVE TGAT
   951 000004E1 BB[1402]                 	MOV BX,TAB5-1 ;USE 'EXEC' TO LOOK
   952 000004E4 E958FD                   	JMP EXEC ;FOR THE WORD 'TO'
   953                                  FR1:
   954 000004E7 E86801                   	CALL EXP ;EVALUATE THE LIMIT
   955 000004EA 891E[0A0B]               	MOV [LOPLMT],BX ;SAVE THAT
   956 000004EE BB[1B02]                 	MOV BX,TAB6-1 ;USED 'EXEC' TO LOOK
   957 000004F1 E94BFD                   	JMP EXEC ;FOR THE WORD 'STEP'
   958                                  FR2:
   959 000004F4 E85B01                   	CALL EXP ;FOUND IT, GET STEP
   960 000004F7 EB03                     	jmp FR4 ;FOUND IT, GET STEP
   961                                  FR3:
   962 000004F9 BB0100                   	MOV BX,1 ;NOT FOUND, SET TO ONE
   963                                  FR4:
   964 000004FC 891E[080B]               	MOV [LOPINC],BX ;SAVE THAT TOO
   965                                  FR5:
   966 00000500 8B1E[FE0A]               	MOV BX,[CURRNT] ;SAVE CURRENT LINE #
   967 00000504 891E[0C0B]               	MOV [LOPLN],BX
   968 00000508 87D3                    	XCHG DX,BX ;AND TEXT POINTER
   969 0000050A 891E[0E0B]               	MOV [LOPPT],BX
   970 0000050E B90A00                   	MOV CX,10 ;DIG INTO STACK TO
   971 00000511 8B1E[060B]               	MOV BX,[LOPVAR] ;FIND 'LOPVAR'
   972 00000515 87D3                     	XCHG DX,BX
   973 00000517 89CB                     	MOV BX,CX ;BX:=10 NOW
   974 00000519 01E3                     	ADD BX,SP
   975 0000051B EB02                     	jmp FR7A
   976                                  FR7:
   977 0000051D 01CB                     	ADD BX,CX
   978 0000051F 8B07                    FR7A: 	MOV AX,[BX] ;GET THAT OLD 'LOPVAR'
   979 00000521 09C0                     	OR AX,AX
   980 00000523 7417                     	JZ FR8 ;0 SAYS NO MORE IN IT
   981 00000525 39D0                     	CMP AX,DX ;SAME AS THIS ONE?
   982 00000527 75F4                     	JNZ FR7
   983 00000529 87D3                     	XCHG DX,BX
   984 0000052B BB0000                   	MOV BX,0 ;THE OTHER HALF?
   985 0000052E 01E3                     	ADD BX,SP
   986 00000530 89D9                     	MOV CX,BX
   987 00000532 BB0A00                   	MOV BX,10
   988 00000535 01D3                     	ADD BX,DX
   989 00000537 E8ED04                   	CALL MVDOWN ;AND PURGE 10 WORDS
   990 0000053A 87DC                     	XCHG BX,SP  ;IN THE STACK
   991                                  FR8:
   992 0000053C 8B1E[0E0B]               MOV BX,[LOPPT] ;JOB DONE, RESTORE DE
   993 00000540 87D3                     	XCHG DX,BX
   994 00000542 E8B005                   	CALL FINISH ;AND CONTINUE
   995                                   ;
   996                                  NEXT:
   997 00000545 E87CFB                   	CALL TSTV ;GET ADDR OF VAR
   998 00000548 7303                     	JNC NX4 ;NO VARIABLE, "WHAT?"
   999 0000054A E97303                          JMP     QWHAT
  1000 0000054D 891E[020B]              NX4: 	MOV [VARNXT],BX ;YES, SAVE IT
  1001                                  NX0:
  1002 00000551 52                       	PUSH DX ;SAVE TEXT POINTER
  1003 00000552 87D3                     	XCHG DX,BX
  1004 00000554 8B1E[060B]               	MOV BX,[LOPVAR] ;GET VAR IN 'FOR'
  1005 00000558 88F8                     	MOV AL,BH
  1006 0000055A 08D8                     	OR AL,BL ;0 SAY NEVER HAD ONE
  1007 0000055C 7503                     	JNZ NX5 ;SO WE ASK: "WHAT?"
  1008 0000055E E96003                          JMP     AWHAT
  1009 00000561 39DA                    NX5: 	CMP DX,BX ;ELSE WE CHECK THEM
  1010 00000563 740A                     	JZ NX3 ;OK, THEY AGREE
  1011 00000565 5A                       	POP DX ;NO, LET'S SEE
  1012 00000566 E8CC04                   	CALL _popa ;PURGE CURRENT LOOP
  1013 00000569 8B1E[020B]               	MOV BX,[VARNXT] ;AND POP ONE LEVEL
  1014 0000056D EBE2                     	JMP NX0 ;GO CHECK AGAIN
  1015                                  NX3:
  1016 0000056F 8A17                     	MOV DL,[BX] ;COME HERE WHEN AGREED
  1017 00000571 43                       	INC BX
  1018 00000572 8A37                     	MOV DH,[BX] ;DE = VAL OF VAR
  1019 00000574 8B1E[080B]               	MOV BX,[LOPINC]
  1020 00000578 53                       	PUSH BX
  1021 00000579 01D3                     	ADD BX,DX
  1022 0000057B 87D3                     	XCHG DX,BX ;ADD ONE STEP
  1023 0000057D 8B1E[060B]               	MOV BX,[LOPVAR] ;PUT IT BACK
  1024 00000581 8817                     	MOV [BX],DL
  1025 00000583 43                       	INC BX
  1026 00000584 8837                     	MOV [BX],DH
  1027 00000586 8B1E[0A0B]               	MOV BX,[LOPLMT] ;HL-> LIMIT
  1028 0000058A 58                       	POP AX
  1029 0000058B 86E0                     	XCHG AH,AL
  1030 0000058D 09C0                     	OR AX,AX
  1031 0000058F 7902                     	JNS NX1 ;STEP > 0
  1032 00000591 87D3                     	XCHG DX,BX
  1033                                  NX1:
  1034 00000593 E8E602                   	CALL CKHLDE ;COMPARE WITH LIMIT
  1035 00000596 5A                       	POP DX ;RESTORE TEXT POINTER
  1036 00000597 7211                     	JC NX2 ;OUTSIDE LIMIT
  1037 00000599 8B1E[0C0B]               	MOV BX,[LOPLN] ;WITHIN LIMIT, GO
  1038 0000059D 891E[FE0A]               	MOV [CURRNT],BX ;BACK TO THE SAVED
  1039 000005A1 8B1E[0E0B]               	MOV BX,[LOPPT] ;'CURRNT' AND TEXT
  1040 000005A5 87D3                     	XCHG DX,BX ;POINTER
  1041 000005A7 E84B05                   	CALL FINISH ;POINTER
  1042                                  NX2:
  1043 000005AA E88804                   	CALL _popa ;PURGE THIS LOOP
  1044 000005AD E84505                   	CALL FINISH
  1045                                  ;
  1046                                  ;
  1047                                  ; ****REM**** AND ****IF**** AND ****LET*****
  1048                                  ;
  1049                                  ;
  1050                                  ; 'REM' CAN BE FOLLOWED BY ANYTHING AND IS IGNORED BY TBI. TBI
  1051                                  ; TREATS IT LIKE AN 'IF' WITH A FALSE CONDITION.
  1052                                  ;
  1053                                  ; 'IF' IS FOLLOWED BY AN EXPR. AS A CONDITION AND ONE OR  MORE
  1054                                  ; COMMANDS (INCLUDING OTHER 'IF'S) SEPERATED  BY  SEMI-COLONS.
  1055                                  ; NOTE THAT THE WORD 'THEN' IS NOT USED.  TBI  EVALUATES   THE
  1056                                  ; EXPR. IFF IT IS NON-ZERO, EXECUTION CONTINUES. IFF THE EXPR.
  1057                                  ; IS ZERO, THE COMMANDS THAT FOLLOW ARE IGNORED AND  EXECUTION
  1058                                  ; CONTINUES AT THE NEXT LINE.
  1059                                  ;
  1060                                  ; 'IPUT' COMMANS IS LIKE THE 'PRINT' COMMAND, AND IS  FOLLOWED
  1061                                  ; BY A LIST OF ITEMS. IFF THE ITEM IS A  STRING  IN  SINGLE OR
  1062                                  ; DOUBLE QUOTES, OR IS A BACK-ARROword  IT HAS THE SAME EFFEDT AS
  1063                                  ; PRINTED OUT FOLLOWED BY A COLON. THEN TBI WAITS FOR AN EXPR.
  1064                                  ; TO BE TYPEN IN. THE VARIABLE IS THEN  SET  TO  THE  VALUE OF
  1065                                  ; THIS EXPR. IFF THE VARIABLE IS PROCEDED BY A STRING  PRINTED
  1066                                  ; FOLLOWED BY A COLON. TBI THEN WAITS FOR INPUT EXPR. AND SETS
  1067                                  ; THE VARIABLE TO THE VALUE OF THE EXPR.
  1068                                  ;
  1069                                  ; IFF THE INPUT EXPR. IS INVALID,  TBI  WILL  PRINT  "WHAT?" ,
  1070                                  ; "HOW?",OR "SORRY" AND REPRINT THE PROMPT AND REDO THE INPUT.
  1071                                  ; THE EXECUTION WILL NOT TERMINATE UNLESS YOU TYPE CONTROL-C .
  1072                                  ; THIS IS HANDLED IN 'INPERR'.
  1073                                  ;
  1074                                  ; 'LET' IS FOLLOWED BY A LIST OF ITEMS SEPERATED  BY  COMMAS .
  1075                                  ; EACH ITEM CONSISTS OF A VARIABLE,  AN  EQUAL  SIGN,  AND  AN
  1076                                  ; EXPR. TBI EVALUATES THE EXPR. AND SETS THE VARIABLE TO  THAT
  1077                                  ; VALUE. TBI WILL ALSO HANDLE 'LET' COMMAND WITHOUT THE   WORD
  1078                                  ; 'LET'. THIS IS DONE BY 'DEFLT'.
  1079                                  ;
  1080                                  ;
  1081                                  ;
  1082                                  REM:
  1083 000005B0 BB0000                   	MOV BX,0 ;****REM****
  1084 000005B3 EB03                     	jmp IFF1A ;JUMP AROUND EXPR
  1085                                   ;
  1086                                  IFF:
  1087 000005B5 E89A00                   	CALL EXP ;****IF****
  1088 000005B8 83FB00                  IFF1A: 	CMP BX,0 ;IS THE EXPR = 0?
  1089 000005BB 7403                     	JZ IFF1 ;NO, CONTINUE
  1090 000005BD E9EAFC                          JMP     RUNSML
  1091 000005C0 E8A403                  IFF1: 	CALL FNDSKP ;YES, SIKP REST OF LINE
  1092 000005C3 7203                     	JC IFF2 ;YES, SIKP REST OF LINE
  1093 000005C5 E9D8FC                          JMP     RUNTSL
  1094 000005C8 E972FA                  IFF2: 	JMP RSTART ;YES, SIKP REST OF LINE
  1095                                   ;
  1096                                  INPERR:
  1097 000005CB 8B1E[040B]               	MOV BX,[STKINP] ;****INPERR****
  1098 000005CF 87DC                     	XCHG BX,SP  ;RESTORE OLD STACK POINTER
  1099 000005D1 5B                       	POP BX ;AND OLD 'CURRNT'
  1100 000005D2 891E[FE0A]               	MOV [CURRNT],BX
  1101 000005D6 5A                       	POP DX
  1102 000005D7 5A                       	POP DX ;REDO INPUT
  1103                                   ;
  1104                                  INPUT: 	EQU $ ;****INPUT****
  1105                                  IP1:
  1106 000005D8 52                       	PUSH DX ;SAVE IN CASE OF ERROR
  1107 000005D9 E8A803                   	CALL QTSTG ;IS NEXT ITEM A STRING?
  1108 000005DC EB07                     	jmp IP2 ;NO
  1109 000005DE E8E3FA                   	CALL TSTV ;YES, BUT FOLLOWED BY A
  1110 000005E1 724C                     	JC IP4 ;VARIABLE? NO.
  1111 000005E3 EB1D                     	jmp IP3 ;YES. INPUT VAR.
  1112                                  IP2:
  1113 000005E5 52                       	PUSH DX ;SAVE FOR 'PRTSTG'
  1114 000005E6 E8DBFA                   	CALL TSTV ;MUST BE A VAR NOW
  1115 000005E9 7303                     	JNC IP2A ;"WHAT" IT IS NOT!
  1116 000005EB E9D202                          JMP     QWHAT
  1117 000005EE 89D6                    IP2A: MOV SI,DX
  1118 000005F0 AC                       	lodsb  ;GET READY FOR 'RTSTG'
  1119 000005F1 88C1                     	MOV CL,AL
  1120 000005F3 28C0                     	SUB AL,AL
  1121 000005F5 89D7                     	MOV DI,DX
  1122 000005F7 AA                       	stosb
  1123 000005F8 5A                       	POP DX
  1124 000005F9 E87503                   	CALL PRTSTG ;PRINT STRING AS PROMPT
  1125 000005FC 88C8                     	MOV AL,CL
  1126 000005FE 4A                       	DEC DX
  1127 000005FF 89D7                     	MOV DI,DX
  1128 00000601 AA                       	stosb
  1129                                  IP3:
  1130 00000602 52                       	PUSH DX
  1131 00000603 87D3                     	XCHG DX,BX
  1132 00000605 8B1E[FE0A]               	MOV BX,[CURRNT] ;ALSO SAVE 'CURRNT'
  1133 00000609 53                       	PUSH BX
  1134 0000060A BB[D805]                 	MOV BX,IP1
  1135 0000060D 891E[FE0A]               	MOV [CURRNT],BX ;NEG NUMBER AS FLAG
  1136 00000611 8926[040B]               	MOV [STKINP],SP
  1137 00000615 52                       	PUSH DX ;OLD HL
  1138 00000616 B03A                     	MOV AL,':' ;PRINT THIS TOO
  1139 00000618 E8E902                   	CALL GETLN ;AND GET A LINE
  1140                                  IP3A:
  1141 0000061B BA[3820]                 	MOV DX,BUFFER ; POINTS TO BUFFER
  1142 0000061E E83100                   	CALL EXP ;EVALUATE INPUT
  1143 00000621 90                       	NOP         ;CAN BE 'CALL ENDCHK'
  1144 00000622 90                      	NOP   ;CAN BE 'CALL ENDCHK'
  1145 00000623 90                       	NOP   ;CAN BE 'CALL ENDCHK'
  1146 00000624 5A                       	POP DX ;OK,GET OLD HL
  1147 00000625 87D3                     	XCHG DX,BX ;OK,GET OLD HL
  1148 00000627 8917                     	MOV [BX],DX
  1149 00000629 5B                       	POP BX ;GET OLD 'CURRNT'
  1150 0000062A 891E[FE0A]               	MOV [CURRNT],BX
  1151 0000062E 5A                       	POP DX ;AND GET OLD TEXT POINTER
  1152                                  IP4:
  1153 0000062F 58                       	POP AX
  1154 00000630 B42C                     	MOV AH,','
  1155 00000632 E8AE04                   	CALL IGNBLNK
  1156 00000635 7502                     	JNZ IP5
  1157 00000637 EB9F                     	jmp IP1 ;YES, MORE ITEMS
  1158                                  IP5:
  1159 00000639 E8B904                   	CALL FINISH
  1160                                   ;
  1161                                  DEFLT:
  1162 0000063C 89D6                     	MOV SI,DX
  1163 0000063E AC                       	lodsb ;****DEFLT****
  1164 0000063F 3C0D                     	CMP AL,0DH ;EMPTY LINE IS OK
  1165 00000641 740C                     	JZ LT1 ;ELSE IT IS 'LET'
  1166                                   ;
  1167                                  LET:
  1168 00000643 E84102                   	CALL SETVAL ;****LET****
  1169 00000646 B42C                     	MOV AH,','
  1170 00000648 E89804                   	CALL IGNBLNK
  1171 0000064B 7502                     	JNZ LT1
  1172 0000064D EBF4                     	jmp LET ;ITEM BY ITEM
  1173                                  LT1:
  1174 0000064F E8A304                   	CALL FINISH ;UNTIL FINISH
  1175                                  ;
  1176                                  ;
  1177                                  ; ****EXPR****
  1178                                  ;
  1179                                  ; 'EXPR' EVALUATES ARITHMETICAL OR LOGICAL EXPRESSIONS.
  1180                                  ; <EXPR>::=<EXPR2>
  1181                                  ;    <EXPR2><REL.OP><EXPR2>
  1182                                  ;
  1183                                  ; WHERE <REL.OP> IS ONE OF THE OPERATORS IN TAB8 AND THE RE-
  1184                                  ; SULT OF THESE OPERATIONS IS 1 IFF TRUE AND  0  IFF  FALSE.
  1185                                  ;
  1186                                  ; <EXPR2>::=(+ OR -)<EXPR3>(+ OR -<EXPR3>(....)
  1187                                  ;
  1188                                  ; WHERE () ARE OPTIONAL AND (....) ARE OPTIONAL REPEATS.
  1189                                  ;
  1190                                  ; <EXPR3>::=<EXPR4>(<* OR /><EXPR4>)(....)
  1191                                  ; <EXPR4>::=<VARIABLE>
  1192                                  ;   <FUNCTION>
  1193                                  ;   (<EXPR>)
  1194                                  ;
  1195                                  ; <EXPR> IS RECURSIVE SO THAT VARIABLE '@' CAN HAVE AN EXPR
  1196                                  ; AS INDEX, FUCTIONS CAN HAVE AN <EXPR> AS ARGUMENTS,   AND
  1197                                  ; <EXPR4> CAN BE AN <EXPR> IN PARANTHESES.
  1198                                  ;
  1199                                  ;
  1200 00000652 E85A00                  EXP:	CALL EXPR2
  1201 00000655 53                       	PUSH BX
  1202                                  EXPR1:
  1203 00000656 BB[2402]                 	MOV BX,TAB8-1 ;LOOKUP REL.OP
  1204 00000659 E9E3FB                   	JMP EXEC ;GO DO IT
  1205                                  XP11:
  1206 0000065C E83500                   	CALL XP18
  1207 0000065F 720A                     	JC RET4 ;NO RETURN HL=0
  1208 00000661 88C3                     	MOV BL,AL ;YES, RETURN HL=1
  1209 00000663 C3                       	RET
  1210                                  XP12:
  1211 00000664 E82D00                   	CALL XP18
  1212 00000667 7402                     	JZ RET4 ;FALSE, RETURN HL=0
  1213 00000669 88C3                     	MOV BL,AL ;TRUE, RETURN HL=1
  1214                                  RET4:
  1215 0000066B C3                       	RET
  1216                                  XP13:
  1217 0000066C E82500                   	CALL XP18 ;REL.OP '>'
  1218 0000066F 7404                     	JZ RET5 ;FALSE
  1219 00000671 7202                     	JC RET5 ;ALSO FALSE, HL=0
  1220 00000673 88C3                     	MOV BL,AL ;TRUE, HL=1
  1221                                  RET5:
  1222 00000675 C3                       	RET
  1223                                  XP14:
  1224 00000676 E81B00                   	CALL XP18 ;REL OP '<='
  1225 00000679 88C3                     	MOV BL,AL ;SET HL=1
  1226 0000067B 7404                     	JZ RET6 ;REL. TRUE, RETURN
  1227 0000067D 7202                     	JC RET6 ;REL. TRUE, RETURN
  1228 0000067F 88FB                     	MOV BL,BH ;ELSE SET HL=0
  1229                                  RET6:
  1230 00000681 C3                       	RET
  1231                                  XP15:
  1232 00000682 E80F00                   	CALL XP18 ;REL OP '='
  1233 00000685 7502                     	JNZ RET7 ;FALSE, RETURN HL=0
  1234 00000687 88C3                     	MOV BL,AL ;ELSE SET HL=1
  1235                                  RET7:
  1236 00000689 C3                       	RET
  1237                                  XP16:
  1238 0000068A E80700                   	CALL XP18 ;REL.OP '<'
  1239 0000068D 7302                     	JNC RET8 ;FALSE, RETURN HL=0
  1240 0000068F 88C3                     	MOV BL,AL ;ELSE SET HL=1
  1241                                  RET8:
  1242 00000691 C3                       	RET
  1243                                  XP17:
  1244 00000692 5B                       	POP BX ;NOT REL OP
  1245 00000693 C3                       	RET ;RETURN HL=<EPTR2>
  1246                                  XP18:
  1247 00000694 88C8                     	MOV AL,CL ;SUBROUTINE FOR ALL
  1248 00000696 5B                       	POP BX ;REL.OP'S
  1249 00000697 59                       	POP CX ;REL.OP'S
  1250 00000698 53                       	PUSH BX ;REVERSE TOP OF STACK
  1251 00000699 51                       	PUSH CX ;REVERSE TOP OF STACK
  1252 0000069A 88C1                     	MOV CL,AL
  1253 0000069C E81000                   	CALL EXPR2 ;GET 2ND EXPRESSION
  1254 0000069F 87D3                     	XCHG DX,BX ;VALUE IN DE NOW
  1255 000006A1 58                       	POP AX
  1256 000006A2 53                       	PUSH BX
  1257 000006A3 89C3                     	MOV BX,AX ;LAST 3 INSTR FOR XTHL INST!
  1258 000006A5 E8D401                   	CALL CKHLDE ;COMPARE 1ST WITH SECOND
  1259 000006A8 5A                       	POP DX
  1260 000006A9 BB0000                   	MOV BX,0 ;SET HL=0, A=1
  1261 000006AC B001                     	MOV AL,1 ;SET HL=0, A=1
  1262                                  
  1263 000006AE C3                       	RET
  1264                                   ;
  1265                                  EXPR2:
  1266 000006AF B42D                     	MOV AH,'-'
  1267 000006B1 E82F04                   	CALL IGNBLNK ;NEGATIVE SIGN?
  1268 000006B4 7505                     	JNZ XP21
  1269 000006B6 BB0000                   	MOV BX,0 ;YES, FAKE '0-'
  1270 000006B9 EB28                     	jmp XP26 ;TREAT LIKE SUBTRACT
  1271                                  XP21:
  1272 000006BB B42B                     	MOV AH,'+' ;POSITIVE SIGN?
  1273 000006BD E82304                   	CALL IGNBLNK
  1274                                  XP22:
  1275 000006C0 E82900                   	CALL EXPR3 ;1ST <EXPR3>
  1276                                  XP23:
  1277 000006C3 B42B                     	MOV AH,'+'
  1278 000006C5 E81B04                   	CALL IGNBLNK ;ADD?
  1279 000006C8 7512                     	JNZ XP25 ;NOTE OFFSET WHAS 21 BYTES IN 8080 VERSION
  1280 000006CA 53                       	PUSH BX ;YES, SAVE VALUE
  1281 000006CB E81E00                   	CALL EXPR3 ;GET 2ND <EXPR3>
  1282                                  XP24:
  1283 000006CE 87D3                     	XCHG DX,BX ;2ND IN DE
  1284 000006D0 58                       	POP AX ;THIS + NEXT 2 LINES FOR 8080 XTHL INST!!
  1285 000006D1 53                       	PUSH BX
  1286 000006D2 89C3                     	MOV BX,AX ;BX <-> [SP] NOW, [SP]->BUFFER,BX=OLD EXPR3
  1287 000006D4 01D3                     	ADD BX,DX
  1288 000006D6 5A                       	POP DX
  1289 000006D7 71EA                     	JNO XP23 ;CHECK FOR OVERFLOW
  1290 000006D9 E953FA                  XP24A: 	JMP QHOW ;ELSE WE HAVE OVERFLOW
  1291                                  XP25:
  1292 000006DC B42D                     	MOV AH,'-'
  1293 000006DE E80204                   	CALL IGNBLNK ;SUBTRACT?
  1294 000006E1 755A                     	JNZ RET9
  1295 000006E3 53                      XP26: 	PUSH BX ;YES, SAVE 1ST <EXPR3>
  1296 000006E4 E80500                   	CALL EXPR3 ;GET 2ND <EXPR3>
  1297 000006E7 E88B01                   	CALL CHGSGN
  1298 000006EA EBE2                     	jmp XP24
  1299                                   ;
  1300                                  EXPR3:
  1301 000006EC E83A00                   	CALL 	EXPR4 		;GET 1ST <EXPR4>
  1302                                  XP31:
  1303 000006EF B42A                     	MOV 	AH,'*'
  1304 000006F1 E8EF03                   	CALL 	IGNBLNK 	;MULTIPLY?
  1305 000006F4 7510                     	JNZ 	XP34
  1306 000006F6 53                       	PUSH 	BX 		;YES, SAVE 1ST
  1307 000006F7 E82F00                   	CALL 	EXPR4 		;AND GET 2ND <EXPR4>
  1308 000006FA 87D3                     	XCHG 	DX,BX 		;2ND IN DE NOW
  1309 000006FC 58                       	POP 	AX 		;SUBSITUTE FOR 8080 XTHL
  1310 000006FD 53                       	PUSH 	BX
  1311 000006FE F7EA                    	IMUL 	DX 		;AX:=AX*DX
  1312 00000700 7019                     	JO 	XP32 		;SEE INTEL BOOK ON OVERFLOW FLAG
  1313 00000702 89C3                     	MOV 	BX,AX 		;RESULT NOW IN BX
  1314 00000704 EB20                     	jmp 	XP35 		;LOOK FOR MORE
  1315                                  XP34:
  1316 00000706 B42F                     	MOV AH,'/'
  1317 00000708 E8D803                   	CALL IGNBLNK ;DIVIDE?
  1318 0000070B 7530                     	JNZ RET9
  1319 0000070D 53                       	PUSH BX ;YES, SAVE 1ST <EXPR4>
  1320 0000070E E81800                   	CALL EXPR4 ;AND GET SECOND ONE
  1321 00000711 87D3                     	XCHG DX,BX ;PUT 2ND IN DE
  1322 00000713 58                       	POP AX ;REPLACEMENT FOR XTHL
  1323 00000714 53                       	PUSH BX
  1324 00000715 89C3                     	MOV BX,AX
  1325 00000717 09D2                     	OR DX,DX
  1326 00000719 7503                     	JNZ XP34A ;SAY "HOW?"
  1327 0000071B E912FA                  XP32: 	JMP AHOW
  1328 0000071E E84101                  XP34A: 	CALL DIVIDE ;USE SUBROUTINE
  1329 00000721 89CB                     	MOV BX,CX ;GET RESULT
  1330 00000723 B90600                  	MOV CX,6 ;SIX SPACES
  1331                                  XP35:
  1332 00000726 5A                       	POP DX ;AND TEXT POINTER
  1333 00000727 EBC6                     	jmp XP31 ;LOOK FOR MORE TERMS
  1334                                   ;
  1335                                  EXPR4:
  1336 00000729 BB[F101]                 	MOV BX,TAB4-1 ;FIND FUCNTION IN TAB4
  1337 0000072C E910FB                   	JMP EXEC ;AND GOT DO IT
  1338                                  XP40:
  1339 0000072F E892F9                   	CALL TSTV ;NO, NOT A FUNCTION
  1340 00000732 720A                     	JC XP41 ;NOR A VARIABLE
  1341 00000734 8A07                     	MOV AL,[BX] ;VARIABLE
  1342 00000736 9F                       	LAHF
  1343 00000737 43                       	INC BX
  1344 00000738 9E                       	SAHF
  1345 00000739 8A3F                     	MOV BH,[BX] ;VALUE IN HL
  1346 0000073B 88C3                     	MOV BL,AL ;VALUE IN HL
  1347                                  RET9:
  1348 0000073D C3                       	RET
  1349                                  XP41:
  1350 0000073E E8B8F9                   	CALL TSTNUM ;OR IS IT A NUMBER?
  1351 00000741 88E8                     	MOV AL,CH ;# OF DIGITS
  1352 00000743 08C0                     	OR AL,AL
  1353 00000745 7511                     	JNZ XP42 ;OK
  1354                                  PARN:
  1355 00000747 B428                     	MOV AH,'('
  1356 00000749 E89703                   	CALL IGNBLNK ;NO DIGIT, MUST BE
  1357 0000074C 7503                     	JNZ PARN1
  1358 0000074E E801FF                   	CALL EXP ;"(EXPR)"
  1359 00000751 B429                    PARN1: 	MOV AH,')'
  1360 00000753 E88D03                   	CALL IGNBLNK ;"(EXPR)"
  1361 00000756 7501                     	JNZ XP43 ;******WHY CHECK THIS?******
  1362                                  XP42:
  1363 00000758 C3                       	RET
  1364                                  XP43:
  1365 00000759 E96401                   	JMP 	QWHAT 		;ELSE SAY: "WHAT?"
  1366                                   ;
  1367                                  RND:
  1368 0000075C E8E8FF                   	CALL 	PARN 		;****RND(EXPR)****
  1369 0000075F 09DB                     	OR 	BX,BX
  1370 00000761 7905                     	JNS 	RND1 		;MUST BE POSITIVE
  1371 00000763 7503                     	JNZ 	RND1 		;AND NON-ZERO
  1372 00000765 E9C7F9                          JMP     QHOW
  1373                                  RND1:
  1374 00000768 51                       	PUSH CX
  1375 00000769 52                       	PUSH DX
  1376                                  ; 	MOV 	AH,2CH 		;GET TIME
  1377                                  ; 	INT 	21h 		;ASK MS-DOS
  1378 0000076A B402                    	mov	ah,2		; call the BIOS RTC function
  1379 0000076C CD1A                    	int	1ah
  1380 0000076E B84701                   	MOV 	AX,327
  1381 00000771 B600                     	MOV 	DH,0
  1382                                  ; 	MUL 	AX,DX 		; 0<=AX<=32700
  1383 00000773 F7E2                     	mul 	dx
  1384 00000775 87D3                     	XCHG 	DX,BX
  1385 00000777 89C3                     	MOV 	BX,AX
  1386 00000779 E8E600                   	CALL 	DIVIDE 		;RND(N)=MOD(M,N)+1
  1387 0000077C 5A                       	POP 	DX
  1388 0000077D 59                      	POP 	CX
  1389 0000077E 43                       	INC 	BX
  1390 0000077F C3                       	RET
  1391                                   ;
  1392                                  ABSS:
  1393 00000780 E8C4FF                   	CALL PARN ;****ABS(EXPR)****
  1394 00000783 E8EB00                   	CALL CHKSGN ;CHECK SIGN
  1395 00000786 09D8                     	OR AX,BX
  1396 00000788 7910                     	JNS RET10 ;OK
  1397 0000078A E9A2F9                   	JMP QHOW ;SO SAY: "HOW?"
  1398                                  SIZE:
  1399 0000078D 8B1E[120B]               	MOV BX,[TXTUNF] ;****SIZE****
  1400 00000791 52                       	PUSH DX ;GET THE NUMBER OF FREE
  1401 00000792 87D3                     	XCHG DX,BX ;BYTES BETWEEN 'TXTUNF'
  1402                                  SIZEA:
  1403 00000794 BB[0020]                 	MOV BX,VARBGN ;AND 'VARBGN'
  1404 00000797 29D3                     	SUB BX,DX
  1405 00000799 5A                       	POP DX
  1406                                  RET10:
  1407 0000079A C3                       	RET
  1408                                  ;
  1409                                  ;
  1410                                  ; ****OUT**** AND ****INP**** AND ****WAIT**** AND
  1411                                  ; ****POKE**** AND ****PEEK**** AND ****USR****
  1412                                  ;
  1413                                  ;
  1414                                  ; 'OUT I,J(,K,L)'
  1415                                  ;
  1416                                  ; OUTPUTS EXPRESSION 'J' TO PORT 'I', AND MAY BE REPEATED AS
  1417                                  ; IN DATA 'L' TO PORT 'K' AS MANY TIMES AS NEEDED. THIS COM-
  1418                                  ; MAND MODIFIES *, A SMALL SECTION OF CODE ABOVE ADDRESS 2K.
  1419                                  ;
  1420                                  ; 'INP (I)'
  1421                                  ;
  1422                                  ; THIS FUNCTION RETURNDS DATA READ FROM  INPUT  PORT 'I'  AS
  1423                                  ; ITS VALUE. IT ALSO MODIFIES CODE JUST ABOVE 2K.
  1424                                  ;
  1425                                  ; 'WAIT I,J,K'
  1426                                  ;
  1427                                  ; THIS COMMAND READS THE STATUS OF PORT 'I', EXCLUSIVE  OR'S
  1428                                  ; THE RESULT WITH 'K', IF THE RESULT IS ONE, OR IF NOT  WITH
  1429                                  ; ZERO, AND'S WITH 'J' AND RETURNS WHEN THE RESULT IS   NON-
  1430                                  ; ZERO. ITS MODIFIED CODE IS ALSO ABOVE 2K.
  1431                                  ;
  1432                                  ; 'POKE I,J(,K,L)
  1433                                  ;
  1434                                  ; THIS COMMAND WORKS LIKE OUT EXCEPT THAT IT PUTS  DATA  'J'
  1435                                  ; INTO MEMORY LOCATION 'I'.
  1436                                  ;
  1437                                  ; 'PEEK (I)'
  1438                                  ;
  1439                                  ; THIS FUNCTION WORKS LIKE INP EXCEPT THAT IT PUTS DATA  'J'
  1440                                  ; FROM MEMORY LOCATION 'I'.
  1441                                  ;
  1442                                  ; 'USR(I(,J))'
  1443                                  ;
  1444                                  ; USR CALL A MACHINE LANGUAGE SUBROUTINE AT LOCATION 'I'  IF
  1445                                  ; THE OPTIONAL PARAMETER 'J' IS USED ITS VALUE IS PASSED  IN
  1446                                  ; HL. THE VALUE OF THE FUNCTION SHOULD BE RETURNED IN HL.
  1447                                  ;
  1448                                  ;
  1449                                  OUTCMD:
  1450 0000079B E8B4FE                   	CALL EXP
  1451 0000079E 88D8                     	MOV AL,BL
  1452 000007A0 A2[D10A]                 	MOV [OUTIO+1],AL
  1453 000007A3 B42C                     	MOV AH,','
  1454 000007A5 E83B03                   	CALL IGNBLNK
  1455 000007A8 7403                     	JZ OUT1 ;FOUND MORE TO WORK ON
  1456 000007AA E91301                   	JMP QWHAT
  1457 000007AD E8A2FE                  OUT1: 	CALL EXP
  1458 000007B0 88D8                     	MOV AL,BL
  1459 000007B2 E81B03                   	CALL OUTIO
  1460 000007B5 B42C                     	MOV AH,','
  1461 000007B7 E82903                   	CALL IGNBLNK
  1462 000007BA 7502                     	JNZ OUTCMD1
  1463 000007BC EBDD                     	jmp OUTCMD
  1464 000007BE E83403                  OUTCMD1:CALL FINISH
  1465                                  WAITCM:
  1466 000007C1 E88EFE                   	CALL EXP
  1467 000007C4 88D8                     	MOV AL,BL
  1468 000007C6 A2[D40A]                 	MOV [WAITIO+1],AL
  1469 000007C9 B42C                     	MOV AH,','
  1470 000007CB E81503                   	CALL IGNBLNK
  1471 000007CE 7403                     	JZ WT1
  1472 000007D0 E9ED00                   	JMP QWHAT
  1473 000007D3 E87CFE                  WT1: 	CALL EXP
  1474 000007D6 53                       	PUSH BX
  1475 000007D7 B42C                     	MOV AH,','
  1476 000007D9 E80703                   	CALL IGNBLNK
  1477 000007DC 750A                     	JNZ WAIT1
  1478 000007DE E871FE                   	CALL EXP
  1479 000007E1 88D8                     	MOV AL,BL
  1480 000007E3 5B                       	POP BX
  1481 000007E4 88C3                     	MOV BL,AL
  1482 000007E6 EB02                     	jmp WAIT2
  1483 000007E8 B700                    WAIT1: 	MOV BH,0
  1484 000007EA E9E602                  WAIT2: 	JMP WAITIO
  1485                                  INP:
  1486 000007ED E857FF                   	CALL PARN
  1487 000007F0 88D8                     	MOV AL,BL
  1488 000007F2 A2[DF0A]                 	MOV [INPIO+1],AL
  1489 000007F5 BB0000                   	MOV BX,0
  1490 000007F8 E9E302                   	JMP INPIO
  1491 000007FB EB63                     	jmp QWT
  1492                                  POKE:
  1493 000007FD E852FE                   	CALL EXP
  1494 00000800 53                       	PUSH BX
  1495 00000801 B42C                     	MOV AH,','
  1496 00000803 E8DD02                   	CALL IGNBLNK
  1497 00000806 7403                     	JZ POK1
  1498 00000808 E9B500                   	JMP QWHAT
  1499 0000080B E844FE                  POK1: 	CALL EXP
  1500 0000080E 88D8                     	MOV AL,BL
  1501 00000810 5B                       	POP BX
  1502 00000811 8807                     	MOV [BX],AL
  1503 00000813 B42C                     	MOV AH,','
  1504 00000815 E8CB02                   	CALL IGNBLNK
  1505 00000818 7502                     	JNZ POK2
  1506 0000081A EBE1                     	jmp POKE
  1507 0000081C E8D602                  POK2: 	CALL FINISH
  1508                                  PEEK:
  1509 0000081F E825FF                   	CALL PARN
  1510 00000822 8A1F                     	MOV BL,[BX]
  1511 00000824 B700                     	MOV BH,0
  1512 00000826 C3                       	RET
  1513 00000827 E99600                   	JMP QWHAT
  1514                                  USR:
  1515 0000082A 51                       	PUSH CX
  1516 0000082B B428                     	MOV AH,'('
  1517 0000082D E8B302                   	CALL IGNBLNK
  1518 00000830 752E                     	JNZ QWT
  1519 00000832 E81DFE                   	CALL EXP ;EXPR
  1520 00000835 B429                     	MOV AH,')'
  1521 00000837 E8A902                   	CALL IGNBLNK ;EXPR
  1522 0000083A 7507                     	JNZ PASPRM
  1523 0000083C 52                       	PUSH DX
  1524 0000083D BA[5D08]                 	MOV DX,USRET
  1525 00000840 52                       	PUSH DX
  1526 00000841 53                       	PUSH BX
  1527 00000842 C3                       	RET ;CALL USR ROUTINE
  1528                                  PASPRM:
  1529 00000843 B42C                     	MOV AH,','
  1530 00000845 E89B02                   	CALL IGNBLNK
  1531 00000848 7514                     	JNZ USRET1
  1532 0000084A 53                       	PUSH BX
  1533 0000084B E804FE                   	CALL EXP
  1534 0000084E B429                     	MOV AH,')'
  1535 00000850 E89002                   	CALL IGNBLNK
  1536 00000853 7509                     	JNZ USRET1
  1537 00000855 59                       	POP CX
  1538 00000856 52                       	PUSH DX
  1539 00000857 BA[5D08]                 	MOV DX,USRET
  1540 0000085A 52                       	PUSH DX
  1541 0000085B 51                       	PUSH CX
  1542 0000085C C3                       	RET ;CALL USR ROUTINE
  1543                                  USRET:
  1544 0000085D 5A                       	POP DX
  1545 0000085E 59                      USRET1: POP CX
  1546 0000085F C3                       	RET
  1547 00000860 EB5E                    QWT: 	JMP QWHAT
  1548                                  ;
  1549                                  ;
  1550                                  ; ****DIVIDE**** AND ****CHKSGN****
  1551                                  ; ****CHKSGN**** AND ****CKHLDE****
  1552                                  ;
  1553                                  ;
  1554                                  ; 'DIVIDE DIVIDES BX BY DX, RESULT IN CX, REMAINDER IN BX
  1555                                  ;
  1556                                  ; 'CHKSGN' CHECKS SIGN OF BX. IFF +, NO CHANGE. IFF -, CHANGE
  1557                                  ; SIGN AND FLIP SIGN OF C
  1558                                  ;
  1559                                  ; 'CHGSGN' CHANGES SIGN OF BX AND CL UNCONDITIONALLY.
  1560                                  ;
  1561                                  ; 'CKHLDE' CHECK SIGN OF BX AND DX. IFF DIFFERENT, BX AND DX
  1562                                  ; ARE INTERCHANGED. IFF SAME SIGN, NOT INTERCHANGED.   EITHER
  1563                                  ; CASE, BX AND DX ARE THEN COMPARED TO SET THE FLAGS.
  1564                                  ;
  1565                                  ;
  1566                                  DIVIDE:
  1567 00000862 52                       	PUSH DX ;PRESERVE DX ACCROSS CALL
  1568 00000863 52                       	PUSH DX
  1569 00000864 31D2                     	XOR DX,DX
  1570 00000866 59                       	POP CX
  1571 00000867 89D8                     	MOV AX,BX
  1572                                  ; 	IDIV AX,CX
  1573 00000869 F7F1                     	div cx
  1574 0000086B 89C1                     	MOV CX,AX ;QUOTIENT
  1575 0000086D 89D3                     	MOV BX,DX ;REMAINDER
  1576 0000086F 5A                      	POP DX ;DX RESTORED
  1577 00000870 C3                       	RET
  1578                                   ;
  1579                                  CHKSGN:
  1580 00000871 09DB                     	OR BX,BX ;SET FLAGS TO CHECK SIGN
  1581 00000873 7906                     	JNS RET11 ;IFF -, CHANGE SIGN
  1582                                   ;
  1583                                  CHGSGN:
  1584 00000875 F7D3                     	NOT BX ;****CHGSGN****
  1585 00000877 43                       	INC BX
  1586 00000878 80F580                   	XOR CH,128
  1587                                  RET11:
  1588 0000087B C3                       	RET
  1589                                   ;
  1590                                  CKHLDE:
  1591 0000087C 88F8                     	MOV AL,BH
  1592 0000087E 30F0                     	XOR AL,DH ;SAME SIGN?
  1593 00000880 7902                     	JNS CK1 ;YES, COMPARE
  1594 00000882 87D3                     	XCHG DX,BX
  1595                                  CK1:
  1596 00000884 39D3                     	CMP BX,DX
  1597 00000886 C3                       	RET
  1598                                  ;
  1599                                  ;
  1600                                  ; ****SETVAL**** AND ****FIN**** AND ****ENDCHK****
  1601                                  ; ****ERROR**** AND FRIENDS
  1602                                  ;
  1603                                  ;
  1604                                  ; 'SETVAL' EXPECTS A VARIABLE, FOLLOWED BY AN EQUAL SIGN AND
  1605                                  ; THEN AN EXPR. IT EVALUATES THE EXPR AND SETS THE  VARIABLE
  1606                                  ; TO THAT VALUE.
  1607                                  ;
  1608                                  ; 'FIN' CHECKS THE END OF A COMMAND. IFF IT ENDED WITH ";" ,
  1609                                  ; EXECUTION CONTINUES. IFF IT ENDED WITH A CR, IT FINDS  THE
  1610                                  ; NEXT LINE AND CONTINUES FROM THERE.
  1611                                  ;
  1612                                  ; 'ENDCHK' CHECKS IFF A COMMAND IS ENDED WITH A CR, THIS  IS
  1613                                  ; REQUIRED IN CERTAIN COMMANDS. (GOTO, RETURN, AND STOP,ETC)
  1614                                  ;
  1615                                  ; 'ERROR' PRINTS THE STRING POINTED BY DX (AND ENDS  WITH  A
  1616                                  ; CR). IT THEN PRINTS THE LINE POINTED BY 'CURRNT' WITH A ?.
  1617                                  ; INSERTED AT WHERE THE OLD TEXT POINTER (SHOULD  BE  ON TOP
  1618                                  ; OF THE STACK) POINTS TO. EXECUTION OF TB IS  STOPPED   AND
  1619                                  ; TBI IS RESTARTED. HOWEVER, IFF 'CURRNT' -> ZERO (INDICAT -
  1620                                  ; ING A DIRECT COMMAND), THE DIRECT COMMAND IS NOT PRINTED ,
  1621                                  ; AND IFF 'CURRNT' -> NEGATIVE # (INDICATING 'INPUT' COMMAND
  1622                                  ; THE INPUT LINE IS NOT PRINTED AND EXECUTION IS NOT TERMIN-
  1623                                  ; ATED BUR CONTINUED AT 'INPERR').
  1624                                  ;
  1625                                  ; RELATED TO 'ERROR' ARE THE FOLLOWING:
  1626                                  ;
  1627                                  ; 'QWHAT' SAVES TEXT POINTER IN STACK AND GETS MESSAGE
  1628                                  ;  "WHAT?"
  1629                                  ; 'AWHAT' JUST GETS MESSAGE "WHAT?" AND JUMPS TO ERROR
  1630                                  ;
  1631                                  ; 'QSORRY' AND 'ASORRY' DO THE SAME KIND OF THING.
  1632                                  ;
  1633                                  ; 'QHOW' AND 'AHOW' IN THE ZERO PAGE SECTION ALSO   DO
  1634                                  ;  THIS.
  1635                                  ;
  1636                                  ;
  1637                                  SETVAL:
  1638 00000887 E83AF8                   	CALL TSTV ;SEE IT IT'S A VARIABLE
  1639 0000088A 7234                     	JC QWHAT ;"WHAT" NO VARIABLE
  1640 0000088C 53                       	PUSH BX ;SAVE ADDR OF VARIABLE
  1641 0000088D B43D                     	MOV AH,'='
  1642 0000088F E85102                   	CALL IGNBLNK
  1643 00000892 750C                     	JNZ SV1
  1644 00000894 E8BBFD                   	CALL EXP
  1645 00000897 89D9                     	MOV CX,BX ;VALUE IN CX NOW
  1646 00000899 5B                       	POP BX ;GET ADDR
  1647 0000089A 880F                     	MOV [BX],CL ;SAVE VALUE
  1648 0000089C 43                       	INC BX
  1649 0000089D 882F                     	MOV [BX],CH ;SAVE VALUE
  1650 0000089F C3                       	RET
  1651                                  SV1:
  1652 000008A0 EB1E                     	JMP QWHAT ;NO '=' SIGN
  1653                                   ;
  1654                                  FIN:
  1655 000008A2 B43B                     	MOV AH,';'
  1656 000008A4 E83C02                   	CALL IGNBLNK
  1657 000008A7 7504                     	JNZ FI1
  1658 000008A9 58                       	POP AX
  1659 000008AA E9FDF9                   	JMP RUNSML
  1660                                  FI1:
  1661 000008AD B40D                     	MOV AH,0DH
  1662 000008AF E83102                   	CALL IGNBLNK
  1663 000008B2 7504                     	JNZ FI2
  1664 000008B4 58                       	POP AX
  1665 000008B5 E9DDF9                   	JMP RUNNXL ;RUN NEXT LINE
  1666                                  FI2:
  1667 000008B8 C3                       	RET ;ELSE RETURN TO CALLER
  1668                                   ;
  1669                                  ENDCHK:
  1670 000008B9 B40D                     	MOV AH,0DH ;END WITH CR?
  1671 000008BB E82502                   	CALL IGNBLNK
  1672 000008BE 74F8                     	JZ FI2 ;OK, ELSE SAY "WHAT?"
  1673                                   ;
  1674                                  QWHAT:
  1675 000008C0 52                       	PUSH DX ;****QWHAT****
  1676                                  AWHAT:
  1677 000008C1 BA[3E01]                 	MOV DX,WHAT ;****AWHAT****
  1678                                  ERROR:
  1679 000008C4 28C0                     	SUB AL,AL ;****ERROR****
  1680 000008C6 E8A800                   	CALL PRTSTG ;PRINT 'WHAT?','HOW?'
  1681 000008C9 5A                       	POP DX
  1682 000008CA 89D6                     	MOV SI,DX
  1683 000008CC AC                       	lodsb
  1684 000008CD 50                       	PUSH AX ;SAVE THE CHARACTER
  1685 000008CE 28C0                     	SUB AL,AL ;AND PUT A ZERO THERE
  1686 000008D0 89D7                     	MOV DI,DX
  1687 000008D2 AA                       	stosb
  1688 000008D3 8B1E[FE0A]               	MOV BX,[CURRNT] ;GET CURRENT LINE #
  1689 000008D7 833E[FE0A]00             	CMP word [CURRNT],0 ;DIRECT COMMAND?
  1690 000008DC 7502                     	JNZ ERR1 ;IFF ZERO, JUST RESTART
  1691 000008DE EB1B                     	jmp ERR2 ;SAVE A BYTE
  1692 000008E0 8A07                    ERR1: 	MOV AL,[BX] ;IFF NEGATIVE,
  1693 000008E2 08C0                     	OR AL,AL
  1694 000008E4 7903                     	JNS ERR1A
  1695 000008E6 E9E2FC                   	JMP INPERR ;REDO INPUT
  1696 000008E9 E81601                  ERR1A: 	CALL PRTLN ;ELSE PRINT THE LINE
  1697 000008EC 4A                       	DEC DX
  1698 000008ED 58                       	POP AX
  1699 000008EE 89D7                     	MOV DI,DX
  1700 000008F0 AA                       	stosb ;RESTORE THE CHAR
  1701 000008F1 B03F                     	MOV AL,63 ;PRINT A '?'
  1702 000008F3 E89201                   	CALL CHROUT
  1703 000008F6 28C0                     	SUB AL,AL ;AND THE REST OF THE
  1704 000008F8 E87600                   	CALL PRTSTG ;LINE
  1705 000008FB E93FF7                  ERR2: 	JMP RSTART
  1706                                  QSORRY:
  1707 000008FE 52                       	PUSH DX ;****QSORRY****
  1708                                  ASORRY:
  1709 000008FF BA[4401]                 	MOV DX,SORRY ;****ASORRY****
  1710 00000902 EBC0                     	jmp ERROR
  1711                                  ;
  1712                                  ;
  1713                                  ; ****GETLN**** AND ****FNDLN****
  1714                                  ;
  1715                                  ;
  1716                                  ; 'GETLN' READS AN INPUT LINE INTO 'BUFFER'. IT FIRST PROMPTS
  1717                                  ; THE CHARACTER IN A (GIVEN BY THE CALLER), THEN IT FILLS THE
  1718                                  ; BUFFER AND ECHOS IT. IT USES BDOS PRIMITIVES TO  ACCOMPLISH
  1719                                  ; THIS. ONCE A FULL LINE IS READ IN, 'GETLN' RETURNS.
  1720                                  ;
  1721                                  ; 'FNDLN' FINDS A LINE WITH A GIVEN LINE #(IN BX) IN THE TEXT
  1722                                  ; SAVE AREA. DX IS USED AS THE TEXT POINTER. IFF THE LINE  IS
  1723                                  ; FOUND, DX WILL POINT TO THE BEGINNING OF THAT LINE IFF THAT
  1724                                  ; LINE (I.E. THE LOW BYTE OF THE LINE #), AND FLAGS ARE NC&Z.
  1725                                  ; IFF THAT LINE IS NOT THERE AND A LINE WITH A HIGHER LINE  #
  1726                                  ; IS FOUND, DX POINTS TO THERE AND FLAGS ARE NC&NZ.  IFF   WE
  1727                                  ; REACHED THE END OF TEXT SAVE AREA AND CANNOT FIND THE LINE,
  1728                                  ; FLAGS ARE C&NZ.
  1729                                  ; 'FNDLN' WILL INITIALIZE DX TO THE  BEGINNING  OF  THE  TEXT
  1730                                  ; SAVE AREA TO START THE SEARCH. SOME OTHER ENTRIES  OF  THIS
  1731                                  ; ROUTINE WILL NOT INITIALIZE DX AND DO THE SEARCH.
  1732                                  ;
  1733                                  ; 'FNDLNP' WILL START WITH DX AND SEARCH FOR THE LINE #.
  1734                                  ;
  1735                                  ; 'FNDNXT' WILL BUMP DX BY  2, FIND A 0DH AND THEN START  THE
  1736                                  ; SEARCH.
  1737                                  ; 'FNDSKP' USES DX TO FIND A CR, AND THEN STARTS THE SEARCH.
  1738                                  ;
  1739                                  ;
  1740                                  ;
  1741                                  GETLN:
  1742 00000904 E88101                   	CALL 	CHROUT 		;****GETLN****
  1743                                  GL1:
  1744 00000907 BA[3620]                 	MOV 	DX,BUFMAX	; TB needs address of buffer-2 in DX
  1745 0000090A 52                       	PUSH 	DX
  1746 0000090B 51                       	push	cx		; cx saved by DOS
  1747 0000090C 50                      	push	ax
  1748 0000090D 57                      	push	di
  1749                                  
  1750 0000090E BA[3820]                 	mov	dx,BUFFER	; getline requires *buffer
  1751 00000911 8A0E[3620]               	mov     cl,[BUFMAX]	; setup to call wlib_getline
  1752 00000915 30ED                    	xor     ch,ch
  1753 00000917 B48A                    	mov     ah,8ah		; al is unchanged
  1754 00000919 CD15                    	int     15h
  1755                                  
  1756                                  %if	SOFT_DEBUG
  1757 0000091B CD00                    	int	0
  1758                                  %endif
  1759                                  	; cl still equals BUFMAX
  1760 0000091D BF[3820]                	mov	di,BUFFER	; move pointer head to di
  1761 00000920 31C0                    	xor	ax,ax		; look for NULL
  1762 00000922 FC                      	cld
  1763 00000923 F2AE                    	repnz	scasb		; go find it. di++ cx--
  1764 00000925 A0[3620]                	mov	al,[BUFMAX]
  1765 00000928 28C8                    	sub	al,cl		; subtract to get actual length
  1766 0000092A FEC8                    	dec	al		; don't count CR
  1767 0000092C C645FF0D                	mov	byte [di-1],CR	; terminate string with CR instead
  1768 00000930 A2[3720]                	mov	byte [BUFCNT],al	; save actual count
  1769                                  
  1770 00000933 5F                      	pop	di
  1771 00000934 58                      	pop	ax
  1772 00000935 59                      	pop	cx
  1773                                  	
  1774                                  %if	SOFT_DEBUG
  1775 00000936 CD00                    	int	0
  1776                                  %endif
  1777                                  
  1778                                  ; end of inserted code
  1779 00000938 5A                       	POP 	DX
  1780 00000939 0216[3720]              	ADD 	DL,[BUFCNT]
  1781 0000093D 42                       	INC 	DX
  1782 0000093E 42                       	INC 	DX
  1783 0000093F 42                       	INC 	DX
  1784 00000940 89D7                     	MOV 	DI,DX 		;FOR CONSISTANCY
  1785 00000942 52                       	PUSH 	DX
  1786 00000943 E84001                   	CALL 	CRLF 		;NEED CRLF
  1787 00000946 5A                       	POP 	DX
  1788 00000947 C3                       	RET 			;WE'VE GOT A LINE
  1789                                  ;		
  1790                                  ; AT ENTRY BX -> LINE # TO BE FOUND
  1791                                  ;
  1792                                  FNDLN:
  1793 00000948 09DB                     	OR BX,BX ;CHECK SIGN OF BX
  1794 0000094A 7903                     	JNS FND1 ;IT CAN'T BE -
  1795 0000094C E9E0F7                   	JMP QHOW ;ERROR
  1796 0000094F BA[140B]                FND1: 	MOV DX,TXTBGN
  1797                                   ;
  1798                                  FNDLNP:
  1799                                  FL1:
  1800 00000952 53                       	PUSH 	BX 		;SAVE LINE #
  1801 00000953 8B1E[120B]               	MOV 	BX,[TXTUNF] 	;CHECK IFF WE PASSED END
  1802 00000957 4B                       	DEC 	BX
  1803 00000958 39D3                     	CMP 	BX,DX 		;SUBSTITUTE FOR CALL 4
  1804 0000095A 5B                       	POP 	BX 		;GET LINE # BACK
  1805 0000095B 7207                     	JC 	RET13 		;C, NZ PASSED END
  1806 0000095D 89D6                     	MOV 	SI,DX
  1807 0000095F AD                       	lodsw
  1808 00000960 39D8                     	CMP 	AX,BX
  1809 00000962 7202                     	JC 	FL2
  1810                                  RET13:
  1811 00000964 C3                       	RET 			;NC,Z:FOUND;NC,NZ:NOT FOUND
  1812                                   ;
  1813                                  FNDNXT:                 ;****FNDNXT****
  1814 00000965 42                       	INC DX
  1815                                  FL2:
  1816 00000966 42                       	INC DX
  1817                                   ;
  1818                                  FNDSKP:
  1819 00000967 89D6                     	MOV SI,DX
  1820 00000969 AC                       	lodsb ;****FNDSKP****
  1821 0000096A 3C0D                     	CMP AL,0DH ;TRY TO FIND CR
  1822 0000096C 75F8                     	JNZ FL2 ;KEEP LOOKING
  1823 0000096E 42                       	INC DX
  1824 0000096F EBE1                     	jmp FL1 ;CHECK IFF END OF TEXT
  1825                                  ;
  1826                                  ;
  1827                                  ; **** PRTSTG **** QTSTG **** PRTNUM **** PRTLN ****
  1828                                  ;
  1829                                  ;
  1830                                  ; 'PRTSTG PRINTS A STRING POINTED TO BY DX. IT STOPS PRINTING
  1831                                  ; AND RETURNS TO CALLER WHEN EITHER A 0DH IS PRINTED OR  WHEN
  1832                                  ; THE NEXT BYTE IS THE SAMES AS WHAT WAS IN A  ( GIVEN BY THE
  1833                                  ; CALLER). OLD AL IS STORED IN CH, OLD CH IS LOST.
  1834                                  ;
  1835                                  ; 'QTSTG' LOOKS FOR A BACK-SLASH,  SINGLE QUOTE,   OR  DOUBLE
  1836                                  ; QUOTE. IFF NONE OF THESE, RETURN TO CALLER. IF BACK SLASH ; OUTPUT A ODH WITHOUT A LF. IFF SINGLE OR DOUBLE QUOTE,PRINT
  1838                                  ; THE STRING IN THE QUOTE AND DEMANDS A MATCHING UNQUOTE. AF-
  1839                                  ; TER THE PRINTING THE NEXT 3 BYTES OF THE CALLER  IS SKIPPED
  1840                                  ; OVER (USUALLY A JMP INSTRUCTION).
  1841                                  ;
  1842                                  ; 'PRTNUM' PRINTS THE NUMBER IN HL. LEADING BLANKS  ARE ADDED
  1843                                  ; IFF NEEDED TO PAD THE NUMBER OF SPACES TO THE NUMBER IN  C.
  1844                                  ; NOWEVER, IFF THE NUMBER OF DIGITS IS LARGER THAN THE NUMBER
  1845                                  ; IN C, ALL DIGITS ARE PRINTED ANYWAY. NEGATIVE SIGN IS  ALSO
  1846                                  ; PRINTED AND COUNTED IN, POSITIVE SIGN IS NOT.
  1847                                  ;
  1848                                  ; 'PRTLN' PRINTS A SAVED TEXT LINE WITH LINE # AND ALL.
  1849                                  ;
  1850                                  ;
  1851                                  ;
  1852                                  PRTSTG:
  1853 00000971 88C5                     	MOV 	CH,AL 	;****PRTSTG****
  1854                                  PS1:
  1855 00000973 89D6                     	MOV 	SI,DX
  1856 00000975 AC                       	lodsb 		;GET A CHAR
  1857                                  ;;; 	LAHF            ;PRESERVE FLAGS		
  1858 00000976 42                       	INC 	DX
  1859                                  ;;; 	SAHF         	;RESTORE FLAGS
  1860 00000977 38E8                     	CMP 	AL,CH 	;SAME AS OLD A?
  1861 00000979 7501                     	JNZ 	PS2 	;YES, RETURN
  1862 0000097B C3                              RET
  1863 0000097C E80901                  PS2: 	CALL 	CHROUT 	;ELSE, PRINT IT
  1864 0000097F 3C0D                     	CMP 	AL,0DH 	;WAS IT A CR?
  1865 00000981 75F0                     	JNZ 	PS1 	;NO, NEXT
  1866 00000983 C3                       	RET
  1867                                   ;
  1868                                  QTSTG:
  1869 00000984 B422                     	MOV 	AH,'"'
  1870 00000986 E85A01                   	CALL 	IGNBLNK
  1871 00000989 7511                     	JNZ 	QT3
  1872 0000098B B022                     	MOV 	AL,34 	;IT IS A '"'
  1873                                  QT1:
  1874 0000098D E8E1FF                   	CALL 	PRTSTG 	;PRINT UNTIL ANOTHER
  1875 00000990 3C0D                     	CMP 	AL,0DH 	;WAS LAST ONE A CR?
  1876 00000992 5B                       	POP 	BX 	;RETURN ADDRESS
  1877 00000993 7503                     	JNZ 	QT2 	;WAS CR, RUN NEXT LINE
  1878 00000995 E9FDF8                          JMP     RUNNXL
  1879                                  QT2:
  1880 00000998 43                       	INC 	BX 	;SKIPS TWO BYTES ON RETURN!!!!
  1881 00000999 43                       	INC 	BX
  1882 0000099A FFE3                     	JMP 	BX 	;JUMP TO ADDRESS IN BX
  1883                                  QT3:
  1884 0000099C B427                     	MOV 	AH,39 	;IS IT A SINGLE QUOTE (')?
  1885 0000099E E84201                   	CALL 	IGNBLNK
  1886 000009A1 7504                     	JNZ 	QT4
  1887 000009A3 B027                     	MOV 	AL,39 	;YES, DO SAME
  1888 000009A5 EBE6                     	jmp 	QT1 	;AS IN ' " '
  1889                                  QT4:
  1890 000009A7 B45C                     	MOV 	AH,'\'
  1891 000009A9 E83701                   	CALL 	IGNBLNK ;IS IT BACK-SLASH?('\')
  1892 000009AC 750B                     	JNZ 	QT5
  1893 000009AE B08D                     	MOV 	AL,141 	;YES, 0DH WITHOUT LF!
  1894 000009B0 E8D500                   	CALL 	CHROUT 	;DO IT TWICE
  1895 000009B3 E8D200                   	CALL 	CHROUT 	;TO GIVE TTY ENOUGH TIME
  1896 000009B6 5B                       	POP 	BX 	;RETURN ADDRESS
  1897 000009B7 EBDF                     	jmp 	QT2
  1898                                  QT5:
  1899 000009B9 C3                       	RET  	;NONE OF THE ABOVE
  1900                                  ;
  1901                                  ; ON ENTRY BX = BINARY #,CL = # SPACES
  1902                                  ;
  1903                                  PRTNUM:
  1904 000009BA 52                       	PUSH DX ;****PRTNUM****
  1905 000009BB BA0A00                   	MOV DX,10 ;DECIMAL
  1906 000009BE 52                       	PUSH DX ;SAVE AS A FLAG
  1907 000009BF 88F5                     	MOV CH,DH ;CH=SIGN
  1908 000009C1 FEC9                     	DEC CL ;CL=SPACES
  1909 000009C3 E8ABFE                   	CALL CHKSGN ;CHECK SIGN
  1910 000009C6 7904                     	JNS PN1 ;NO SIGN
  1911 000009C8 B52D                     	MOV CH,45 ;CH=SIGN
  1912 000009CA FEC9                     	DEC CL ;'-' TAKES SPACE
  1913                                  PN1:
  1914 000009CC 51                       	PUSH CX ;SAVE SIGN % SPACE
  1915                                  PN2:
  1916 000009CD E892FE                   	CALL DIVIDE ;DIVIDE BX BY 10 (IN DX)
  1917 000009D0 09C9                     	OR CX,CX ;CX HAS QUOTIENT
  1918 000009D2 7409                     	JZ PN3 ;YES, WE GOT ALL
  1919 000009D4 58                       	POP AX ;GET SIGN AND SPACE COUNT
  1920 000009D5 53                       	PUSH BX ;SAVE REMAINDER
  1921 000009D6 FEC8                     	DEC AL ;DEC SPACE COUNT
  1922 000009D8 50                       	PUSH AX ;SAVE NEW SIGN AND SPACE COUNT
  1923 000009D9 89CB                     	MOV BX,CX ;MOVE RESULT TO BX
  1924 000009DB EBF0                     	jmp PN2 ;AND DIVIDE BY 10
  1925                                  PN3:
  1926 000009DD 59                       	POP CX ;WE GOT ALL DIGITS IN
  1927                                  PN4:
  1928 000009DE FEC9                     	DEC CL ;THE STACK
  1929 000009E0 88C8                     	MOV AL,CL ;LOOK AT SPACE COUNT
  1930 000009E2 08C0                     	OR AL,AL
  1931 000009E4 7807                     	JS PN5 ;NO LEADING BLANKS
  1932 000009E6 B020                     	MOV AL,32 ;LEADING BLANKS
  1933 000009E8 E89D00                   	CALL CHROUT
  1934 000009EB EBF1                     	jmp PN4
  1935                                  PN5:
  1936 000009ED 88E8                     	MOV AL,CH ;PRINT SIGN
  1937 000009EF E89600                   	CALL CHROUT ;MAYBE, OR NULL
  1938 000009F2 88DA                     	MOV DL,BL ;LAST REMAINDER IN E
  1939                                  PN6:
  1940 000009F4 88D0                     MOV AL,DL ;CHECK DIGIT IN E
  1941 000009F6 3C0A                     	CMP AL,10 ;10 IS FLAG FOR NO MORE
  1942 000009F8 5A                       	POP DX
  1943 000009F9 741D                     	JZ RET14 ;IFF SO, RETURN
  1944 000009FB 0430                     	ADD AL,48 ;ELSE CONVERT TO ASCII
  1945 000009FD E88800                   	CALL CHROUT ;AND PRINT THE DIGIT
  1946 00000A00 EBF2                     	jmp PN6 ;GO BACK FOR MORE
  1947                                   ;
  1948                                  PRTLN:
  1949 00000A02 89D6                     	MOV SI,DX
  1950 00000A04 AD                       	lodsw
  1951 00000A05 89C3                     	MOV BX,AX
  1952 00000A07 42                       	INC DX
  1953 00000A08 42                       	INC DX ;MOVE POINTER
  1954 00000A09 B105                    PRTLN1: MOV CL,5 ;PRINT 5 DIGIT LINE #
  1955 00000A0B E8ACFF                   	CALL PRTNUM
  1956 00000A0E B020                     	MOV AL,32 ;FOLLOWED BY A BLANK
  1957 00000A10 E87500                   	CALL CHROUT
  1958 00000A13 28C0                     	SUB AL,AL ;AND THEN THE TEXT
  1959 00000A15 E859FF                   	CALL PRTSTG
  1960                                  RET14:
  1961 00000A18 C3                       	RET
  1962                                  ;
  1963                                  ;
  1964                                  ;
  1965                                  ; **** MVUP **** MVDOWN **** POPA **** PUSHA ****
  1966                                  ;
  1967                                  ; 'MVUP' MOVES A BLOCK UP FROM WHERE DX -> WHERE CX -> UNTIL
  1968                                  ; DX = BX
  1969                                  ;
  1970                                  ; 'MVDOWN' MOVES A BLOCK DOWN FROM WHERE DX -> TO WHERE BX->
  1971                                  ; UNTIL DX = CX.
  1972                                  ;
  1973                                  ; 'POPA' RESTORES THE 'FOR' LOOP VAR SAVE AREA FROM THE STACK.
  1974                                  ;
  1975                                  ; 'PUSHA' STACKS THE 'FOR' LOOP VARIABLE SAVE AREA IN THE STACK
  1976                                  ;
  1977                                  ;
  1978                                  MVUP:
  1979 00000A19 39DA                     	CMP DX,BX ;***MVUP***
  1980 00000A1B 7437                     	JZ RET15 ;DE = HL, RETURN
  1981 00000A1D 89D6                     	MOV SI,DX
  1982 00000A1F AC                       	lodsb ;GET ONE BYTE
  1983 00000A20 89CF                     	MOV DI,CX
  1984 00000A22 AA                       	stosb ;MOVE IT
  1985 00000A23 42                       	INC DX
  1986 00000A24 41                       	INC CX
  1987 00000A25 EBF2                     	jmp MVUP ;UNTIL DONE
  1988                                   ;
  1989                                  MVDOWN:
  1990 00000A27 39CA                     	CMP DX,CX
  1991 00000A29 7429                     	JZ RET15 ;YES, RETURN
  1992                                  MD1:
  1993 00000A2B 9F                       	LAHF
  1994 00000A2C 4A                       	DEC DX
  1995 00000A2D 4B                       	DEC BX
  1996 00000A2E 89D6                     	MOV SI,DX
  1997 00000A30 AC                       	lodsb ;BOTH POINTERS AND
  1998 00000A31 8807                     	MOV [BX],AL ;THEN DO IT
  1999 00000A33 EBF2                     	jmp MVDOWN ;LOOP BACK
  2000                                   ;
  2001                                  _popa:
  2002 00000A35 59                       	POP CX ;CX = RETURN ADDR
  2003 00000A36 5B                       	POP BX ;RESTORE LOPVAR, BUT
  2004 00000A37 891E[060B]               	MOV [LOPVAR],BX ;=0 MEANS NO MORE
  2005 00000A3B 09DB                     	OR BX,BX
  2006 00000A3D 7414                     	JZ PP1 ;YES, GO RETURN
  2007 00000A3F 5B                       	POP BX ;NO, RESTORE OTHERS
  2008 00000A40 891E[080B]               	MOV [LOPINC],BX
  2009 00000A44 5B                       	POP BX
  2010 00000A45 891E[0A0B]               	MOV [LOPLMT],BX
  2011 00000A49 5B                       	POP BX
  2012 00000A4A 891E[0C0B]               	MOV [LOPLN],BX
  2013 00000A4E 5B                       	POP BX
  2014 00000A4F 891E[0E0B]               	MOV [LOPPT],BX
  2015                                  PP1:
  2016 00000A53 51                       	PUSH CX ;CX = RETURN ADDR
  2017                                  RET15:
  2018 00000A54 C3                       	RET
  2019                                   ;
  2020                                  _pusha:
  2021 00000A55 BB[1822]                 	MOV BX,STKLMT ;****PUSHA****
  2022 00000A58 E81AFE                   	CALL CHGSGN
  2023 00000A5B 59                       	POP CX ;CX=RET ADDR
  2024 00000A5C 01E3                     	ADD BX,SP
  2025 00000A5E 7203                     	JC PUSHB ;YES, SORRY FOR THAT.
  2026 00000A60 E99BFE                          JMP     QSORRY
  2027 00000A63 8B1E[060B]              PUSHB: 	MOV BX,[LOPVAR] ;ELSE SAVE LOOP VARS
  2028 00000A67 09DB                     	OR BX,BX ;THAT WILL BE ALL
  2029 00000A69 7418                     	JZ PU1
  2030 00000A6B 8B1E[0E0B]               	MOV BX,[LOPPT] ;ELSE, MORE TO SAVE
  2031 00000A6F 53                       	PUSH BX
  2032 00000A70 8B1E[0C0B]              	MOV BX,[LOPLN] ;ELSE, MORE TO SAVE
  2033 00000A74 53                       	PUSH BX
  2034 00000A75 8B1E[0A0B]               	MOV BX,[LOPLMT]
  2035 00000A79 53                       	PUSH BX
  2036 00000A7A 8B1E[080B]               	MOV BX,[LOPINC]
  2037 00000A7E 53                       	PUSH BX
  2038 00000A7F 8B1E[060B]               	MOV BX,[LOPVAR]
  2039                                  PU1:
  2040 00000A83 53                       	PUSH BX
  2041 00000A84 51                       	PUSH CX ;CX = RETURN ADDR
  2042 00000A85 C3                       	RET
  2043                                   ;
  2044                                   ;
  2045                                   ; **** OUTC **** CHKIO ****
  2046                                   ;
  2047                                   ;
  2048                                   ; THESE ARE THE ONLY I/O ROUTINES IN TBI.
  2049                                   ;
  2050                                   ;
  2051                                   ; 'CHKIO' CHECKS THE INPUT, IFF NO INPUT, IT WILL RETURN TO  THE
  2052                                   ; CALLER WITH THE Z FLAG SET. IFF THERE IS INPUT, THE Z FLAG  IS
  2053                                   ; CLEARED AND THE INPUT BYRE IS IN A. HOWEVER, IFF THE INPUT  IS
  2054                                   ; A CONTROL-O, THE 'OCSW' IS COMPLIMENTED, AND THE Z FLAG IS RE-
  2055                                   ; TURNED. IFF A CONTROL-C IS READ, 'CHKIO' WILL RESTART TBI  AND
  2056                                   ; DOES NOT RETURN TO THE CALLER.
  2057                                   ;
  2058 00000A86 B00D                    CRLF: 	MOV 	AL,0DH ;****CRLF****
  2059                                  CHROUT:
  2060 00000A88 803E[FD0A]00             	CMP 	byte [OCSW],0
  2061 00000A8D 7421                     	JZ 	COUT1 		;SEE IF OUTPUT REDIRECTED
  2062 00000A8F 51                       	PUSH 	CX 		;SAVE CX ON STACK
  2063 00000A90 52                       	PUSH 	DX 		;AND DX
  2064 00000A91 53                       	PUSH 	BX 		;AND BX TOO
  2065 00000A92 A2[FC0A]                	MOV 	[OUTCAR],AL 	;SAVE CHATACTER
  2066                                  
  2067                                  ; 	MOV 	DL,AL 		;PUT CHAR IN E FOR CP/M
  2068                                  ;	MOV 	AH,CONOUT 	;CONSOLE OUTPUT
  2069                                  ;	INT 	21h 		;CALL MS-DOS AND OUTPUT CHAR
  2070 00000A95 B40E                    	mov	ah,0eh		; write character to page 0, attribute 7
  2071 00000A97 BB0700                  	mov	bx,7
  2072 00000A9A CD10                    	int	10h
  2073                                  	
  2074 00000A9C A0[FC0A]                 	MOV 	AL,[OUTCAR] 	;GET CHAR. BACK
  2075 00000A9F 3C0D                     	CMP 	AL,0DH 		;WAS IT A 'CR'?
  2076 00000AA1 7506                     	JNZ 	DONE 		;NO,DONE
  2077                                  
  2078 00000AA3 B00A                     	MOV 	al,0AH 		;GET LINEFEED
  2079                                  ; 	MOV 	AH,CONOUT 	;CONSOLE OUTPUT AGAIN
  2080                                  ; 	INT 	21h 		;CALL MS-DOS
  2081 00000AA5 B40E                    	mov	ah,0eh		; write character to page 7
  2082 00000AA7 CD10                    	int	10h
  2083                                  
  2084                                  DONE:
  2085 00000AA9 A0[FC0A]                 	MOV 	AL,[OUTCAR] 	;GET CHAR BACK
  2086                                  IDONE:	
  2087 00000AAC 5B                       	POP 	BX 		;GET H BACK
  2088 00000AAD 5A                       	POP 	DX 		;AND D
  2089 00000AAE 59                       	POP 	CX 		;THEN H
  2090 00000AAF C3                       	RET 			;DONE AT LAST
  2091                                  COUT1:
  2092 00000AB0 3C00                     	CMP 	byte AL,0 	;IS IT NULL?
  2093 00000AB2 7405                     	JZ	RET16 		;SKIP IT
  2094 00000AB4 AA                       	stosb  			;STORE AL (CHAR) IN BUFFER
  2095 00000AB5 FE06[3720]               	INC 	byte [BUFCNT] 	;INCREMENT COUNTER
  2096                                  RET16:
  2097 00000AB9 C3                       	RET  			;DONE
  2098                                  CHKIO:
  2099 00000ABA 51                       	PUSH 	CX 		;SAVE B ON STACK
  2100 00000ABB 52                       	PUSH 	DX 		;AND D
  2101 00000ABC 53                       	PUSH 	BX 		;THEN H
  2102                                  ; 	MOV 	AH,CONSTAT 	;GET CONSOLE STATUS WORD
  2103                                  ;	INT 	21h 		;CALL MS-DOS
  2104 00000ABD B401                    	mov	ah,1
  2105 00000ABF CD16                    	int	16h
  2106                                  
  2107                                  ;jrc 	OR 	AL,AL 		;SET FLAGS  ; BIOS sets ZF; MSDOS sets AL
  2108 00000AC1 7502                     	JNZ 	CI1 		;IF READY, GET CHAR
  2109 00000AC3 EBE7                     	jmp 	IDONE 		;RESTORE AND RETURN
  2110                                  CI1:
  2111                                  ; 	MOV 	AH,1 		;CALL THE BDOS
  2112                                  ; 	INT 	21h 		;CALL MS-DOS
  2113 00000AC5 B400                    	mov	ah,0
  2114 00000AC7 CD16                    	int	16h
  2115                                  
  2116                                  CI2:
  2117 00000AC9 3C18                     	CMP 	AL,18H 		;IS TI CONTROL-X?
  2118 00000ACB 75DF                    	JNZ 	IDONE 		;RETURN AND RESTORE IF NOT
  2119 00000ACD E96DF5                   	JMP 	RSTART 		;YES, RESTART TBI
  2120                                  LSTROM: EQU $ 			;ALL ABOVE CAN BE ROM
  2121                                  ;
  2122                                  ; Below should be in RAM; I don't know why the I/O and blanks
  2123                                  ; routines must be in RAM.
  2124                                  ;
  2125                                  OUTIO:
  2126 00000AD0 E6FF                     	OUT 0FFH,al
  2127 00000AD2 C3                       	RET
  2128                                  WAITIO:
  2129 00000AD3 E4FF                     	in al, 0FFH
  2130 00000AD5 30F8                     	XOR AL,BH
  2131 00000AD7 20D8                     	AND AL,BL
  2132 00000AD9 74F8                     	JZ WAITIO
  2133 00000ADB E81700                   	CALL FINISH
  2134                                  INPIO:
  2135 00000ADE E4FF                     	in al, 0FFH
  2136 00000AE0 88C3                     	MOV BL,AL
  2137 00000AE2 C3                       	RET
  2138                                  ;
  2139                                  ;
  2140                                  ; IGNBLNK
  2141                                  ;
  2142                                  ; DEBLANKS WHERE DX->
  2143                                  ; IF (DX)=AH THEN DX:=DX+1
  2144                                  ;
  2145 00000AE3 89D6                    IGNBLNK:MOV SI,DX
  2146 00000AE5 AC                      IGN1:   lodsb           ;GET CHAR IN AL
  2147 00000AE6 3C20                     	CMP AL,32 	;IGNORE BLANKS
  2148 00000AE8 7503                     	JNZ IGN2 	;IN TEXT (WHERE DX ->)
  2149 00000AEA 42                              INC DX
  2150 00000AEB EBF8                            jmp IGN1
  2151 00000AED 38E0                    IGN2: 	CMP AL,AH 	;IS SEARCH CHARACTER FOUND AT (DX)?
  2152 00000AEF 7503                     	JNZ _RET 	;NO, RETURN, POINTER (DX) STAYS
  2153 00000AF1 9F                       	LAHF  		;SAVE RESULTS OF COMPARISON
  2154 00000AF2 42                       	INC DX 		;INC POINTER IF CHARACTER MATCHES
  2155 00000AF3 9E                       	SAHF  		;RETURN RESULT OF COMPARISON TO FLAGS
  2156                                  _RET:
  2157 00000AF4 C3                      	RET
  2158                                  
  2159 00000AF5 58                      FINISH: POP AX
  2160 00000AF6 E8A9FD                   	CALL FIN 	;CHECK END OF COMMAND
  2161 00000AF9 E9C4FD                   	JMP QWHAT 	;PRINT "WHAT?" IFF WRONG
  2162                                  ;
  2163                                  ; This is probably the real end of ROM code.
  2164                                  ;
  2165                                  ;===============================================================
  2166                                  ;
  2167                                  ; Initialized data
  2168                                  ;
  2169                                  OUTCAR:
  2170 00000AFC 00                       	DB 0 		;OUTPUT CHAR STORAGE
  2171                                  OCSW:
  2172 00000AFD FF                       	DB 0FFH 	;OUTPUT SWITCH
  2173                                  CURRNT:
  2174 00000AFE 0000                     	DW 0 		;POINTS TO CURRENT LINE
  2175                                  STKGOS:
  2176 00000B00 0000                     	DW 0 		;SAVES SP IN 'GOSUB'
  2177                                  VARNXT:
  2178 00000B02 0000                     	DW 0 		;TEMP STORAGE
  2179                                  STKINP:
  2180 00000B04 0000                     	DW 0 		;SAVES SP IN 'INPUT'
  2181                                  LOPVAR:
  2182 00000B06 0000                     	DW 0 		;'FOR' LOOP SAVE AREA
  2183                                  LOPINC:
  2184 00000B08 0000                     	DW 0 		;INCREMENT
  2185                                  LOPLMT:
  2186 00000B0A 0000                     	DW 0 		;LIMIT
  2187                                  LOPLN:
  2188 00000B0C 0000                     	DW 0 		;LINE NUMBER
  2189                                  LOPPT:
  2190 00000B0E 0000                     	DW 0 		;TEST POINTER
  2191                                  RANPNT:
  2192 00000B10 0000                     	DW 0 		;RANDOM NUMBER POINTER
  2193                                  TXTUNF:
  2194 00000B12 [140B]                   	DW TXTBGN 	;-> UNFILLED TEXT AREA
  2195                                  
  2196 00000B14 00                      TXTBGN: db 0
  2197                                  
  2198 00000B15 00<rep 14EBh>           	times 2000h - ($-$$) db 0
  2199                                  TXTEND: EQU $ 		;TEXT AREA SAVE AREA ENDS
  2200                                  VARBGN:
  2201 00002000 00<rep 36h>              	times 54 db 0   ;VARIABLE @(0)
  2202                                  BUFMAX:
  2203 00002036 50                       	DB 80 		;MAX CHARS IN BUFFER
  2204                                  BUFCNT:
  2205 00002037 00                       	DB 0 		;CHAR COUNT
  2206                                  BUFFER:
  2207 00002038 00<rep 50h>              	times 80 db 0   ;BUFFER MUST BE AFTER TEXT AREA
  2208                                  BUFEND: EQU $
  2209 00002088 00<rep 190h>             	times 400 db 0  ;EXTRA BYTES FOR STACK
  2210                                  ;;STKLMT: times 100 db 0  ;TOP LIMIT FOR STACK
  2211 00002218 00<rep 1E7h>            STKLMT: times 487 db 0  ;TOP LIMIT FOR STACK
  2212 000023FF 00                      	db	0
  2213                                  STACK: 	EQU $ 		;STACK STARTS HERE
  2214                                  
  2215                                  ;L_DATA:	EQU $-T_DATA	; length of initialized data
  2216                                  end_cbasic:
  2217                                  ; should end at 227ch  now 2400h
